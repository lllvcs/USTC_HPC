
<!DOCTYPE html>

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="_static/javascripts/modernizr.js"></script>
  
  
  
    <title>简介 &#8212; Ubuntu 22.04下的LDAP认证服务及客户端设置 2022-09 文档</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/material.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/translations.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="prev" title="Ubuntu 22.04下的LDAP认证服务及客户端设置" href="index.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=#4000FF data-md-color-accent=light-blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#ubuntu-ldap" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="index.html" title="Ubuntu 22.04下的LDAP认证服务及客户端设置 2022-09 文档"
           class="md-header-nav__button md-logo">
          
              <img src="_static/logo.png" height="26"
                   alt="Ubuntu 22.04下的LDAP认证服务及客户端设置 2022-09 文档 logo">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Ubuntu 22.04下的LDAP认证服务及客户端设置</span>
          <span class="md-header-nav__topic"> 简介 </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://git.ustc.edu.cn/hmli/ubuntu-ldap" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Ubuntu 22.04下的LDAP认证服务及客户端设置git
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = ""versions.json"",
        target_loc = "../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">Ubuntu 22.04下的LDAP认证服务及客户端设置 2022-09 文档</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="index.html" title="Ubuntu 22.04下的LDAP认证服务及客户端设置 2022-09 文档" class="md-nav__button md-logo">
      
        <img src="_static/logo.png" alt=" logo" width="48" height="48">
      
    </a>
    <a href="index.html"
       title="Ubuntu 22.04下的LDAP认证服务及客户端设置 2022-09 文档">Ubuntu 22.04下的LDAP认证服务及客户端设置</a>
  </label>
    <div class="md-nav__source">
      <a href="https://git.ustc.edu.cn/hmli/ubuntu-ldap" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Ubuntu 22.04下的LDAP认证服务及客户端设置git
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">目录</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    <label class="md-nav__link md-nav__link--active" for="__toc"> 简介 </label>
    
      <a href="#" class="md-nav__link md-nav__link--active">简介</a>
      
        
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#ubuntu-ldap--page-root" class="md-nav__link">简介</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id2" class="md-nav__link">基本概念</a>
        </li>
        <li class="md-nav__item"><a href="#id3" class="md-nav__link">常用关键字列表</a>
        </li>
        <li class="md-nav__item"><a href="#ldif-ldap-data-interchange-format" class="md-nav__link">LDIF(LDAP Data Interchange Format)格式</a>
        </li>
        <li class="md-nav__item"><a href="#id4" class="md-nav__link">节点分类</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id5" class="md-nav__link">服务端设置</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#tls" class="md-nav__link">生成TLS加密证书</a>
        </li>
        <li class="md-nav__item"><a href="#ldap" class="md-nav__link">安装所需LDAP包</a>
        </li>
        <li class="md-nav__item"><a href="#dif" class="md-nav__link">默认DIF</a>
        </li>
        <li class="md-nav__item"><a href="#id7" class="md-nav__link">填充目录</a>
        </li>
        <li class="md-nav__item"><a href="#id8" class="md-nav__link">修改配置</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id9" class="md-nav__link">增加索引</a>
        </li>
        <li class="md-nav__item"><a href="#rootdn" class="md-nav__link">修改 <em>rootDN</em> 密码</a>
        </li>
        <li class="md-nav__item"><a href="#id10" class="md-nav__link">增加模式</a>
        </li>
        <li class="md-nav__item"><a href="#id11" class="md-nav__link">记录日志</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id12" class="md-nav__link">访问控制</a>
        </li>
        <li class="md-nav__item"><a href="#ldap-readonly" class="md-nav__link">生成客户端等获取用户信息的LDAP账户 <em>readonly</em></a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id13" class="md-nav__link">生成LDAP账户 <em>readonly</em></a>
        </li>
        <li class="md-nav__item"><a href="#readonly-acl" class="md-nav__link">设置账户 <em>readonly</em> ACL只读权限</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id14" class="md-nav__link">启用TLS认证</a>
        </li>
        <li class="md-nav__item"><a href="#openldap" class="md-nav__link">高可用性设置：OpenLDAP复制（可选）</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id15" class="md-nav__link">为副本节点生成证书</a>
        </li>
        <li class="md-nav__item"><a href="#id16" class="md-nav__link">提供者配置 - 设置用于复制LDAP信息的用户</a>
        </li>
        <li class="md-nav__item"><a href="#id17" class="md-nav__link">标准复制</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id18" class="md-nav__link">提供者节点配置</a>
        </li>
        <li class="md-nav__item"><a href="#id19" class="md-nav__link">副本节点配置</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id20" class="md-nav__link">用户及组管理</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#ldapscripts" class="md-nav__link">简单命令行版：ldapscripts</a>
        </li>
        <li class="md-nav__item"><a href="#web-ldap-account-manager" class="md-nav__link">更加易用的WEB版：LDAP Account Manager</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id21" class="md-nav__link">客户端设置</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#sssd" class="md-nav__link">SSSD简介</a>
        </li>
        <li class="md-nav__item"><a href="#id22" class="md-nav__link">普通认证客户节点设置</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id23" class="md-nav__link">参考资料</a>
        </li>
  </ul>
</nav>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#id2" class="md-nav__link">基本概念</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id3" class="md-nav__link">常用关键字列表</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#ldif-ldap-data-interchange-format" class="md-nav__link">LDIF(LDAP Data Interchange Format)格式</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id4" class="md-nav__link">节点分类</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id5" class="md-nav__link">服务端设置</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#tls" class="md-nav__link">生成TLS加密证书</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#ldap" class="md-nav__link">安装所需LDAP包</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#dif" class="md-nav__link">默认DIF</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id7" class="md-nav__link">填充目录</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id8" class="md-nav__link">修改配置</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#id9" class="md-nav__link">增加索引</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#rootdn" class="md-nav__link">修改 <em>rootDN</em> 密码</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id10" class="md-nav__link">增加模式</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id11" class="md-nav__link">记录日志</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id12" class="md-nav__link">访问控制</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#ldap-readonly" class="md-nav__link">生成客户端等获取用户信息的LDAP账户 <em>readonly</em></a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#id13" class="md-nav__link">生成LDAP账户 <em>readonly</em></a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#readonly-acl" class="md-nav__link">设置账户 <em>readonly</em> ACL只读权限</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id14" class="md-nav__link">启用TLS认证</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#openldap" class="md-nav__link">高可用性设置：OpenLDAP复制（可选）</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#id15" class="md-nav__link">为副本节点生成证书</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id16" class="md-nav__link">提供者配置 - 设置用于复制LDAP信息的用户</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id17" class="md-nav__link">标准复制</a>
      
    
    </li></ul>
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id20" class="md-nav__link">用户及组管理</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#ldapscripts" class="md-nav__link">简单命令行版：ldapscripts</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#web-ldap-account-manager" class="md-nav__link">更加易用的WEB版：LDAP Account Manager</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id21" class="md-nav__link">客户端设置</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#sssd" class="md-nav__link">SSSD简介</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id22" class="md-nav__link">普通认证客户节点设置</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id23" class="md-nav__link">参考资料</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#ubuntu-ldap--page-root" class="md-nav__link">简介</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id2" class="md-nav__link">基本概念</a>
        </li>
        <li class="md-nav__item"><a href="#id3" class="md-nav__link">常用关键字列表</a>
        </li>
        <li class="md-nav__item"><a href="#ldif-ldap-data-interchange-format" class="md-nav__link">LDIF(LDAP Data Interchange Format)格式</a>
        </li>
        <li class="md-nav__item"><a href="#id4" class="md-nav__link">节点分类</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id5" class="md-nav__link">服务端设置</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#tls" class="md-nav__link">生成TLS加密证书</a>
        </li>
        <li class="md-nav__item"><a href="#ldap" class="md-nav__link">安装所需LDAP包</a>
        </li>
        <li class="md-nav__item"><a href="#dif" class="md-nav__link">默认DIF</a>
        </li>
        <li class="md-nav__item"><a href="#id7" class="md-nav__link">填充目录</a>
        </li>
        <li class="md-nav__item"><a href="#id8" class="md-nav__link">修改配置</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id9" class="md-nav__link">增加索引</a>
        </li>
        <li class="md-nav__item"><a href="#rootdn" class="md-nav__link">修改 <em>rootDN</em> 密码</a>
        </li>
        <li class="md-nav__item"><a href="#id10" class="md-nav__link">增加模式</a>
        </li>
        <li class="md-nav__item"><a href="#id11" class="md-nav__link">记录日志</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id12" class="md-nav__link">访问控制</a>
        </li>
        <li class="md-nav__item"><a href="#ldap-readonly" class="md-nav__link">生成客户端等获取用户信息的LDAP账户 <em>readonly</em></a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id13" class="md-nav__link">生成LDAP账户 <em>readonly</em></a>
        </li>
        <li class="md-nav__item"><a href="#readonly-acl" class="md-nav__link">设置账户 <em>readonly</em> ACL只读权限</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id14" class="md-nav__link">启用TLS认证</a>
        </li>
        <li class="md-nav__item"><a href="#openldap" class="md-nav__link">高可用性设置：OpenLDAP复制（可选）</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id15" class="md-nav__link">为副本节点生成证书</a>
        </li>
        <li class="md-nav__item"><a href="#id16" class="md-nav__link">提供者配置 - 设置用于复制LDAP信息的用户</a>
        </li>
        <li class="md-nav__item"><a href="#id17" class="md-nav__link">标准复制</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id18" class="md-nav__link">提供者节点配置</a>
        </li>
        <li class="md-nav__item"><a href="#id19" class="md-nav__link">副本节点配置</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id20" class="md-nav__link">用户及组管理</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#ldapscripts" class="md-nav__link">简单命令行版：ldapscripts</a>
        </li>
        <li class="md-nav__item"><a href="#web-ldap-account-manager" class="md-nav__link">更加易用的WEB版：LDAP Account Manager</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id21" class="md-nav__link">客户端设置</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#sssd" class="md-nav__link">SSSD简介</a>
        </li>
        <li class="md-nav__item"><a href="#id22" class="md-nav__link">普通认证客户节点设置</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id23" class="md-nav__link">参考资料</a>
        </li>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="id1">
<h1 id="ubuntu-ldap--page-root">简介<a class="headerlink" href="#ubuntu-ldap--page-root" title="此标题的永久链接">¶</a></h1>
<section id="id2">
<h2 id="id2">基本概念<a class="headerlink" href="#id2" title="此标题的永久链接">¶</a></h2>
<p>LDAP（Lightweight Directory Access Protocol - 轻量级目录控制协议）是一种运行在TCP/IP上用于查询和修改基于X.500的目录服务的协议，可用于用户身份认证。当前的LDAP版本为LDAPv3（RFC4510定义），Ubuntu上的实现为OpenLDAP。</p>
<p>LDAP协议控制目录，常见的误解为称一个目录为一个LDAP目录或LDAP数据库，但由于这实在是太常见，而且我们也知道谈论的是什么，因此这是可以的。</p>
<p>以下为几个主要的关键概念和术语：</p>
<ul class="simple">
<li><p>目录 <strong>directory</strong> 是数据条目 <strong>entry</strong> 树，且分级存放，被称为目录信息树(Directory Information Tree, DIT)；</p></li>
<li><p>每个条目含有一属性集 <strong>attributes</strong> ；</p></li>
<li><p>属性都有一个名字/描述 <strong>key</strong> 和一个或多个值 <strong>value</strong> ；</p></li>
<li><p>每个属性都被定义在至少一个对象类 <strong>objectClass</strong> 内；</p></li>
<li><p>属性和对象类在模式 <strong>schemas</strong> （对象类实际被认为一种特殊的属性）中定义；</p></li>
<li><p>每个条目都有唯一的标识符：它的专有名字(Distinguished Name, <strong>DN</strong> 或 <strong>dn</strong> )，这又含有一个被父条目 <strong>DN</strong> 跟随的相对专有名字(Relative Distinguished Name， <strong>RDN</strong> )；</p></li>
<li><p>条目 <strong>DN</strong> 不是一种属性，它不被视为条目自身的一部分。</p></li>
</ul>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>objectClass</p></th>
<th class="head"><p>含义</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>olcGlobal</p></td>
<td><p>全局配置文件类型， 主要是 <em>cn=config.ldif</em> 中的配置项</p></td>
</tr>
<tr class="row-odd"><td><p>top</p></td>
<td><p>顶层的对象</p></td>
</tr>
<tr class="row-even"><td><p>organization</p></td>
<td><p>组织，比如公司名称，顶层的对象</p></td>
</tr>
<tr class="row-odd"><td><p>organizationalUnit</p></td>
<td><p>重要，一个目录节点，通常是 <em>group</em> ，或者部门这样的含义</p></td>
</tr>
<tr class="row-even"><td><p>inetOrgPerson</p></td>
<td><p>重要，真正的用户节点类型， <em>person</em> 类型， 叶子节点</p></td>
</tr>
<tr class="row-odd"><td><p>groupOfNames</p></td>
<td><p>重要，分组的group类型，标记一个 <em>group</em> 节点</p></td>
</tr>
<tr class="row-even"><td><p>olcModuleList</p></td>
<td><p>配置模块的对象</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id3">
<h2 id="id3">常用关键字列表<a class="headerlink" href="#id3" title="此标题的永久链接">¶</a></h2>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>关键字</p></th>
<th class="head"><p>英文全称</p></th>
<th class="head"><p>含义</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>dc</p></td>
<td><p>Domain Component</p></td>
<td><p>域名的部分，其格式是将完整的域名分成几部分（以 <strong>“,”</strong> 分隔，且加 <strong>“dc=”</strong> ），如域名为“example.com”，则变成“dc=example,dc=com”</p></td>
</tr>
<tr class="row-odd"><td><p>uid</p></td>
<td><p>User Id</p></td>
<td><p>用户ID，如“tom”</p></td>
</tr>
<tr class="row-even"><td><p>ou</p></td>
<td><p>Organization Unit</p></td>
<td><p>组织单位，类似于Linux文件系统中的子目录，它是一个容器对象，组织单位可以包含其他各种对象（包括其他组织单元），如“market” ；最多可以有四级，每级最长32个字符；可以为中文</p></td>
</tr>
<tr class="row-odd"><td><p>cn</p></td>
<td><p>Common Name</p></td>
<td><p>公共名称，如“Thomas Johansson”，最长可以到80个字符，可以为中文</p></td>
</tr>
<tr class="row-even"><td><p>sn</p></td>
<td><p>Surname</p></td>
<td><p>姓，如“Johansson”</p></td>
</tr>
<tr class="row-odd"><td><p>dn</p></td>
<td><p>Distinguished Name</p></td>
<td><p>专有名称，类似于Linux文件系统中的绝对路径，每个对象都有一个惟一的名称，如“uid= tom,ou=market,dc=example,dc=com”，在一个目录树中DN总是惟一的</p></td>
</tr>
<tr class="row-even"><td><p>rdn</p></td>
<td><p>Relative dn</p></td>
<td><p>相对名称，类似于文件系统中的相对路径，它是与目录树结构无关的部分，如“uid=tom”或“cn= Thomas Johansson”</p></td>
</tr>
<tr class="row-odd"><td><p>c</p></td>
<td><p>Country</p></td>
<td><p>国家，如“CN”或“US”等，为2个字符长</p></td>
</tr>
<tr class="row-even"><td><p>o</p></td>
<td><p>Organization</p></td>
<td><p>组织名，如“Example, Inc.”，可以3—64个字符长</p></td>
</tr>
</tbody>
</table>
<p>如：</p>
<ul class="simple">
<li><p>DN：cn=hmli,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn</p></li>
<li><p>RDN：cn=hmli</p></li>
<li><p>父DN：dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn</p></li>
</ul>
<p>为了在命令行上执行命令时无需输入 <strong>dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn</strong> 这一长串字符（既简单，又避免错误），可以定义一个变量方便后面使用，如在bash下执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">DC</span><span class="o">=</span><span class="s2">"dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span>
</pre></div>
</div>
<p>之后在命令行（配置文件中不可以）即可用 <strong>$DC</strong> 来引用，如执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ldapadd -x -D cn=Maneger,$DC -W -f add_content.ldif
</pre></div>
</div>
</section>
<section id="ldif-ldap-data-interchange-format">
<h2 id="ldif-ldap-data-interchange-format">LDIF(LDAP Data Interchange Format)格式<a class="headerlink" href="#ldif-ldap-data-interchange-format" title="此标题的永久链接">¶</a></h2>
<p><strong>LDIF</strong> 是一种基于文本的格式，用于描述目录服务实体及其属性。使用 <strong>LDIF</strong> 格式，可以通过 <em>ldapadd</em> 和 <em>ldapmodify</em> 等命令将信息从一个目录移到另一个目录。下面是用户信息服务的 <strong>LDIF</strong> 格式的示例。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">hmli</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">cn</span><span class="p">:</span> <span class="n">hmli</span>
<span class="n">givenName</span><span class="p">:</span> <span class="n">Huimin</span>
<span class="n">sn</span><span class="p">:</span> <span class="n">LI</span>
<span class="n">telephoneNumber</span><span class="p">:</span> <span class="mi">188</span> <span class="mi">551</span> <span class="n">xxxxx</span>
<span class="n">telephoneNumber</span><span class="p">:</span> <span class="mi">188</span> <span class="mi">551</span> <span class="n">yyyyy</span>
<span class="n">mail</span><span class="p">:</span> <span class="n">hmli</span><span class="nd">@ustc</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span>
<span class="n">manager</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">inetOrgPerson</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">organizationalPerson</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">person</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">top</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><strong>:</strong> 前为变量， <strong>:</strong> 后为值。</p>
</div>
</section>
<section id="id4">
<h2 id="id4">节点分类<a class="headerlink" href="#id4" title="此标题的永久链接">¶</a></h2>
<p>按照功能不同可以分为以下三类：</p>
<ul class="simple">
<li><p>服务端、服务节点：提供LDAP认证服务，如主管理节点</p></li>
<li><p>复制端、复制节点、冗余节点：提供LDAP服务端的复制，实现冗余功能，如从管理节点</p></li>
<li><p>客户端：需要发起LDAP认证服务，如登录节点、计算节点等</p></li>
</ul>
<p>针对本文档约定：</p>
<ul class="simple">
<li><p>服务端节点名：admin22-01</p></li>
<li><p>复制端节点名：admin22-02</p></li>
<li><p>DNS域名后缀：hanhai.scc.ustc.edu.cn</p></li>
</ul>
</section>
</section>
<section id="id5">
<h1 id="id5">服务端设置<a class="headerlink" href="#id5" title="此标题的永久链接">¶</a></h1>
<section id="tls">
<span id="id6"></span><h2 id="tls">生成TLS加密证书<a class="headerlink" href="#tls" title="此标题的永久链接">¶</a></h2>
<p>当与OpenLDAP服务端进行认证时，最好采用加密会话，这可以利用TLS（Transport Layer Security，传输层安全性)协议实现。</p>
<p>在这里，我们将成为我们自己的证书颁发机构（ <strong>Certificate Authority</strong> ），然后创建并签署我们的LDAP服务器证书作为该 <strong>CA</strong> 。本指南将使用 <em>certtool</em> 实用程序来完成这些任务。为简单起见，这是在OpenLDAP服务器本身上完成的，但您真正的内部 <strong>CA</strong> 应该在其他地方。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>以后除非特殊说明，否则都是以 <em>root</em> 用户执行。</p>
</div>
<p>安装所需要的包，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">gnutls</span><span class="o">-</span><span class="nb">bin</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span>
</pre></div>
</div>
<p>生成Certificate Authority的私钥，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">certtool</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">privkey</span> <span class="o">--</span><span class="n">bits</span> <span class="mi">4096</span> <span class="o">--</span><span class="n">outfile</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">mycakey</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>生成定义该 <strong>CA</strong> 的模板文件：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cn</span> <span class="o">=</span> <span class="n">USTC</span> <span class="n">SCC</span>
<span class="n">ca</span>
<span class="n">cert_signing_key</span>
<span class="n">expiration_days</span> <span class="o">=</span> <span class="mi">3650</span>
</pre></div>
</div>
<p>生成自签名 <strong>CA</strong> 证书存为文件 <em>/usr/local/share/ca-certificates/mycacert.crt</em> ，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">certtool</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="bp">self</span><span class="o">-</span><span class="n">signed</span> \
    <span class="o">--</span><span class="n">load</span><span class="o">-</span><span class="n">privkey</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">mycakey</span><span class="o">.</span><span class="n">pem</span> \
    <span class="o">--</span><span class="n">template</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">info</span> \
    <span class="o">--</span><span class="n">outfile</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span><span class="o">/</span><span class="n">mycacert</span><span class="o">.</span><span class="n">crt</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>–outfile 是正确的，我们在目录 <em>/usr/local/share/ca-certificates/</em> 下生成 <strong>CA</strong> 。这里是命令 <em>update-ca-certificates</em> 将拾起可信任的本地CA的目录。为了从目录 <em>/usr/share/ca-certificates/</em> （不含有 <em>local</em> ）获取 <strong>CA</strong> ，需要执行命令 <em>dpkg-reconfigure ca-certificates</em> 。</p>
</div>
<p>执行命令 <em>update-ca-certificates</em> 将新的CA认证加入可信任的CA列表中（注意执行下述命令显示加入一个CA）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">update</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span>
</pre></div>
</div>
<p>屏幕显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Updating</span> <span class="n">certificates</span> <span class="ow">in</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">...</span>
<span class="mi">1</span> <span class="n">added</span><span class="p">,</span> <span class="mi">0</span> <span class="n">removed</span><span class="p">;</span> <span class="n">done</span><span class="o">.</span>
<span class="n">Running</span> <span class="n">hooks</span> <span class="ow">in</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span><span class="o">/</span><span class="n">update</span><span class="o">.</span><span class="n">d</span><span class="o">...</span>
<span class="n">done</span><span class="o">.</span>
</pre></div>
</div>
<p>上述还会生成软链接 <em>/etc/ssl/certs/mycacert.pem</em> ，该软链接指向实际的目录 <em>/usr/local/share/ca-certificates/</em> 中的文件。以后会经常使用该软链接 <em>/etc/ssl/certs/mycacert.pem</em> 。</p>
<p>设置服务端的私有证书，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">certtool</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">privkey</span> <span class="o">--</span><span class="n">bits</span> <span class="mi">2048</span> <span class="o">--</span><span class="n">outfile</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">admin22_01_slapd_key</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>用你实际的服务端节点名代替上述的 <strong>admin22-01</strong>  。为将要使用它们的主机和服务命名证书和密钥将有助于保持清晰。</p>
</div>
<p>生成包含下面信息的文件 <em>admin22-01.info</em> ：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">organization</span> <span class="o">=</span> <span class="n">USTC</span> <span class="n">SCC</span>
<span class="n">cn</span> <span class="o">=</span> <span class="n">admin22</span><span class="o">-</span><span class="mi">01</span>
<span class="n">scc</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span>
<span class="n">tls_www_server</span>
<span class="n">encryption_key</span>
<span class="n">signing_key</span>
<span class="n">expiration_days</span> <span class="o">=</span> <span class="mi">3650</span>
</pre></div>
</div>
<p>上述证书有效期为10年，仅对 <em>admin22-01</em> 节点有效。</p>
<p>生成服务端认证证书，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">certtool</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">certificate</span> \
    <span class="o">--</span><span class="n">load</span><span class="o">-</span><span class="n">privkey</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">admin22</span><span class="o">-</span><span class="mi">01</span><span class="n">_slapd_key</span><span class="o">.</span><span class="n">pem</span> \
    <span class="o">--</span><span class="n">load</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">certificate</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">mycacert</span><span class="o">.</span><span class="n">pem</span> \
    <span class="o">--</span><span class="n">load</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">privkey</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">mycakey</span><span class="o">.</span><span class="n">pem</span> \
    <span class="o">--</span><span class="n">template</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">ldap01</span><span class="o">.</span><span class="n">info</span> \
    <span class="o">--</span><span class="n">outfile</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">ldap01_slapd_cert</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>调整权限与所有者，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chgrp</span> <span class="n">openldap</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">admin22</span><span class="o">-</span><span class="mi">01</span><span class="n">_slapd_key</span><span class="o">.</span><span class="n">pem</span>
<span class="n">chmod</span> <span class="mi">0640</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">admin22</span><span class="o">-</span><span class="mi">01</span><span class="n">_slapd_key</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
</section>
<section id="ldap">
<span id="installpkg"></span><h2 id="ldap">安装所需LDAP包<a class="headerlink" href="#ldap" title="此标题的永久链接">¶</a></h2>
<p>安装服务端所需包，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">slapd</span> <span class="n">ldap</span><span class="o">-</span><span class="n">utils</span>
</pre></div>
</div>
<p>如需要修改目录信息树 <strong>DIT</strong> 后缀，当前是一个很好的时机（因为修改会取消当前存在的配置信息）。如需修改，请运行下面命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dpkg</span><span class="o">-</span><span class="n">reconfigure</span> <span class="n">slapd</span>
</pre></div>
</div>
<p>修改文件 <em>/etc/ldap/ldap.conf</em> 内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1"># LDAP Defaults</span>
<span class="c1">#</span>

<span class="c1"># See ldap.conf(5) for details</span>
<span class="c1"># This file should be world readable but not world writable.</span>

<span class="n">BASE</span>        <span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">URI</span> <span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span> <span class="c1">#ldap://ldap-provider.example.com:666</span>

<span class="c1">#SIZELIMIT  12</span>
<span class="c1">#TIMELIMIT  15</span>
<span class="c1">#DEREF              never</span>

<span class="c1"># TLS certificates (needed for GnuTLS)</span>
<span class="n">TLS_CACERT</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span><span class="o">.</span><span class="n">crt</span>
<span class="n">TLS_REQCERT</span> <span class="n">demand</span>
</pre></div>
</div>
</section>
<section id="dif">
<h2 id="dif">默认DIF<a class="headerlink" href="#dif" title="此标题的永久链接">¶</a></h2>
<p><strong>slapd</strong> 软件包被设计为在服务本身内配置，为此目的专门设置了一个独立的DIT。这样将允许动态配置 <strong>slapd</strong> 时无需重启服务或编辑配置文件。配置数据库含有一系列存储在目录 <em>/etc/ldap/slapd.d/</em> 下基于文本的LDIF文件（但最好永远不要直接编辑这些文件）。这种工作方式有几个名称：slapd-config方法、RTC方法（实时配置）或cn=config方法。也可以采用传统的平面文件（flat-file，包含没有相对关系结构的记录的文件）方法(slapd.conf)，但这里不涉及。</p>
<p>完成安装后，将得到两个数据库或后缀：一个为基于您的主机域名(hanhai.scc.ustc.edu.cn)的数据；另一个为配置文件，其根位于cn=config。为了修改每个数据，需要不同的认证和访问方法：</p>
<ul class="simple">
<li><p>dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn：针对该后缀的管理账户账户为 <em>cn=Maneger,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn</em> ，密码是在安装 <strong>slapd</strong> 包时设定的。</p></li>
<li><p>cn=config：保存该后缀下slapd自身的配置。可以利用特定的 <em>DN gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth</em> 改为这。这为当采用SASL外部身份验证时（使用 <em>ldapi:///</em> 传输经由*/run/slapd/ldapi* unix套接字），使得本地系统的 <em>root</em> 用户(uid=0/gid=0)如何被目录看见。本质上，这意味着只有本地 <em>root</em> 用户才能更新cn=config数据库。</p></li>
</ul>
<p>下面为利用LDAP协议的命令 <em>ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b cn=config dn</em> 看到的slapd-config DIT信息看起来的格式（#及之后内容为解释，实际显示不出）：</p>
<p>::
dn: cn=config #全局配置</p>
<blockquote>
<div><p>dn: cn=module{0},cn=config #动态加载模块</p>
<p>dn: cn=schema,cn=config #含硬编码（Hard-coded，写死）的系统级模式￼</p>
<p>dn: cn={0}core,cn=schema,cn=config #含硬编码核心模式</p>
<p>dn: cn={1}cosine,cn=schema,cn=config #RFC 1274 COSINE模式</p>
<p>dn: cn={2}nis,cn=schema,cn=config #NIS模式</p>
<p>dn: cn={3}inetorgperson,cn=schema,cn=config #InetOrgPerson模式，存储真正的用户节点类型，person类型， 叶子节点</p>
<p>dn: olcDatabase={-1}frontend,cn=config #前端数据库，存储针对其他数据库的默认设置</p>
<p>dn: olcDatabase={0}config,cn=config #存储Slapd配置数据库信息（cn=config）</p>
<p>dn: olcDatabase={1}mdb,cn=config #存储你自己的数据库实体（dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn）</p>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">备注</p>
<ul class="simple">
<li><p>-Q：启用SASL的静默模式，即不提示。</p></li>
<li><p>-LLL：设置以LDIF格式显示搜索结果：</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>单个 <em>-L</em> 设定以LDIFv1模式显示；</p></li>
<li><p>第二个 <em>-L</em> 禁止显示注释；</p></li>
<li><p>第三个 <em>-L</em> 禁止打印LDIF版本。</p></li>
</ul>
</div></blockquote>
</div>
<p>执行下面命令进行设置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dpkg</span><span class="o">-</span><span class="n">reconfigure</span> <span class="n">slapd</span>
</pre></div>
</div>
<p>当提示设置DNS domain name（设置DNS域名）时，输入：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hanhai</span><span class="o">.</span><span class="n">scc</span><span class="o">.</span><span class="n">ustc</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span>
</pre></div>
</div>
<p>当提示Organization name（设置组织名）时，输入：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">USTC</span> <span class="n">SCC</span>
</pre></div>
</div>
<p>当提示输入Administrator password（设置管理账户密码）时，输入用户 <em>cn=Maneger</em> 的密码（千万别忘了该密码）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapsearch</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">LLL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldap</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">b</span> <span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span> <span class="n">dn</span>
</pre></div>
</div>
<p>输出为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
</pre></div>
</div>
<p>执行命令验证是否成功：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ldapwhoami -x -D cn=Maneger,$DC -W
</pre></div>
</div>
<p>输出为下方输入密码提示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Enter</span> <span class="n">LDAP</span> <span class="n">Password</span><span class="p">:</span>
</pre></div>
</div>
<p>输入密码后，输出如下，则表示成功：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span><span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
</pre></div>
</div>
<p>两种不同的认证机制：</p>
<ul class="simple">
<li><p>-x：简单绑定，基础的文本认证。因为没有提供binddn（ <em>-D</em> 选项），这将为匿名绑定。未使用 <em>-x</em> 选项时，默认采用SASL绑定。</p></li>
<li><p>-Y EXTERNAL：采用SASL绑定（无 <em>-x</em> 选项），采用EXTERNAL类型。与 <em>-H ldapi:///</em> 一起使用，采用本地UNIX socket连接。</p></li>
</ul>
<p>这两种情形，我们都将只会获得服务端ACL基于我们的身份允许我们看到的信息。用于验证认证非常方便的命令为 <em>ldapwhoami</em> ，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapwhoami</span> <span class="o">-</span><span class="n">x</span>
</pre></div>
</div>
<p>显示如下，则表示成功：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">anonymous</span>
</pre></div>
</div>
<p>执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapwhoami</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">D</span> <span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span> <span class="o">-</span><span class="n">W</span>
</pre></div>
</div>
<p>在输入密码后显示如下，则表示成功：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span><span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
</pre></div>
</div>
<p>当采用简单绑定 <em>-x</em> 选项且用 <em>-D</em> 选项指定一个 <strong>binddn</strong> 作为认证 <strong>dn</strong> 时，服务端将寻找该条目的 <strong>userPassword</strong> 属性用于认证。在上面的特殊情况下，我们采用的是数据库中的 <strong>rootDN</strong> 条目，即实际管理账户，这是一种特殊情况，其密码是在安装包时在配置中设置的。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>没有采用传输安全协议的简单绑定是明文传输的，非常不安全，应该尽快在OpenLDAP服务端中增加TLS支持（不要再用即将被淘汰的LDAPS）。</p>
</div>
<p>下面为采用SASL（Simple Authentication and Security Layer，简单认证与安全层）的例子（sudo为 <em>root</em> 用户权限，因此UidNumber与GidNumber为0）：
普通用户执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapwhoami</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">Q</span>
</pre></div>
</div>
<p>显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span><span class="n">gidNumber</span><span class="o">=</span><span class="mi">1000</span><span class="o">+</span><span class="n">uidNumber</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">peercred</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">external</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">auth</span>
</pre></div>
</div>
<p>切换到 <em>root</em> 用户或采用 <em>sudo</em> 执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapwhoami</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">Q</span>
</pre></div>
</div>
<p>显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span><span class="n">gidNumber</span><span class="o">=</span><span class="mi">0</span><span class="o">+</span><span class="n">uidNumber</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">peercred</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">external</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">auth</span>
</pre></div>
</div>
<p>当采用通过 <em>ldapi:///</em> 传输使用 <em>SASL EXTERNAL</em> 时， <strong>binddn</strong> 变为连接中用户的 <em>uid</em> 和 <em>gid</em> 的组合，且后面跟随后缀 <em>cn=peercred,cn=external,cn=auth</em> 。服务端的ACL知道此规则，可以保证本地 <em>root</em> 用户利用SASL机制完成针对cn=config的写访问。</p>
</section>
<section id="id7">
<h2 id="id7">填充目录<a class="headerlink" href="#id7" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><p>People节点（存储用户）</p></li>
<li><p>Groups节点（存储用户组）</p></li>
<li><p>scc用户组</p></li>
<li><p>Huimin LI用户</p></li>
</ul>
<p>生成 <em>add_content.ldif</em> 文件（为方便检查修改等，可以自己建立个目录 <em>/etc/ldap/slapd.d/ldif/</em> ，放在其下），其内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">ou</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">organizationalUnit</span>
<span class="n">ou</span><span class="p">:</span> <span class="n">People</span>

<span class="n">dn</span><span class="p">:</span> <span class="n">ou</span><span class="o">=</span><span class="n">Groups</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">organizationalUnit</span>
<span class="n">ou</span><span class="p">:</span> <span class="n">Groups</span>

<span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">Groups</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">posixGroup</span>
<span class="n">cn</span><span class="p">:</span> <span class="n">miners</span>
<span class="n">gidNumber</span><span class="p">:</span> <span class="mi">10000</span>

<span class="n">dn</span><span class="p">:</span> <span class="n">uid</span><span class="o">=</span><span class="n">hmli</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">inetOrgPerson</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">posixAccount</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">shadowAccount</span>
<span class="n">uid</span><span class="p">:</span> <span class="n">hmli</span>
<span class="n">sn</span><span class="p">:</span> <span class="n">LI</span>
<span class="n">givenName</span><span class="p">:</span> <span class="n">Huimin</span>
<span class="n">cn</span><span class="p">:</span> <span class="n">Huimin</span> <span class="n">LI</span>
<span class="n">displayName</span><span class="p">:</span> <span class="n">李会民</span>
<span class="n">uidNumber</span><span class="p">:</span> <span class="mi">10000</span>
<span class="n">gidNumber</span><span class="p">:</span> <span class="mi">10000</span>
<span class="n">userPassword</span><span class="p">:</span> <span class="p">{</span><span class="n">CRYPT</span><span class="p">}</span><span class="n">x</span>
<span class="n">gecos</span><span class="p">:</span> <span class="n">Huimin</span> <span class="n">LI</span>
<span class="n">loginShell</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">homeDirectory</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">scc</span><span class="o">/</span><span class="n">hmli</span>
</pre></div>
</div>
<p>执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapadd</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">D</span> <span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span> <span class="o">-</span><span class="n">W</span> <span class="o">-</span><span class="n">f</span> <span class="n">add_content</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
<p>根据”Enter LDAP Password:”提示输入密码后显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">adding</span> <span class="n">new</span> <span class="n">entry</span> <span class="s2">"ou=People,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span>

<span class="n">adding</span> <span class="n">new</span> <span class="n">entry</span> <span class="s2">"ou=Groups,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span>

<span class="n">adding</span> <span class="n">new</span> <span class="n">entry</span> <span class="s2">"cn=scc,ou=Groups,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span>

<span class="n">adding</span> <span class="n">new</span> <span class="n">entry</span> <span class="s2">"uid=hmli,ou=People,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span>
</pre></div>
</div>
<p>其他配置等也可以采用命令 <em>ldapadd</em> 来增加。</p>
<p>设定上面生成的用户 <em>hmli</em> 的密码，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldappasswd</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">D</span> <span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span> <span class="o">-</span><span class="n">W</span> <span class="o">-</span><span class="n">S</span> <span class="n">uid</span><span class="o">=</span><span class="n">hmli</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><em>cn=Maneger</em> 后无 <em>ou=People</em> ，而 <em>cn=hmli</em> 后有 <em>ou=People</em></p>
</div>
<p>按照提示先输入两次用户 <em>hmli</em> 的密码，最后输入管理账户 <em>Maneger</em> 的密码，屏幕输出显示如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">New</span> <span class="n">password</span><span class="p">:</span>
<span class="n">Re</span><span class="o">-</span><span class="n">enter</span> <span class="n">new</span> <span class="n">password</span><span class="p">:</span>
<span class="n">Enter</span> <span class="n">LDAP</span> <span class="n">Password</span><span class="p">:</span>
</pre></div>
</div>
<p>现在可以利用命令 <em>ldapsearch</em> 来检查上面信息，执行：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapsearch</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">LLL</span> <span class="o">-</span><span class="n">b</span> <span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span> <span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">hmli</span><span class="p">)</span> <span class="n">cn</span> <span class="n">gidNumber</span>
</pre></div>
</div>
<p>显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">uid</span><span class="o">=</span><span class="n">hmli</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">cn</span><span class="p">:</span> <span class="n">huimin</span> <span class="n">li</span>
<span class="n">gidNumber</span><span class="p">:</span> <span class="mi">10000</span>
</pre></div>
</div>
</section>
<section id="id8">
<h2 id="id8">修改配置<a class="headerlink" href="#id8" title="此标题的永久链接">¶</a></h2>
<p>slapd-config DIT可以被查询及修改。</p>
<section id="id9">
<h3 id="id9">增加索引<a class="headerlink" href="#id9" title="此标题的永久链接">¶</a></h3>
<p>如将 <strong>Index</strong> 增加到 <em>{1}mdb,cn=config</em> 数据库定义中，可以生成文件 <em>uid_index.ldif</em> ，内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">olcDatabase</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">mdb</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcDbIndex</span>
<span class="n">olcDbIndex</span><span class="p">:</span> <span class="n">mail</span> <span class="n">eq</span><span class="p">,</span><span class="n">sub</span>
</pre></div>
</div>
<p>执行命令提交：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapmodify</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">f</span> <span class="n">uid_index</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
<p>成功后，为查看确认，可以执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapsearch</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">LLL</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">b</span> <span class="n">cn</span><span class="o">=</span><span class="n">config</span> <span class="s1">'(olcDatabase=</span><span class="si">{1}</span><span class="s1">mdb)'</span> <span class="n">olcDbIndex</span>
</pre></div>
</div>
<p>如需要修改上面信息，可以利用命令 <em>ldapmodify</em> ，如生成 <em>mod_content.ldif</em> 文件，内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">Groups</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">gidNumber</span>
<span class="n">gidNumber</span><span class="p">:</span> <span class="mi">10001</span>

<span class="n">dn</span><span class="p">:</span> <span class="n">uid</span><span class="o">=</span><span class="n">hmli</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">displayName</span>
<span class="n">displayName</span><span class="p">:</span> <span class="n">Huimin</span> <span class="n">LI</span>
<span class="o">-</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">gecos</span>
<span class="n">gecos</span><span class="p">:</span> <span class="n">Huimin</span> <span class="n">LI</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<ul class="simple">
<li><p>上面两个 <em>dn</em> 间用空行分隔，在同一个条目下的两个动作时需要一个且只含有一个 <em>-</em> 的行区分。</p></li>
<li><p>changetype: modify 指示了是修改，其他还有add，delete等操作值</p></li>
<li><p>replace: gidNumber 指示了修改gidNumber属性</p></li>
<li><p>gidNumber: 10001 指示了修该后的gidNumber属性值</p></li>
</ul>
</div>
<p>执行命令提交：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapmodify</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">D</span> <span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span> <span class="o">-</span><span class="n">W</span> <span class="o">-</span><span class="n">f</span> <span class="n">mod_content</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
<p>将显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modifying</span> <span class="n">entry</span> <span class="s2">"cn=scc,ou=Groups,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span>

<span class="n">modifying</span> <span class="n">entry</span> <span class="s2">"uid=hmli,ou=People,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span>
</pre></div>
</div>
<p>也可以直接如下运行命令（注意最后的 <strong>-</strong> ，表示从屏幕输入），然后直接在屏幕上输入上述文件 <em>mod_content.ldif</em> 中的信息：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapmodify</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">D</span> <span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span> <span class="o">-</span><span class="n">W</span> <span class="o">-</span>
</pre></div>
</div>
</section>
<section id="rootdn">
<h3 id="rootdn">修改 <em>rootDN</em> 密码<a class="headerlink" href="#rootdn" title="此标题的永久链接">¶</a></h3>
<p>如忘记了LDAP管理账户密码，则需要由 <em>root</em> 用户或sudo权限的用户在LDAP系统的服务器上访问重置。</p>
<p>执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">slappasswd</span>
</pre></div>
</div>
<p>按提示输入新密码获取新密码的哈希(hash)值，屏幕显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">New</span> <span class="n">password</span><span class="p">:</span>
<span class="n">Re</span><span class="o">-</span><span class="n">enter</span> <span class="n">new</span> <span class="n">password</span><span class="p">:</span>
<span class="p">{</span><span class="n">SSHA</span><span class="p">}</span><span class="n">VKrYMxlSKhONGRpC6rnASKNmXG2xHXFo</span>
</pre></div>
</div>
<p>生成文件 <em>changerootpw.ldif</em> ，内容为（注意olcRootPW值为上述生成的{SSHA}前缀字符串）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">olcDatabase</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">mdb</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">olcRootPW</span>
<span class="n">olcRootPW</span><span class="p">:</span> <span class="p">{</span><span class="n">SSHA</span><span class="p">}</span><span class="n">VKrYMxlSKhONGRpC6rnASKNmXG2xHXFo</span>
</pre></div>
</div>
<p>执行命令进行修改：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapmodify</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">f</span> <span class="n">changerootpw</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
<p>仍旧有实际的 <em>cn=Maneger,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn dn</em> 在 <em>dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn</em> 数据库中，因此也进行修改。由于这是数据库中的一个条目，因此可以使用命令 <em>ldappasswd</em> 。</p>
<p>执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldappasswd</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">D</span> <span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span> <span class="o">-</span><span class="n">W</span> <span class="o">-</span><span class="n">S</span>
</pre></div>
</div>
<p>显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">New</span> <span class="n">password</span><span class="p">:</span>
<span class="n">Re</span><span class="o">-</span><span class="n">enter</span> <span class="n">new</span> <span class="n">password</span><span class="p">:</span>
<span class="n">Enter</span> <span class="n">LDAP</span> <span class="n">Password</span><span class="p">:</span>
</pre></div>
</div>
</section>
<section id="id10">
<h3 id="id10">增加模式<a class="headerlink" href="#id10" title="此标题的永久链接">¶</a></h3>
<p>只有LDIF格式的模式schemas才能增加到 <em>cn=config</em> 。如不是，则需要先进行转化（如利用命令 <em>schema2ldif</em> ）。可以在目录 <em>/etc/ldap/schema/</em> 中找到很多未转化的schemas。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>务必要慎重，如果不是太麻烦，建议先在测试系统中测试，成功后再在生产系统中测试。</p>
</div>
<p>下面为增加密码策略(ppolicy)模式而创建一个文件名为 <em>ppolicy.ldif</em> 的文件（针对Ubuntu 22.04系统，虽然官方手册说有现成文件 <em>/etc/ldap/schema/ppolicy.ldif</em> ，但实际并没有，需要生成），其内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># $OpenLDAP$
## This work is part of OpenLDAP Software &lt;http://www.openldap.org/&gt;.
##
## Copyright 2004-2021 The OpenLDAP Foundation.
## All rights reserved.
##
## Redistribution and use in source and binary forms, with or without
## modification, are permitted only as authorized by the OpenLDAP
## Public License.
##
## A copy of this license is available in the file LICENSE in the
## top-level directory of the distribution or, alternatively, at
## &lt;http://www.OpenLDAP.org/license.html&gt;.
#
## Portions Copyright (C) The Internet Society (2004).
## Please see full copyright statement below.
#
# Definitions from Draft behera-ldap-password-policy-07 (a work in progress)
#       Password Policy for LDAP Directories
# With extensions from Hewlett-Packard:
#       pwdCheckModule etc.
#
# Contents of this file are subject to change (including deletion)
# without notice.
#
# Not recommended for production use!
# Use with extreme caution!
#
# This file was automatically generated from ppolicy.schema; see that file
# for complete references.
#
dn: cn=ppolicy,cn=schema,cn=config
objectClass: olcSchemaConfig
cn: ppolicy
olcAttributeTypes: {0}( 1.3.6.1.4.1.42.2.27.8.1.1 NAME 'pwdAttribute' EQUALITY
  objectIdentifierMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.38 )
olcAttributeTypes: {1}( 1.3.6.1.4.1.42.2.27.8.1.2 NAME 'pwdMinAge' EQUALITY in
 tegerMatch ORDERING integerOrderingMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.27
  SINGLE-VALUE )
olcAttributeTypes: {2}( 1.3.6.1.4.1.42.2.27.8.1.3 NAME 'pwdMaxAge' EQUALITY in
 tegerMatch ORDERING integerOrderingMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.27
  SINGLE-VALUE )
olcAttributeTypes: {3}( 1.3.6.1.4.1.42.2.27.8.1.4 NAME 'pwdInHistory' EQUALITY
  integerMatch ORDERING integerOrderingMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1
 .27 SINGLE-VALUE )
olcAttributeTypes: {4}( 1.3.6.1.4.1.42.2.27.8.1.5 NAME 'pwdCheckQuality' EQUAL
 ITY integerMatch ORDERING integerOrderingMatch SYNTAX 1.3.6.1.4.1.1466.115.12
 1.1.27 SINGLE-VALUE )
olcAttributeTypes: {5}( 1.3.6.1.4.1.42.2.27.8.1.6 NAME 'pwdMinLength' EQUALITY
  integerMatch ORDERING integerOrderingMatch  SYNTAX 1.3.6.1.4.1.1466.115.121.
 1.27 SINGLE-VALUE )
olcAttributeTypes: {6}( 1.3.6.1.4.1.42.2.27.8.1.7 NAME 'pwdExpireWarning' EQUA
 LITY integerMatch ORDERING integerOrderingMatch  SYNTAX 1.3.6.1.4.1.1466.115.
 121.1.27 SINGLE-VALUE )
olcAttributeTypes: {7}( 1.3.6.1.4.1.42.2.27.8.1.8 NAME 'pwdGraceAuthNLimit' EQ
 UALITY integerMatch ORDERING integerOrderingMatch  SYNTAX 1.3.6.1.4.1.1466.11
 5.121.1.27 SINGLE-VALUE )
olcAttributeTypes: {8}( 1.3.6.1.4.1.42.2.27.8.1.9 NAME 'pwdLockout' EQUALITY b
 ooleanMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.7 SINGLE-VALUE )
olcAttributeTypes: {9}( 1.3.6.1.4.1.42.2.27.8.1.10 NAME 'pwdLockoutDuration' E
 QUALITY integerMatch ORDERING integerOrderingMatch  SYNTAX 1.3.6.1.4.1.1466.1
 15.121.1.27 SINGLE-VALUE )
olcAttributeTypes: {10}( 1.3.6.1.4.1.42.2.27.8.1.11 NAME 'pwdMaxFailure' EQUAL
 ITY integerMatch ORDERING integerOrderingMatch  SYNTAX 1.3.6.1.4.1.1466.115.1
 21.1.27 SINGLE-VALUE )
olcAttributeTypes: {11}( 1.3.6.1.4.1.42.2.27.8.1.12 NAME 'pwdFailureCountInter
 val' EQUALITY integerMatch ORDERING integerOrderingMatch  SYNTAX 1.3.6.1.4.1.
 1466.115.121.1.27 SINGLE-VALUE )
olcAttributeTypes: {12}( 1.3.6.1.4.1.42.2.27.8.1.13 NAME 'pwdMustChange' EQUAL
 ITY booleanMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.7 SINGLE-VALUE )
olcAttributeTypes: {13}( 1.3.6.1.4.1.42.2.27.8.1.14 NAME 'pwdAllowUserChange'
 EQUALITY booleanMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.7 SINGLE-VALUE )
olcAttributeTypes: {14}( 1.3.6.1.4.1.42.2.27.8.1.15 NAME 'pwdSafeModify' EQUAL
 ITY booleanMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.7 SINGLE-VALUE )
olcAttributeTypes: {14}( 1.3.6.1.4.1.42.2.27.8.1.15 NAME 'pwdSafeModify' EQUAL
 ITY booleanMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.7 SINGLE-VALUE )
olcAttributeTypes: {15}( 1.3.6.1.4.1.4754.1.99.1 NAME 'pwdCheckModule' DESC 'L
 oadable module that instantiates "check_password() function' EQUALITY caseExa
 ctIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 SINGLE-VALUE )
olcAttributeTypes: {16}( 1.3.6.1.4.1.42.2.27.8.1.30 NAME 'pwdMaxRecordedFailur
 e' EQUALITY integerMatch ORDERING integerOrderingMatch  SYNTAX 1.3.6.1.4.1.
 1466.115.121.1.27 SINGLE-VALUE )
olcObjectClasses: {0}( 1.3.6.1.4.1.4754.2.99.1 NAME 'pwdPolicyChecker' SUP top
  AUXILIARY MAY pwdCheckModule )
olcObjectClasses: {1}( 1.3.6.1.4.1.42.2.27.8.2.1 NAME 'pwdPolicy' SUP top AUXI
 LIARY MUST pwdAttribute MAY ( pwdMinAge $ pwdMaxAge $ pwdInHistory $ pwdCheck
 Quality $ pwdMinLength $ pwdExpireWarning $ pwdGraceAuthNLimit $ pwdLockout $
  pwdLockoutDuration $ pwdMaxFailure $ pwdFailureCountInterval $ pwdMustChange
  $ pwdAllowUserChange $ pwdSafeModify $ pwdMaxRecordedFailure ) )
</pre></div>
</div>
<p>执行命令增加到配置中：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapadd</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">schema</span><span class="o">/</span><span class="n">ppolicy</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
</section>
<section id="id11">
<h3 id="id11">记录日志<a class="headerlink" href="#id11" title="此标题的永久链接">¶</a></h3>
<p>服务进程 <em>slapd</em> 的活动日志记录在实施基于OpenLDAP的解决方案时非常有用，但必须在软件安装后手动启用。否则，日志中只会出现基本消息。与任何其他此类配置一样，日志记录是通过slapd-config数据库启用的。</p>
<p>OpenLDAP含有多个日志级别，每个级别都包含（附加）较低的级别的信息。一个很好的尝试级别是 <em>stats</em> （记录统计数据）。slapd-config手册页有更多关于不同子系统的内容。</p>
<p>准备文件 <em>logging.ldif</em> ，其内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">olcLogLevel</span>
<span class="n">olcLogLevel</span><span class="p">:</span> <span class="n">stats</span>
</pre></div>
</div>
<p>执行命令提交：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapmodify</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">f</span> <span class="n">logging</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
<p>这将产生大量的日志记录，一旦系统投入生产，将希望将其限制到不太详细的级别。在这种详细模式下，主机的系统日志引擎(rsyslog)可能难以跟上并可能丢弃消息，显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rsyslogd</span><span class="o">-</span><span class="mi">2177</span><span class="p">:</span> <span class="n">imuxsock</span> <span class="n">lost</span> <span class="mi">228</span> <span class="n">messages</span> <span class="kn">from</span> <span class="nn">pid</span> <span class="mi">2547</span> <span class="n">due</span> <span class="n">to</span> <span class="n">rate</span><span class="o">-</span><span class="n">limiting</span>
</pre></div>
</div>
<p>可以修改rsyslog服务配置文件 <em>/etc/rsyslog.conf</em> ，增加如下配置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Disable rate limiting
# (default is 200 messages in 5 seconds; below we make the 5 become 0)
$SystemLogRateLimitInterval 0
</pre></div>
</div>
<p>然后重启rsyslog服务，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">rsyslog</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</section>
</section>
<section id="id12">
<h2 id="id12">访问控制<a class="headerlink" href="#id12" title="此标题的永久链接">¶</a></h2>
<p><strong>slapd</strong> 包安装后就具有多种ACL访问控制策略。</p>
<p>查看现有mdb的ACL权限，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapsearch</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">LLL</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">b</span> <span class="n">cn</span><span class="o">=</span><span class="n">config</span> <span class="s1">'(olcDatabase=</span><span class="si">{1}</span><span class="s1">mdb)'</span> <span class="n">olcAccess</span>
</pre></div>
</div>
<p>显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">olcDatabase</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">mdb</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="n">to</span> <span class="n">attrs</span><span class="o">=</span><span class="n">userPassword</span> <span class="n">by</span> <span class="bp">self</span> <span class="n">write</span> <span class="n">by</span> <span class="n">anonymous</span> <span class="n">auth</span> <span class="n">by</span> <span class="o">*</span> <span class="n">none</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">to</span> <span class="n">attrs</span><span class="o">=</span><span class="n">shadowLastChange</span> <span class="n">by</span> <span class="bp">self</span> <span class="n">write</span> <span class="n">by</span> <span class="o">*</span> <span class="n">read</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">2</span><span class="p">}</span><span class="n">to</span> <span class="o">*</span> <span class="n">by</span> <span class="o">*</span> <span class="n">read</span>
</pre></div>
</div>
<p>查看现有frontend的ACL权限，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapsearch</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">LLL</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">b</span>  <span class="n">cn</span><span class="o">=</span><span class="n">config</span> <span class="s1">'(olcDatabase={-1}frontend)'</span> <span class="n">olcAccess</span>
</pre></div>
</div>
<p>显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">olcDatabase</span><span class="o">=</span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="n">frontend</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="n">to</span> <span class="o">*</span> <span class="n">by</span> <span class="n">dn</span><span class="o">.</span><span class="n">exact</span><span class="o">=</span><span class="n">gidNumber</span><span class="o">=</span><span class="mi">0</span><span class="o">+</span><span class="n">uidNumber</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">peercred</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">external</span>
 <span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">auth</span> <span class="n">manage</span> <span class="n">by</span> <span class="o">*</span> <span class="k">break</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">to</span> <span class="n">dn</span><span class="o">.</span><span class="n">exact</span><span class="o">=</span><span class="s2">""</span> <span class="n">by</span> <span class="o">*</span> <span class="n">read</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">2</span><span class="p">}</span><span class="n">to</span> <span class="n">dn</span><span class="o">.</span><span class="n">base</span><span class="o">=</span><span class="s2">"cn=Subschema"</span> <span class="n">by</span> <span class="o">*</span> <span class="n">read</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<ul class="simple">
<li><p><strong>rootDN</strong> 总是具有访问数据库的全部权限，无需包含在任何ACL中</p></li>
<li><p><strong>dn.exact</strong> 表示约束这个特定DN的访问</p></li>
</ul>
</div>
<p>最前面两个ACL至关重要：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="n">to</span> <span class="n">attrs</span><span class="o">=</span><span class="n">userPassword</span> <span class="n">by</span> <span class="bp">self</span> <span class="n">write</span> <span class="n">by</span> <span class="n">anonymous</span> <span class="n">auth</span> <span class="n">by</span> <span class="o">*</span> <span class="n">none</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">to</span> <span class="n">attrs</span><span class="o">=</span><span class="n">shadowLastChange</span> <span class="n">by</span> <span class="bp">self</span> <span class="n">write</span> <span class="n">by</span> <span class="o">*</span> <span class="n">read</span>
</pre></div>
</div>
<p>变为易读模式更直观便于理解：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">to</span> <span class="n">attrs</span><span class="o">=</span><span class="n">userPassword</span>
    <span class="n">by</span> <span class="bp">self</span> <span class="n">write</span>
    <span class="n">by</span> <span class="n">anonymous</span> <span class="n">auth</span>
    <span class="n">by</span> <span class="o">*</span> <span class="n">none</span>

<span class="n">to</span> <span class="n">attrs</span><span class="o">=</span><span class="n">shadowLastChange</span>
    <span class="n">by</span> <span class="bp">self</span> <span class="n">write</span>
    <span class="n">by</span> <span class="o">*</span> <span class="n">read</span>
</pre></div>
</div>
<p>ACL强制：</p>
<ul class="simple">
<li><p>为 <em>userPassword</em> 属性提供匿名“身份验证”访问权限，以便用户可以进行身份验证或绑定。也许与直觉相反，即使不需要匿名访问DIT，也需要“by anonymous auth”允许通过匿名身份验证，否则这将是鸡和蛋的问题：在身份验证之前，所有用户都是匿名的。</p></li>
<li><p><em>by self write</em> 规则，ACL将 <em>userPassword</em> 属性的写入权限授予以属性所在的 <em>dn</em> 进行身份验证的用户，也就是将用户可以更新自己的密码。</p></li>
<li><p><em>userPassword</em> 属性对其他用户都是不可访问的，只有 <em>rootDN</em> 用户除外，该用户总是具有权限也无需明确声明。</p></li>
<li><p>为了用户能利用 <em>passwd</em> 等其它工具修改自己的密码，用户自己的 <em>shadowLastChange</em> 属性需要可写。所有其他目录用户都可以读取此属性的内容。</p></li>
</ul>
<p>该DIT可以被匿名用户查询，就在于该ACL中含有 <em>‘to * by * read’</em> ，授予任何人（包括匿名）对其他所有内容的读取权限。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">to</span> <span class="o">*</span>
    <span class="n">by</span> <span class="o">*</span> <span class="n">read</span>
</pre></div>
</div>
<p>如前所述，没有为 <em>slapd-config</em> 数据库创建管理帐户（“rootDN”）。但是，有一个 <em>SASL</em> 身份被授予对它的完全访问权限。它代表本机 <em>localhost</em> 的超级用户 (root/sudo)：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="o">.</span><span class="n">exact</span><span class="o">=</span><span class="n">gidNumber</span><span class="o">=</span><span class="mi">0</span><span class="o">+</span><span class="n">uidNumber</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">peercred</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">external</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">auth</span>
</pre></div>
</div>
<p>显示 <em>slapd-config</em> 数据库中的ACL，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapsearch</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">LLL</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">b</span> <span class="n">cn</span><span class="o">=</span><span class="n">config</span> <span class="s1">'(olcDatabase=</span><span class="si">{0}</span><span class="s1">config)'</span> <span class="n">olcAccess</span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">olcDatabase</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="n">config</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="n">to</span> <span class="o">*</span> <span class="n">by</span> <span class="n">dn</span><span class="o">.</span><span class="n">exact</span><span class="o">=</span><span class="n">gidNumber</span><span class="o">=</span><span class="mi">0</span><span class="o">+</span><span class="n">uidNumber</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">peercred</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">external</span>
 <span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">auth</span> <span class="n">manage</span> <span class="n">by</span> <span class="o">*</span> <span class="k">break</span>
</pre></div>
</div>
<p>由于这是一个SASL身份，因此我们在调用相关LDAP实用程序时需使用SASL机制。它是外部机制，有关示例，请参见前面的命令。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<ul class="simple">
<li><p>需要 <em>root</em> 或您必须使用 <em>sudo</em> 成为根身份才能使ACL匹配。</p></li>
<li><p>EXTERNAL机制通过IPC（UNIX 域套接字）工作。这意味着您必须使用 <em>ldapi</em> URI格式。</p></li>
</ul>
</div>
<p>获取所有ACL的简洁方法为执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapsearch</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">LLL</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">b</span> <span class="n">cn</span><span class="o">=</span><span class="n">config</span> <span class="s1">'(olcAccess=*)'</span> <span class="n">olcAccess</span> <span class="n">olcSuffix</span>
</pre></div>
</div>
</section>
<section id="ldap-readonly">
<span id="getreadonly"></span><h2 id="ldap-readonly">生成客户端等获取用户信息的LDAP账户 <em>readonly</em><a class="headerlink" href="#ldap-readonly" title="此标题的永久链接">¶</a></h2>
<section id="id13">
<h3 id="id13">生成LDAP账户 <em>readonly</em><a class="headerlink" href="#id13" title="此标题的永久链接">¶</a></h3>
<p>为了安全，采用客户端通过只读账户获取服务端LDAP用户信息进行认证，为此在LDAP服务端设置所需要的LDAP账户 <em>readonly</em> ，生成配置文件 <em>add_readonly.ldif</em> ：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">readonly</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">simpleSecurityObject</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">organizationalRole</span>
<span class="n">cn</span><span class="p">:</span> <span class="n">readonly</span>
<span class="n">description</span><span class="p">:</span> <span class="k">for</span> <span class="n">sssd</span><span class="p">,</span> <span class="n">readonly</span> <span class="n">user</span>
<span class="n">userPassword</span><span class="p">:</span> <span class="p">{</span><span class="n">CRYPT</span><span class="p">}</span><span class="n">x</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>上述账户 <em>readonly</em> 的配置与普通系统账户不同，不含有 <strong>dc=People</strong> 等， <strong>objectClass</strong> 也不同等。</p>
</div>
<p>执行命令提交修改：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapadd</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">D</span> <span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span> <span class="o">-</span><span class="n">W</span> <span class="o">-</span><span class="n">f</span> <span class="n">add_readonly</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
<p>设定账户 <em>readonly</em> 密码，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldappasswd</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">D</span> <span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span> <span class="o">-</span><span class="n">W</span> <span class="o">-</span><span class="n">S</span> <span class="n">cn</span><span class="o">=</span><span class="n">readonly</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
</pre></div>
</div>
<p>按照提示，输入两次同样的 <em>readonly</em> 密码及一次LDAP管理账户 <em>Maneger</em> 密码。</p>
</section>
<section id="readonly-acl">
<span id="setacl"></span><h3 id="readonly-acl">设置账户 <em>readonly</em> ACL只读权限<a class="headerlink" href="#readonly-acl" title="此标题的永久链接">¶</a></h3>
<p>建立文件 <em>readonly-user_access.ldif</em> ，其内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">olcDatabase</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">mdb</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">olcAccess</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="n">to</span> <span class="n">attrs</span><span class="o">=</span><span class="n">userPassword</span><span class="p">,</span><span class="n">shadowLastChange</span>
  <span class="n">by</span> <span class="n">dn</span><span class="o">=</span><span class="s2">"cn=Maneger,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span> <span class="n">write</span>
  <span class="n">by</span> <span class="n">dn</span><span class="o">=</span><span class="s2">"cn=readonly,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span> <span class="n">read</span>
  <span class="n">by</span> <span class="bp">self</span> <span class="n">write</span>
  <span class="n">by</span> <span class="n">anonymous</span> <span class="n">auth</span>
  <span class="n">by</span> <span class="o">*</span> <span class="n">none</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">to</span> <span class="n">dn</span><span class="o">.</span><span class="n">base</span><span class="o">=</span><span class="s2">""</span> <span class="n">by</span> <span class="o">*</span> <span class="n">read</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">2</span><span class="p">}</span><span class="n">to</span> <span class="o">*</span>
  <span class="n">by</span> <span class="n">dn</span><span class="o">=</span><span class="s2">"cn=Maneger,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span> <span class="n">write</span>
  <span class="n">by</span> <span class="n">dn</span><span class="o">=</span><span class="s2">"cn=readonly,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span> <span class="n">read</span>
  <span class="n">by</span> <span class="bp">self</span> <span class="n">write</span>
  <span class="n">by</span> <span class="n">anonymous</span> <span class="n">auth</span>
  <span class="n">by</span> <span class="o">*</span> <span class="n">none</span>
</pre></div>
</div>
</section>
</section>
<section id="id14">
<h2 id="id14">启用TLS认证<a class="headerlink" href="#id14" title="此标题的永久链接">¶</a></h2>
<p>创建认证信息文件 <em>certinfo.ldif</em> ，其内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcTLSCACertificateFile</span>
<span class="n">olcTLSCACertificateFile</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">mycacert</span><span class="o">.</span><span class="n">pem</span>
<span class="o">-</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcTLSCertificateFile</span>
<span class="n">olcTLSCertificateFile</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">admin22</span><span class="o">-</span><span class="mi">01</span><span class="n">_slapd_cert</span><span class="o">.</span><span class="n">pem</span>
<span class="o">-</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcTLSCertificateKeyFile</span>
<span class="n">olcTLSCertificateKeyFile</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">admin22</span><span class="o">-</span><span class="mi">01</span><span class="n">_slapd_key</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>将上述信息加入LDAP配置，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapmodify</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">f</span> <span class="n">certinfo</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
<p>测试，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapwhoami</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">ZZ</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">admin22</span><span class="o">-</span><span class="mf">01.</span><span class="n">hanhai</span><span class="o">.</span><span class="n">scc</span><span class="o">.</span><span class="n">ustc</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span>
</pre></div>
</div>
<p>如输出如下，则表示正常：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">anonymous</span>
</pre></div>
</div>
</section>
<section id="openldap">
<h2 id="openldap">高可用性设置：OpenLDAP复制（可选）<a class="headerlink" href="#openldap" title="此标题的永久链接">¶</a></h2>
<p>随着越来越多的网络系统开始依赖LDAP，LDAP服务变得越来越重要。在这样的环境中，标准做法是在LDAP中构建冗余（高可用性），以防止LDAP服务器无响应时造成破坏。这是通过LDAP复制（Replication）完成的。</p>
<p>复制是通过 <em>Syncrepl</em> 引擎实现的。这允许使用消费者（Consumer，从服务端、备份服务端、副本服务端） - 提供者（Provider，主服务端）模型同步更改。可以在OpenLDAP管理账户指南及其定义RFC 4533中找到此复制机制的详细说明。</p>
<p>有两种方法可以使用此复制：</p>
<ul class="simple">
<li><p>标准复制：更改的条目被完整地发送给消费者。例如，如果 <strong>uid=hmli,ou=People,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn</strong> 条目的 <strong>userPassword</strong> 属性更改，则整个条目将发送给消费者。</p></li>
<li><p>增量复制：仅发送实际更改，而不是整个条目。</p></li>
</ul>
<p>增量复制发送更少的数据，但是设置更加复杂。对于两种复制模式，实际数据量都不大，对于多数应用，可以忽略标准复制多发的数据。因此，本文档仅介绍标准复制方式，不介绍增量复制方式。</p>
<p>在设置之前，需要已设置好TLS验证。</p>
<section id="id15">
<h3 id="id15">为副本节点生成证书<a class="headerlink" href="#id15" title="此标题的永久链接">¶</a></h3>
<p>在主节点上为复制者(replica)（消费者consumer） <strong>admin22-01</strong> 节点建立一个用于存储传输到 <strong>admin22-02</strong> 节点的文件夹 <em>admin22-02-ssl</em> ，并生成认证文件 <em>admin22-02_slapd_key.pem</em> ，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="n">ssl</span>
<span class="n">cd</span> <span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="n">ssl</span>
<span class="n">certtool</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">privkey</span>  <span class="o">--</span><span class="n">bits</span> <span class="mi">2048</span> <span class="o">--</span><span class="n">outfile</span> <span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="n">_slapd_key</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>生成存储副本节点信息的文件 <em>admin22-02.info</em> ，其内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">organization</span> <span class="o">=</span> <span class="n">USTC</span> <span class="n">SCC</span>
<span class="n">cn</span> <span class="o">=</span> <span class="n">admin22</span><span class="o">-</span><span class="mf">02.</span><span class="n">hanhai</span><span class="o">.</span><span class="n">scc</span><span class="o">.</span><span class="n">ustc</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span>
<span class="n">tls_www_server</span>
<span class="n">encryption_key</span>
<span class="n">signing_key</span>
<span class="n">expiration_days</span> <span class="o">=</span> <span class="mi">3650</span>
</pre></div>
</div>
<p>生成副本节点所需的证书 <em>admin22-02_slapd_cert.pem</em> ，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">certtool</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">certificate</span> \
<span class="o">--</span><span class="n">load</span><span class="o">-</span><span class="n">privkey</span> <span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="n">_slapd_key</span><span class="o">.</span><span class="n">pem</span> \
<span class="o">--</span><span class="n">load</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">certificate</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">mycacert</span><span class="o">.</span><span class="n">pem</span> \
<span class="o">--</span><span class="n">load</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">privkey</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">mycakey</span><span class="o">.</span><span class="n">pem</span> \
<span class="o">--</span><span class="n">template</span> <span class="n">admin22</span><span class="o">-</span><span class="mf">02.</span><span class="n">info</span> \
<span class="o">--</span><span class="n">outfile</span> <span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="n">_slapd_cert</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>获取CA证书副本存到该目录，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">mycacert</span><span class="o">.</span><span class="n">pem</span> <span class="o">.</span>
</pre></div>
</div>
<p>将上述目录 <em>admin22-02-ssl</em> 传输到 <strong>admin22-02</strong> 副本节点，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">..</span>
<span class="n">scp</span> <span class="o">-</span><span class="n">r</span> <span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="n">ssl</span> <span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="p">:</span>
</pre></div>
</div>
<p>在 <strong>admin22-02</strong> 副本节点执行下述命令，复制相关文件到对应目录：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="n">ssl</span>
<span class="n">cp</span> <span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="n">_slapd_cert</span><span class="o">.</span><span class="n">pem</span> <span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="n">_slapd_key</span><span class="o">.</span><span class="n">pem</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span>
<span class="n">chgrp</span> <span class="n">openldap</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="n">_slapd_key</span><span class="o">.</span><span class="n">pem</span>
<span class="n">chmod</span> <span class="mi">0640</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="n">_slapd_key</span><span class="o">.</span><span class="n">pem</span>
<span class="n">cp</span> <span class="n">mycacert</span><span class="o">.</span><span class="n">pem</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span><span class="o">/</span><span class="n">mycacert</span><span class="o">.</span><span class="n">crt</span>
<span class="n">update</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span>
</pre></div>
</div>
</section>
<section id="id16">
<h3 id="id16">提供者配置 - 设置用于复制LDAP信息的用户<a class="headerlink" href="#id16" title="此标题的永久链接">¶</a></h3>
<p>两种复制策略都需要一个复制用户以及更新ACL和有关此用户的限制。</p>
<p>要创建复制用户，请将以下内容保存到文件 <em>replicator.ldif</em> 中：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">replicator</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">simpleSecurityObject</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">organizationalRole</span>
<span class="n">cn</span><span class="p">:</span> <span class="n">replicator</span>
<span class="n">description</span><span class="p">:</span> <span class="n">Replication</span> <span class="n">user</span>
<span class="n">userPassword</span><span class="p">:</span> <span class="p">{</span><span class="n">CRYPT</span><span class="p">}</span><span class="n">x</span>
</pre></div>
</div>
<p>添加上述内容到LDAP，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapadd</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">D</span> <span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span> <span class="o">-</span><span class="n">W</span> <span class="o">-</span><span class="n">f</span> <span class="n">replicator</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
<p>设定密码，执行命令（要记住设定的账户 <em>replicator</em> 的密码，这里假设为 <em>replicatorPassword</em> ）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldappasswd</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">D</span> <span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span> <span class="o">-</span><span class="n">W</span> <span class="o">-</span><span class="n">S</span> <span class="n">cn</span><span class="o">=</span><span class="n">replicator</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
</pre></div>
</div>
<p>查看原有的ACL权限，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapsearch</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">LLL</span> <span class="o">-</span><span class="n">b</span> <span class="n">cn</span><span class="o">=</span><span class="n">config</span> <span class="s1">'(olcSuffix=dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn)'</span> <span class="n">olcAccess</span>
</pre></div>
</div>
<p>显示如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">olcDatabase</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">mdb</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="n">to</span> <span class="n">attrs</span><span class="o">=</span><span class="n">userPassword</span><span class="p">,</span><span class="n">shadowLastChange</span> <span class="n">by</span> <span class="n">dn</span><span class="o">=</span><span class="s2">"cn=Maneger,dc=hanhai</span>
 <span class="mi">22</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span><span class="s2">" write by dn="</span><span class="n">cn</span><span class="o">=</span><span class="n">readonly</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">us</span>
 <span class="n">tc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span><span class="s2">" read by self write by anonymous auth by * none</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">to</span> <span class="n">dn</span><span class="o">.</span><span class="n">base</span><span class="o">=</span><span class="s2">""</span> <span class="n">by</span> <span class="o">*</span> <span class="n">read</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">2</span><span class="p">}</span><span class="n">to</span> <span class="o">*</span> <span class="n">by</span> <span class="n">dn</span><span class="o">=</span><span class="s2">"cn=Maneger,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span> <span class="n">wr</span>
 <span class="n">ite</span> <span class="n">by</span> <span class="n">dn</span><span class="o">=</span><span class="s2">"cn=readonly,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span> <span class="n">read</span> <span class="n">by</span> <span class="bp">self</span>
 <span class="n">write</span> <span class="n">by</span> <span class="n">anonymous</span> <span class="n">auth</span> <span class="n">by</span> <span class="o">*</span> <span class="n">none</span>
</pre></div>
</div>
<p>生成针对账户 <em>replicator</em> 的授权文件 <em>replicator-acl-limits.ldif</em> ，其内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">olcDatabase</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">mdb</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">olcAccess</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="n">to</span> <span class="n">attrs</span><span class="o">=</span><span class="n">userPassword</span><span class="p">,</span><span class="n">shadowLastChange</span>
  <span class="n">by</span> <span class="n">dn</span><span class="o">=</span><span class="s2">"cn=Maneger,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span> <span class="n">write</span>
  <span class="n">by</span> <span class="n">dn</span><span class="o">=</span><span class="s2">"cn=readonly,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span> <span class="n">read</span>
  <span class="n">by</span> <span class="bp">self</span> <span class="n">write</span>
  <span class="n">by</span> <span class="n">anonymous</span> <span class="n">auth</span>
  <span class="n">by</span> <span class="o">*</span> <span class="n">none</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">to</span> <span class="n">dn</span><span class="o">.</span><span class="n">base</span><span class="o">=</span><span class="s2">""</span> <span class="n">by</span> <span class="o">*</span> <span class="n">read</span>
<span class="n">olcAccess</span><span class="p">:</span> <span class="p">{</span><span class="mi">2</span><span class="p">}</span><span class="n">to</span> <span class="o">*</span>
  <span class="n">by</span> <span class="n">dn</span><span class="o">=</span><span class="s2">"cn=Maneger,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span> <span class="n">write</span>
  <span class="n">by</span> <span class="n">dn</span><span class="o">=</span><span class="s2">"cn=readonly,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span> <span class="n">read</span>
  <span class="n">by</span> <span class="n">dn</span><span class="o">.</span><span class="n">exact</span><span class="o">=</span><span class="s2">"cn=replicator,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span> <span class="n">read</span>
  <span class="n">by</span> <span class="bp">self</span> <span class="n">write</span>
  <span class="n">by</span> <span class="n">anonymous</span> <span class="n">auth</span>
  <span class="n">by</span> <span class="o">*</span> <span class="k">break</span>
<span class="o">-</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcLimits</span>
<span class="n">olcLimits</span><span class="p">:</span> <span class="n">dn</span><span class="o">.</span><span class="n">exact</span><span class="o">=</span><span class="s2">"cn=replicator,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span>
  <span class="n">time</span><span class="o">.</span><span class="n">soft</span><span class="o">=</span><span class="n">unlimited</span> <span class="n">time</span><span class="o">.</span><span class="n">hard</span><span class="o">=</span><span class="n">unlimited</span>
  <span class="n">size</span><span class="o">.</span><span class="n">soft</span><span class="o">=</span><span class="n">unlimited</span> <span class="n">size</span><span class="o">.</span><span class="n">hard</span><span class="o">=</span><span class="n">unlimited</span>
</pre></div>
</div>
<p>将配置提交到服务端配置，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapmodify</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">f</span> <span class="n">replicator</span><span class="o">-</span><span class="n">acl</span><span class="o">-</span><span class="n">limits</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
</section>
<section id="id17">
<h3 id="id17">标准复制<a class="headerlink" href="#id17" title="此标题的永久链接">¶</a></h3>
<section id="id18">
<h4 id="id18">提供者节点配置<a class="headerlink" href="#id18" title="此标题的永久链接">¶</a></h4>
<p>为了采用 <strong>syncprov</strong> 实现复制，建立文件 <em>provider_simple_sync.ldif</em> ，内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add indexes to the frontend db.</span>
<span class="n">dn</span><span class="p">:</span> <span class="n">olcDatabase</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">mdb</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcDbIndex</span>
<span class="n">olcDbIndex</span><span class="p">:</span> <span class="n">entryCSN</span> <span class="n">eq</span>
<span class="o">-</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcDbIndex</span>
<span class="n">olcDbIndex</span><span class="p">:</span> <span class="n">entryUUID</span> <span class="n">eq</span>

<span class="c1"># Load the syncprov module.</span>
<span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">module</span><span class="p">{</span><span class="mi">0</span><span class="p">},</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcModuleLoad</span>
<span class="n">olcModuleLoad</span><span class="p">:</span> <span class="n">syncprov</span>

<span class="c1"># syncrepl Provider for primary db</span>
<span class="n">dn</span><span class="p">:</span> <span class="n">olcOverlay</span><span class="o">=</span><span class="n">syncprov</span><span class="p">,</span><span class="n">olcDatabase</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">mdb</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">add</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">olcOverlayConfig</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">olcSyncProvConfig</span>
<span class="n">olcOverlay</span><span class="p">:</span> <span class="n">syncprov</span>
<span class="n">olcSpCheckpoint</span><span class="p">:</span> <span class="mi">100</span> <span class="mi">10</span>
<span class="n">olcSpSessionLog</span><span class="p">:</span> <span class="mi">100</span>
</pre></div>
</div>
<p>定制化日志。上面的LDIF有一些参数，应该在将这些参数部署到目录中的生产环境之前查看这些参数。尤其是：</p>
<ul class="simple">
<li><p><strong>olcSpCheckpoint</strong> 、 <strong>olcSpSessionLog</strong> ：请参阅 <em>slapo-syncprov(5)</em> 联机帮助页。通常 <strong>olcSpSessionLog</strong> 应等于或最好大于目录中的条目数。</p></li>
</ul>
<p>将上述文件内容加入LDAP配置，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapadd</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">f</span> <span class="n">provider_simple_sync</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
</section>
<section id="id19">
<h4 id="id19">副本节点配置<a class="headerlink" href="#id19" title="此标题的永久链接">¶</a></h4>
<p>以下在副本节点 <em>admin22-02</em> 上操作。</p>
<p>参考 <a class="reference internal" href="#installpkg"><span class="std std-ref">安装所需LDAP包</span></a> 安装所需要的软件，配置基础LDAP环境。</p>
<p>启用TLS支持，创建认证信息文件 <em>certinfo.ldif</em> ，其内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcTLSCACertificateFile</span>
<span class="n">olcTLSCACertificateFile</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">mycacert</span><span class="o">.</span><span class="n">pem</span>
<span class="o">-</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcTLSCertificateFile</span>
<span class="n">olcTLSCertificateFile</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="n">_slapd_cert</span><span class="o">.</span><span class="n">pem</span>
<span class="o">-</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcTLSCertificateKeyFile</span>
<span class="n">olcTLSCertificateKeyFile</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">admin22</span><span class="o">-</span><span class="mi">02</span><span class="n">_slapd_key</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>将上述信息加入LDAP配置，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapmodify</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">f</span> <span class="n">certinfo</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
<p>测试，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapwhoami</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">ZZ</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">admin22</span><span class="o">-</span><span class="mf">02.</span><span class="n">hanhai</span><span class="o">.</span><span class="n">scc</span><span class="o">.</span><span class="n">ustc</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span>
</pre></div>
</div>
<p>如输出如下，则表示正常：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">anonymous</span>
</pre></div>
</div>
<p>增加其他节点访问数据的用户 <em>readonly</em> ，参见 <a class="reference internal" href="#getreadonly"><span class="std std-ref">生成客户端等获取用户信息的LDAP账户 readonly</span></a> 与 <a class="reference internal" href="#setacl"><span class="std std-ref">设置账户 readonly ACL只读权限</span></a> 。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>增加用户 <em>readonly</em> 的步骤务必在下面设置复制前完成，否则将无法在下面配置启用时设置（复制模式不允许）。</p>
</div>
<p>生成配置文件 <em>consumer_simple_sync.ldif</em> ，其内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">module</span><span class="p">{</span><span class="mi">0</span><span class="p">},</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcModuleLoad</span>
<span class="n">olcModuleLoad</span><span class="p">:</span> <span class="n">syncprov</span>

<span class="n">dn</span><span class="p">:</span> <span class="n">olcDatabase</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="n">mdb</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcDbIndex</span>
<span class="n">olcDbIndex</span><span class="p">:</span> <span class="n">entryUUID</span> <span class="n">eq</span>
<span class="o">-</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcSyncrepl</span>
<span class="n">olcSyncrepl</span><span class="p">:</span> <span class="n">rid</span><span class="o">=</span><span class="mi">0</span>
  <span class="n">provider</span><span class="o">=</span><span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">admin22</span><span class="o">-</span><span class="mf">01.</span><span class="n">hanhai</span><span class="o">.</span><span class="n">scc</span><span class="o">.</span><span class="n">ustc</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span>
  <span class="n">bindmethod</span><span class="o">=</span><span class="n">simple</span>
  <span class="n">binddn</span><span class="o">=</span><span class="s2">"cn=replicator,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span>
  <span class="n">credentials</span><span class="o">=</span><span class="s2">"replicatorPassword"</span>
  <span class="n">searchbase</span><span class="o">=</span><span class="s2">"dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn"</span>
  <span class="n">schemachecking</span><span class="o">=</span><span class="n">on</span>
  <span class="nb">type</span><span class="o">=</span><span class="n">refreshAndPersist</span> <span class="n">retry</span><span class="o">=</span><span class="s2">"60 +"</span>
  <span class="n">starttls</span><span class="o">=</span><span class="n">critical</span> <span class="n">tls_reqcert</span><span class="o">=</span><span class="n">demand</span>
<span class="o">-</span>
<span class="n">add</span><span class="p">:</span> <span class="n">olcUpdateRef</span>
<span class="n">olcUpdateRef</span><span class="p">:</span> <span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">admin22</span><span class="o">-</span><span class="mf">01.</span><span class="n">hanhai</span><span class="o">.</span><span class="n">scc</span><span class="o">.</span><span class="n">ustc</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span>
</pre></div>
</div>
<p>确保下面选项具有正确的值：</p>
<ul class="simple">
<li><p>provider：提供者服务节点的主机名（在本例中为 <em>admin22-01.hanhai.scc.ustc.edu.cn</em> 或IP地址），它必须与提供者的SSL证书中显示的内容相匹配</p></li>
<li><p>binddn：复制节点用户的绑定DN</p></li>
<li><p>credentials：凭据，为复制器用户选择的密码</p></li>
<li><p>searchbase：正在使用的数据库后缀，即要复制的内容</p></li>
<li><p>olcUpdateRef：提供者服务器的主机名或IP地址，如果客户端尝试写入此消费者，则提供给客户端</p></li>
<li><p>rid：Replica ID，一个唯一的3位数，用于标识副本SSSD或nslcd等）</p></li>
</ul>
<p>将上述文件内容加入LDAP配置，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapadd</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">f</span> <span class="n">consumer_simple_sync</span><span class="o">.</span><span class="n">ldif</span>
</pre></div>
</div>
<p>可以利用下面命令查看：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapsearch</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">LLL</span> <span class="o">-</span><span class="n">b</span> <span class="n">cn</span><span class="o">=</span><span class="n">config</span> <span class="s1">'(cn=module</span><span class="si">{0}</span><span class="s1">)'</span>
<span class="n">ldapsearch</span> <span class="o">-</span><span class="n">Q</span> <span class="o">-</span><span class="n">Y</span> <span class="n">EXTERNAL</span> <span class="o">-</span><span class="n">H</span> <span class="n">ldapi</span><span class="p">:</span><span class="o">///</span> <span class="o">-</span><span class="n">LLL</span> <span class="o">-</span><span class="n">b</span> <span class="n">cn</span><span class="o">=</span><span class="n">config</span> <span class="s1">'(olcDatabase=</span><span class="si">{1}</span><span class="s1">mdb)'</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>
<section id="id20">
<h1 id="id20">用户及组管理<a class="headerlink" href="#id20" title="此标题的永久链接">¶</a></h1>
<p>默认的LDAP用户、组管理等，需要详细了解LDAP的DIF格式及其命令，对于不熟悉者非常不友好。用户可以自己封装原始的LDAP命令或者采用现成的，常用的有命令行版 <strong>ldapscripts</strong> 及WEB版 <strong>LDAP Account Manager</strong> 等。</p>
<section id="ldapscripts">
<h2 id="ldapscripts">简单命令行版：ldapscripts<a class="headerlink" href="#ldapscripts" title="此标题的永久链接">¶</a></h2>
<p>安装所需要的包，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">ldapscripts</span>
</pre></div>
</div>
<p>编辑文件 <em>/etc/ldapscripts/ldapscripts.conf</em> ，其需要修改的对应部分内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SERVER</span><span class="o">=</span><span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span>
<span class="n">LDAPBINOPTS</span><span class="o">=</span><span class="s2">"-ZZ"</span>
<span class="n">BINDDN</span><span class="o">=</span><span class="s1">'cn=Maneger,dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn'</span>
<span class="n">BINDPWDFILE</span><span class="o">=</span><span class="s2">"/etc/ldapscripts/ldapscripts.passwd"</span>
<span class="n">SUFFIX</span><span class="o">=</span><span class="s1">'dc=hanhai,dc=scc,dc=ustc,dc=edu,dc=cn'</span>
<span class="n">GSUFFIX</span><span class="o">=</span><span class="s1">'ou=Groups'</span>
<span class="n">USUFFIX</span><span class="o">=</span><span class="s1">'ou=People'</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<ul class="simple">
<li><p>调整 <strong>SERVER</strong> 及 <strong>SUFFIX</strong> 选项与您的目录结构对应</p></li>
<li><p>强制这里使用 <strong>START_TLS</strong> 方式（ <em>-ZZ</em> 参数），必须配置LDAP支持TLS</p></li>
</ul>
</div>
<p>将账户 <em>cn=Maneger</em> 的密码存储到文件 <em>/etc/ldapscripts/ldapscripts.passwd</em> 。务必注意这里不能包含换行符，可以执行下面命令设置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="o">-</span><span class="n">n</span> <span class="s2">"Yourcn=ManegerPassword"</span> <span class="o">&gt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldapscripts</span><span class="o">/</span><span class="n">ldapscripts</span><span class="o">.</span><span class="n">passwd</span>
</pre></div>
</div>
<p>上述命令 <em>echo</em> 中的 <em>-n</em> 参数确保了该行后面没换行符。</p>
<p>设置普通用户不能读取密码文件，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="mi">400</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldapscripts</span><span class="o">/</span><span class="n">ldapscripts</span><span class="o">.</span><span class="n">passwd</span>
</pre></div>
</div>
<p>现在即可设置账户，如：</p>
<ul class="simple">
<li><p>创建用户组 <em>george</em> ：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapaddgroup</span> <span class="n">george</span>
</pre></div>
</div>
<ul class="simple">
<li><p>创建用户 <em>george</em> ：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapadduser</span> <span class="n">george</span> <span class="n">george</span>
</pre></div>
</div>
<ul class="simple">
<li><p>修改用户 <em>george</em> 密码：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapsetpasswd</span> <span class="n">george</span>
</pre></div>
</div>
<ul class="simple">
<li><p>删除用户 <em>george</em> ：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapdeleteuser</span> <span class="n">george</span>
</pre></div>
</div>
<ul class="simple">
<li><p>删除用户组 <em>george</em> ：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapdeletegroup</span> <span class="n">george</span>
</pre></div>
</div>
<ul class="simple">
<li><p>将用户加入另外组 <em>qa</em> ：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapaddusertogroup</span> <span class="n">george</span> <span class="n">qa</span>
</pre></div>
</div>
<ul class="simple">
<li><p>将用户 <em>george</em> 从组 <em>qa</em> 中删除：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapdeleteuserfromgroup</span> <span class="n">george</span> <span class="n">qa</span>
</pre></div>
</div>
<ul class="simple">
<li><p><em>ldapmodifyuser</em> 脚本允许增加、删除、修改用户属性，采用的是与命令 <em>ldapmodify</em> 相同的语法，执行命令：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapmodifyuser</span> <span class="n">george</span>
</pre></div>
</div>
<p>根据屏幕输出输入下面语法：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># About to modify the following entry :</span>
<span class="n">dn</span><span class="p">:</span> <span class="n">uid</span><span class="o">=</span><span class="n">george</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">account</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">posixAccount</span>
<span class="n">cn</span><span class="p">:</span> <span class="n">george</span>
<span class="n">uid</span><span class="p">:</span> <span class="n">george</span>
<span class="n">uidNumber</span><span class="p">:</span> <span class="mi">10001</span>
<span class="n">gidNumber</span><span class="p">:</span> <span class="mi">10001</span>
<span class="n">homeDirectory</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">george</span>
<span class="n">loginShell</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">gecos</span><span class="p">:</span> <span class="n">george</span>
<span class="n">description</span><span class="p">:</span> <span class="n">User</span> <span class="n">account</span>
<span class="n">userPassword</span><span class="p">::</span> <span class="n">e1NTSEF9eXFsxxxxxxxxxxF1eGUybVdFWHZKRzJVMjFTSG9vcHk</span><span class="o">=</span>

<span class="c1"># Enter your modifications here, end with CTRL-D.</span>
<span class="n">dn</span><span class="p">:</span> <span class="n">uid</span><span class="o">=</span><span class="n">george</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">gecos</span>
<span class="n">gecos</span><span class="p">:</span> <span class="n">George</span> <span class="n">Carlin</span>
</pre></div>
</div>
<ul class="simple">
<li><p><em>ldapscripts</em> 一个非常人性化的特性是可以利用模板来定制化用户、用户组等默认属性，为此需要设定使用的模板路径，如在文件 <em>/etc/ldapscripts/ldapscripts.conf</em> 中设定：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UTEMPLATE</span><span class="o">=</span><span class="s2">"/etc/ldapscripts/ldapadduser.template"</span>
</pre></div>
</div>
<p>模板可以参考目录 <em>/usr/share/doc/ldapscripts/examples/</em> 下的，如执行下述命令后再修改：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">ldapscripts</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">ldapadduser</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">sample</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ldapscripts</span><span class="o">/</span><span class="n">ldapadduser</span><span class="o">.</span><span class="n">template</span>
</pre></div>
</div>
<p>如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">uid</span><span class="o">=&lt;</span><span class="n">user</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">usuffix</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="n">suffix</span><span class="o">&gt;</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">inetOrgPerson</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">posixAccount</span>
<span class="n">cn</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">user</span><span class="o">&gt;</span>
<span class="n">sn</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ask</span><span class="o">&gt;</span>
<span class="n">uid</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">user</span><span class="o">&gt;</span>
<span class="n">uidNumber</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">uid</span><span class="o">&gt;</span>
<span class="n">gidNumber</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">gid</span><span class="o">&gt;</span>
<span class="n">homeDirectory</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">home</span><span class="o">&gt;</span>
<span class="n">loginShell</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">shell</span><span class="o">&gt;</span>
<span class="n">gecos</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">user</span><span class="o">&gt;</span>
<span class="n">description</span><span class="p">:</span> <span class="n">User</span> <span class="n">account</span>
<span class="n">title</span><span class="p">:</span> <span class="n">Employee</span>
</pre></div>
</div>
<p>其中 <strong>sn</strong> 选项的值采用 <em>&lt;ask&gt;</em> ，这将使命令 <em>ldapadduser</em> 提示您手动输入该值。</p>
</section>
<section id="web-ldap-account-manager">
<h2 id="web-ldap-account-manager">更加易用的WEB版：LDAP Account Manager<a class="headerlink" href="#web-ldap-account-manager" title="此标题的永久链接">¶</a></h2>
<p>如果普通用户不想花费时间学习命令行管理LDAP用户，那么可以采用WEB界面等，如 <a class="reference external" href="http://www.ldap-account-manager.org/">LDAP Account Manager(LAM)</a>  或 <a class="reference external" href="http://phpldapadmin.sourceforge.net/">phpLDAPadmin(PLA)</a> 。个人感觉LAM更加方便，因此该处采用LAM。</p>
<p>在主服务节点上安装所需包，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">ldap</span><span class="o">-</span><span class="n">account</span><span class="o">-</span><span class="n">manager</span>
</pre></div>
</div>
<p>修改 <em>/var/lib/ldap-account-manager/config/lam.conf</em> ，部分内容修改为如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Admins</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">Maneger</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">Passwd</span><span class="p">:</span> <span class="n">MyWebPassw0rd</span> <span class="c1">#WEB界面右上角修改配置登录密码，非Maneger密码</span>
<span class="n">tools</span><span class="p">:</span> <span class="n">treeViewSuffix</span><span class="p">:</span> <span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">defaultLanguage</span><span class="p">:</span> <span class="n">zh_CN</span><span class="o">.</span><span class="n">utf8</span>
<span class="n">types</span><span class="p">:</span> <span class="n">suffix_user</span><span class="p">:</span> <span class="n">ou</span><span class="o">=</span><span class="n">People</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">types</span><span class="p">:</span> <span class="n">suffix_group</span><span class="p">:</span> <span class="n">ou</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
</pre></div>
</div>
<p>WEB访问地址： <a class="reference external" href="http:/">http:/</a>/admin主机IP/lam/</p>
<ul class="simple">
<li><p>编辑通用设置：LDAP用户密码复杂度等，对应配置文件 <em>/etc/ldap-account-manager/config.cfg</em> 等</p></li>
<li><p>编辑服务器设置：服务器本身设置，访问LDAP服务等设置，对应配置文件 <em>/var/lib/ldap-account-manager/config/lam.conf</em> 等</p></li>
<li><p>配置导入导出：导入导出配置文件</p></li>
</ul>
</section>
</section>
<section id="id21">
<h1 id="id21">客户端设置<a class="headerlink" href="#id21" title="此标题的永久链接">¶</a></h1>
<section id="sssd">
<h2 id="sssd">SSSD简介<a class="headerlink" href="#sssd" title="此标题的永久链接">¶</a></h2>
<p>如不想每次都访问LDAP服务器获取用户信息，允许本地主机缓存用户信息提高认证速度，降低主LDAP服务器压力，可以配置系统安全服务进程SSSD(System Security Services Daemon)。</p>
</section>
<section id="id22">
<h2 id="id22">普通认证客户节点设置<a class="headerlink" href="#id22" title="此标题的永久链接">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>对于只需要从LDAP服务端获取用户信息进行认证的节点，只需要执行本节操作，其余配置都是针对LDAP服务端的。</p>
</div>
<p>安装所需要的包，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">sssd</span> <span class="n">libpam</span><span class="o">-</span><span class="n">sss</span> <span class="n">libnss</span><span class="o">-</span><span class="n">sss</span>
</pre></div>
</div>
<p>设置SSSD的配置文件 <em>/etc/sssd/sssd.conf</em> ，其内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">sssd</span><span class="p">]</span>
<span class="n">services</span> <span class="o">=</span> <span class="n">nss</span><span class="p">,</span> <span class="n">pam</span><span class="p">,</span> <span class="n">autofs</span>
<span class="n">config_file_version</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">domains</span> <span class="o">=</span> <span class="n">default</span>

<span class="p">[</span><span class="n">nss</span><span class="p">]</span>

<span class="p">[</span><span class="n">pam</span><span class="p">]</span>
<span class="n">offline_credentials_expiration</span> <span class="o">=</span> <span class="mi">60</span>

<span class="p">[</span><span class="n">domain</span><span class="o">/</span><span class="n">default</span><span class="p">]</span>
<span class="n">ldap_id_use_start_tls</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">cache_credentials</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">ldap_search_base</span> <span class="o">=</span> <span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">id_provider</span> <span class="o">=</span> <span class="n">ldap</span>
<span class="n">auth_provider</span> <span class="o">=</span> <span class="n">ldap</span>
<span class="n">chpass_provider</span> <span class="o">=</span> <span class="n">ldap</span>
<span class="c1">#access_provider = ldap</span>
<span class="n">ldap_uri</span> <span class="o">=</span> <span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">admin22</span><span class="o">-</span><span class="mf">01.</span><span class="n">hanhai</span><span class="o">.</span><span class="n">scc</span><span class="o">.</span><span class="n">ustc</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span><span class="p">,</span><span class="n">ldap</span><span class="p">:</span><span class="o">//</span><span class="n">admin22</span><span class="o">-</span><span class="mf">02.</span><span class="n">hanhai</span><span class="o">.</span><span class="n">scc</span><span class="o">.</span><span class="n">ustc</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span>
<span class="c1">#ldap_uri = ldap://admin22-01.hanhai.scc.ustc.edu.cn #如果上面只有一个主节点，应采用此行</span>
<span class="n">ldap_default_bind_dn</span> <span class="o">=</span> <span class="n">cn</span><span class="o">=</span><span class="n">readonly</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">hanhai</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">scc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ustc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">edu</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">cn</span>
<span class="n">ldap_default_authtok_type</span> <span class="o">=</span> <span class="n">password</span>
<span class="n">ldap_default_authtok</span> <span class="o">=</span> <span class="n">readonlypassword</span>
<span class="n">ldap_tls_reqcert</span> <span class="o">=</span> <span class="n">demand</span>
<span class="n">ldap_tls_cacert</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">mycacert</span><span class="o">.</span><span class="n">pem</span>
<span class="n">ldap_tls_cacertdir</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span>
<span class="n">ldap_search_timeout</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">ldap_network_timeout</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">ldap_access_order</span> <span class="o">=</span> <span class="nb">filter</span>
<span class="c1">#ldap_access_filter = (objectClass=posixAccount)</span>
</pre></div>
</div>
<p>复制LDAP主节点上的文件 <em>/etc/ssl/certs/mycacert.pem</em> 到本地文件 <em>/etc/ssl/certs/mycacert.pem</em> ，也可以类似主节点实际文件为 <em>/usr/local/share/ca-certificates/mycacert.crt</em> ，并生成软链接： <em>/etc/ssl/certs/mycacert.pem</em> ，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scp</span> <span class="n">admin22</span><span class="o">-</span><span class="mi">01</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span><span class="o">/</span><span class="n">mycacert</span><span class="o">.</span><span class="n">crt</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span><span class="o">/</span><span class="n">mycacert</span><span class="o">.</span><span class="n">crt</span>
<span class="n">update</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">certificates</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>上面需要在文件 <em>/etc/hosts</em> 中设定主机 <em>admin22-01</em> 对应的LDAP服务端的IP地址。</p>
</div>
<p>为使得用户登录时自动生成用户主目录，设置PAM认证文件 <em>/etc/pam.d/common-session</em> ，在 <strong>session optional  pam_sss.so</strong> 下一行添加：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span> <span class="n">required</span>    <span class="n">pam_mkhomedir</span><span class="o">.</span><span class="n">so</span> <span class="n">skel</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">skel</span><span class="o">/</span> <span class="n">umask</span><span class="o">=</span><span class="mi">0077</span>
</pre></div>
</div>
<p>设置文件 <em>/etc/sssd/sssd.conf</em> 权限（不允许普通账户查看），执行：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="mi">600</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sssd</span><span class="o">/</span><span class="n">sssd</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>重启SSSD服务，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">sssd</span>
</pre></div>
</div>
<p>利用 <em>id</em> 等命令可以测试账户是否成功，如装了sssd-tools工具，可以利用命令 <em>sss_cache -E</em> 清除sssd用户信息缓存。</p>
</section>
</section>
<section id="id23">
<h1 id="id23">参考资料<a class="headerlink" href="#id23" title="此标题的永久链接">¶</a></h1>
<ul class="simple">
<li><p>Ubuntu 22.04 Server：<a class="reference external" href="https://ubuntu.com/server/docs/service-ldap-introduction">https://ubuntu.com/server/docs/service-ldap-introduction</a></p></li>
<li><p>Configure SSSD for LDAP Authentication on Ubuntu 22.04：<a class="reference external" href="https://kifarunix.com/configure-sssd-for-ldap-authentication-on-ubuntu-22-04/">https://kifarunix.com/configure-sssd-for-ldap-authentication-on-ubuntu-22-04/</a></p></li>
<li><p>openldap介绍和使用：<a class="reference external" href="https://www.cnblogs.com/woshimrf/p/ldap.html">https://www.cnblogs.com/woshimrf/p/ldap.html</a></p></li>
</ul>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="index.html" title="Ubuntu 22.04下的LDAP认证服务及客户端设置"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> Ubuntu 22.04下的LDAP认证服务及客户端设置 </span>
              </div>
            </a>
          
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2022, 李会民，中国科学技术大学超级计算中心(http://scc.ustc.edu.cn).
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>