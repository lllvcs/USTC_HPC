
<!DOCTYPE html>

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="_static/javascripts/modernizr.js"></script>
  
  
  
    <title>1. Slurm简介 &#8212; Slurm资源管理与作业调度系统安装配置 2021-12 文档</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/material.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/translations.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="7. 联系方式" href="contact.html" />
    <link rel="prev" title="Slurm资源管理与作业调度系统安装配置" href="index.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=#4000FF data-md-color-accent=light-blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#slurm-install" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="index.html" title="Slurm资源管理与作业调度系统安装配置 2021-12 文档"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Slurm资源管理与作业调度系统安装配置</span>
          <span class="md-header-nav__topic"> 1. Slurm简介 </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://git.ustc.edu.cn/hmli/slurm-install" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Slurm资源管理与作业调度系统安装配置源码git
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = ""versions.json"",
        target_loc = "../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">Slurm资源管理与作业调度系统安装配置 2021-12 文档</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="index.html" title="Slurm资源管理与作业调度系统安装配置 2021-12 文档" class="md-nav__button md-logo">
      
        <img src="_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="index.html"
       title="Slurm资源管理与作业调度系统安装配置 2021-12 文档">Slurm资源管理与作业调度系统安装配置</a>
  </label>
    <div class="md-nav__source">
      <a href="https://git.ustc.edu.cn/hmli/slurm-install" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Slurm资源管理与作业调度系统安装配置源码git
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Contents:</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    <label class="md-nav__link md-nav__link--active" for="__toc"> 1. Slurm简介 </label>
    
      <a href="#" class="md-nav__link md-nav__link--active">1. Slurm简介</a>
      
        
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#slurm-install--page-root" class="md-nav__link">1. Slurm简介</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id1" class="md-nav__link">1.1. 用途</a>
        </li>
        <li class="md-nav__item"><a href="#id2" class="md-nav__link">1.2. 架构</a>
        </li>
        <li class="md-nav__item"><a href="#id3" class="md-nav__link">1.3. 术语</a>
        </li>
        <li class="md-nav__item"><a href="#id4" class="md-nav__link">1.4. 插件</a>
        </li>
        <li class="md-nav__item"><a href="#id5" class="md-nav__link">1.5. 配置模式</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id6" class="md-nav__link">2. 规划准备</a>
        </li>
        <li class="md-nav__item"><a href="#id7" class="md-nav__link">3. 编译安装slurm</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id8" class="md-nav__link">3.1. 安装编译slurm所需的依赖包</a>
        </li>
        <li class="md-nav__item"><a href="#id9" class="md-nav__link">3.2. 下载Slurm源码包</a>
        </li>
        <li class="md-nav__item"><a href="#rpm" class="md-nav__link">3.3. 编译成RPM包</a>
        </li>
        <li class="md-nav__item"><a href="#id10" class="md-nav__link">3.4. 不同节点类型所需安装包</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id11" class="md-nav__link">4. 管理节点操作（也为其它节点配置）</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#slurmyum" class="md-nav__link">4.1. 设置Slurm的YUM软件仓库</a>
        </li>
        <li class="md-nav__item"><a href="#id12" class="md-nav__link">4.2. 安装所需slurm包</a>
        </li>
        <li class="md-nav__item"><a href="#id13" class="md-nav__link">4.3. 生成slurm用户</a>
        </li>
        <li class="md-nav__item"><a href="#munge" class="md-nav__link">4.4. 设置通讯所需的munge服务</a>
        </li>
        <li class="md-nav__item"><a href="#id14" class="md-nav__link">4.5. 设置主配置文件</a>
        </li>
        <li class="md-nav__item"><a href="#cgroup" class="md-nav__link">4.6. 设置cgroup限制</a>
        </li>
        <li class="md-nav__item"><a href="#mariadb-mysql" class="md-nav__link">4.7. 设置mariadb(MySQL)数据库</a>
        </li>
        <li class="md-nav__item"><a href="#slurmctld" class="md-nav__link">4.8. 重启slurmctld服务</a>
        </li>
        <li class="md-nav__item"><a href="#slurmd" class="md-nav__link">4.9. 计算节点和用户登录节点设置slurmd服务</a>
        </li>
        <li class="md-nav__item"><a href="#id15" class="md-nav__link">4.10. 设置记账账户和用户</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id16" class="md-nav__link">5. 高级功能</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#gpu" class="md-nav__link">5.1. GPU等资源配置</a>
        </li>
        <li class="md-nav__item"><a href="#qos" class="md-nav__link">5.2. 服务质量(QOS)配置</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id17" class="md-nav__link">5.2.1. 作业调度优先级</a>
        </li>
        <li class="md-nav__item"><a href="#id18" class="md-nav__link">5.2.2. 作业抢占</a>
        </li>
        <li class="md-nav__item"><a href="#id19" class="md-nav__link">5.2.3. 作业限制</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id20" class="md-nav__link">5.2.3.1. 资源限制</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id21" class="md-nav__link">5.2.3.1.1. 层级</a>
        </li>
        <li class="md-nav__item"><a href="#id22" class="md-nav__link">5.2.3.1.2. 设置</a>
        </li>
        <li class="md-nav__item"><a href="#id23" class="md-nav__link">5.2.3.1.3. 工具</a>
        </li>
        <li class="md-nav__item"><a href="#id24" class="md-nav__link">5.2.3.1.4. 关配置联和QOS中的限制</a>
        </li>
        <li class="md-nav__item"><a href="#id25" class="md-nav__link">5.2.3.1.5. 支持的关联指定调度策略</a>
        </li>
        <li class="md-nav__item"><a href="#id26" class="md-nav__link">5.2.3.1.6. 支持的QOS特定限制</a>
        </li>
        <li class="md-nav__item"><a href="#gres" class="md-nav__link">5.2.3.1.7. 具体GRES限制</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id27" class="md-nav__link">5.2.4. 队列QOS</a>
        </li>
        <li class="md-nav__item"><a href="#id28" class="md-nav__link">5.2.5. 其它QOS选项</a>
        </li>
        <li class="md-nav__item"><a href="#id29" class="md-nav__link">5.2.6. 配置</a>
        </li>
        <li class="md-nav__item"><a href="#id30" class="md-nav__link">5.2.7. QOS常见操作例子</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id31" class="md-nav__link">6. 日常操作</a>
        </li>
  </ul>
</nav>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#id1" class="md-nav__link">1.1. 用途</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id2" class="md-nav__link">1.2. 架构</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id3" class="md-nav__link">1.3. 术语</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id4" class="md-nav__link">1.4. 插件</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id5" class="md-nav__link">1.5. 配置模式</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id6" class="md-nav__link">2. 规划准备</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id7" class="md-nav__link">3. 编译安装slurm</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#id8" class="md-nav__link">3.1. 安装编译slurm所需的依赖包</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id9" class="md-nav__link">3.2. 下载Slurm源码包</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#rpm" class="md-nav__link">3.3. 编译成RPM包</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id10" class="md-nav__link">3.4. 不同节点类型所需安装包</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id11" class="md-nav__link">4. 管理节点操作（也为其它节点配置）</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#slurmyum" class="md-nav__link">4.1. 设置Slurm的YUM软件仓库</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id12" class="md-nav__link">4.2. 安装所需slurm包</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id13" class="md-nav__link">4.3. 生成slurm用户</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#munge" class="md-nav__link">4.4. 设置通讯所需的munge服务</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id14" class="md-nav__link">4.5. 设置主配置文件</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#cgroup" class="md-nav__link">4.6. 设置cgroup限制</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#mariadb-mysql" class="md-nav__link">4.7. 设置mariadb(MySQL)数据库</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#slurmctld" class="md-nav__link">4.8. 重启slurmctld服务</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#slurmd" class="md-nav__link">4.9. 计算节点和用户登录节点设置slurmd服务</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id15" class="md-nav__link">4.10. 设置记账账户和用户</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id16" class="md-nav__link">5. 高级功能</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#gpu" class="md-nav__link">5.1. GPU等资源配置</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#qos" class="md-nav__link">5.2. 服务质量(QOS)配置</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#id17" class="md-nav__link">5.2.1. 作业调度优先级</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id18" class="md-nav__link">5.2.2. 作业抢占</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id19" class="md-nav__link">5.2.3. 作业限制</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id27" class="md-nav__link">5.2.4. 队列QOS</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id28" class="md-nav__link">5.2.5. 其它QOS选项</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id29" class="md-nav__link">5.2.6. 配置</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id30" class="md-nav__link">5.2.7. QOS常见操作例子</a>
      
    
    </li></ul>
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#id31" class="md-nav__link">6. 日常操作</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="contact.html" class="md-nav__link">7. 联系方式</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#slurm-install--page-root" class="md-nav__link">1. Slurm简介</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id1" class="md-nav__link">1.1. 用途</a>
        </li>
        <li class="md-nav__item"><a href="#id2" class="md-nav__link">1.2. 架构</a>
        </li>
        <li class="md-nav__item"><a href="#id3" class="md-nav__link">1.3. 术语</a>
        </li>
        <li class="md-nav__item"><a href="#id4" class="md-nav__link">1.4. 插件</a>
        </li>
        <li class="md-nav__item"><a href="#id5" class="md-nav__link">1.5. 配置模式</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id6" class="md-nav__link">2. 规划准备</a>
        </li>
        <li class="md-nav__item"><a href="#id7" class="md-nav__link">3. 编译安装slurm</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id8" class="md-nav__link">3.1. 安装编译slurm所需的依赖包</a>
        </li>
        <li class="md-nav__item"><a href="#id9" class="md-nav__link">3.2. 下载Slurm源码包</a>
        </li>
        <li class="md-nav__item"><a href="#rpm" class="md-nav__link">3.3. 编译成RPM包</a>
        </li>
        <li class="md-nav__item"><a href="#id10" class="md-nav__link">3.4. 不同节点类型所需安装包</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id11" class="md-nav__link">4. 管理节点操作（也为其它节点配置）</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#slurmyum" class="md-nav__link">4.1. 设置Slurm的YUM软件仓库</a>
        </li>
        <li class="md-nav__item"><a href="#id12" class="md-nav__link">4.2. 安装所需slurm包</a>
        </li>
        <li class="md-nav__item"><a href="#id13" class="md-nav__link">4.3. 生成slurm用户</a>
        </li>
        <li class="md-nav__item"><a href="#munge" class="md-nav__link">4.4. 设置通讯所需的munge服务</a>
        </li>
        <li class="md-nav__item"><a href="#id14" class="md-nav__link">4.5. 设置主配置文件</a>
        </li>
        <li class="md-nav__item"><a href="#cgroup" class="md-nav__link">4.6. 设置cgroup限制</a>
        </li>
        <li class="md-nav__item"><a href="#mariadb-mysql" class="md-nav__link">4.7. 设置mariadb(MySQL)数据库</a>
        </li>
        <li class="md-nav__item"><a href="#slurmctld" class="md-nav__link">4.8. 重启slurmctld服务</a>
        </li>
        <li class="md-nav__item"><a href="#slurmd" class="md-nav__link">4.9. 计算节点和用户登录节点设置slurmd服务</a>
        </li>
        <li class="md-nav__item"><a href="#id15" class="md-nav__link">4.10. 设置记账账户和用户</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id16" class="md-nav__link">5. 高级功能</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#gpu" class="md-nav__link">5.1. GPU等资源配置</a>
        </li>
        <li class="md-nav__item"><a href="#qos" class="md-nav__link">5.2. 服务质量(QOS)配置</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id17" class="md-nav__link">5.2.1. 作业调度优先级</a>
        </li>
        <li class="md-nav__item"><a href="#id18" class="md-nav__link">5.2.2. 作业抢占</a>
        </li>
        <li class="md-nav__item"><a href="#id19" class="md-nav__link">5.2.3. 作业限制</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id20" class="md-nav__link">5.2.3.1. 资源限制</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id21" class="md-nav__link">5.2.3.1.1. 层级</a>
        </li>
        <li class="md-nav__item"><a href="#id22" class="md-nav__link">5.2.3.1.2. 设置</a>
        </li>
        <li class="md-nav__item"><a href="#id23" class="md-nav__link">5.2.3.1.3. 工具</a>
        </li>
        <li class="md-nav__item"><a href="#id24" class="md-nav__link">5.2.3.1.4. 关配置联和QOS中的限制</a>
        </li>
        <li class="md-nav__item"><a href="#id25" class="md-nav__link">5.2.3.1.5. 支持的关联指定调度策略</a>
        </li>
        <li class="md-nav__item"><a href="#id26" class="md-nav__link">5.2.3.1.6. 支持的QOS特定限制</a>
        </li>
        <li class="md-nav__item"><a href="#gres" class="md-nav__link">5.2.3.1.7. 具体GRES限制</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id27" class="md-nav__link">5.2.4. 队列QOS</a>
        </li>
        <li class="md-nav__item"><a href="#id28" class="md-nav__link">5.2.5. 其它QOS选项</a>
        </li>
        <li class="md-nav__item"><a href="#id29" class="md-nav__link">5.2.6. 配置</a>
        </li>
        <li class="md-nav__item"><a href="#id30" class="md-nav__link">5.2.7. QOS常见操作例子</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id31" class="md-nav__link">6. 日常操作</a>
        </li>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="slurm">
<h1 id="slurm-install--page-root"><span class="section-number">1. </span>Slurm简介<a class="headerlink" href="#slurm-install--page-root" title="此标题的永久链接">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>该文档基于 <strong>Slurm 21.08</strong> 及 <strong>CentOS 7.9 x86_64</strong> ，除非特殊说明，所有命令均采用 <strong>root</strong> 用户在命令行终端下执行。</p>
</div>
<section id="id1">
<h2 id="id1"><span class="section-number">1.1. </span>用途<a class="headerlink" href="#id1" title="此标题的永久链接">¶</a></h2>
<p>Slurm(Simple Linux Utility for Resource Management， <a class="reference external" href="http://slurm.schedmd.com/">http://slurm.schedmd.com/</a> )是开源的、具有容错性和高度可扩展的Linux集群超级计算系统资源管理和作业调度系统。超级计算系统可利用Slurm对资源和作业进行管理，以避免相互干扰，提高运行效率。所有需运行的作业，无论是用于程序调试还是业务计算，都可以通过交互式并行 <code class="docutils literal notranslate"><span class="pre">srun</span></code> 、批处理式 <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> 或分配式 <code class="docutils literal notranslate"><span class="pre">salloc</span></code> 等命令提交，提交后可以利用相关命令查询作业状态等。</p>
</section>
<section id="id2">
<h2 id="id2"><span class="section-number">1.2. </span>架构<a class="headerlink" href="#id2" title="此标题的永久链接">¶</a></h2>
<p>Slurm采用slurmctld服务（守护进程）作为中心管理器用于监测资源和作业，为了提高可用性，还可以配置另一个备份冗余管理器。各计算节点需启动slurmd守护进程，以便被用于作为远程shell使用：等待作业、执行作业、返回状态、再等待更多作业。slurmdbd(Slurm DataBase Daemon)数据库守护进程（非必需，建议采用，也可以记录到纯文本中等），可以将多个slurm管理的集群的记账信息记录在同一个数据库中。还可以启用slurmrestd(Slurm REST API Daemon)服务（非必需），该服务可以通过REST API与Slurm进行交互，所有功能都对应的API。用户工具包含 <code class="docutils literal notranslate"><span class="pre">srun</span></code> 运行作业、 <code class="docutils literal notranslate"><span class="pre">scancel</span></code> 终止排队中或运行中的作业、 <code class="docutils literal notranslate"><span class="pre">sinfo</span></code> 查看系统状态、 <code class="docutils literal notranslate"><span class="pre">squeue</span></code> 查看作业状态、 <code class="docutils literal notranslate"><span class="pre">sacct</span></code> 查看运行中或结束了的作业及作业步信息等命令。 <code class="docutils literal notranslate"><span class="pre">sview</span></code> 命令可以图形化显示系统和作业状态（可含有网络拓扑）。 <code class="docutils literal notranslate"><span class="pre">scontrol</span></code> 作为管理工具，可以监控、修改集群的配置和状态信息等。用于管理数据库的命令是 <code class="docutils literal notranslate"><span class="pre">sacctmgr</span></code> ，可认证集群、有效用户、有效记账账户等。</p>
<a class="reference internal image-reference" href="_images/arch.gif"><img alt="_images/arch.gif" class="align-center" src="_images/arch.gif" style="width: 400px;"/></a>
</section>
<section id="id3">
<h2 id="id3"><span class="section-number">1.3. </span>术语<a class="headerlink" href="#id3" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>节点</dt><dd><ul>
<li><p>Hea Node：头节点、管理节点、控制节点，运行slurmctld管理服务的节点。</p></li>
<li><p>Compute Node：计算节点，运行作业计算任务的节点，需运行slurmd服务。</p></li>
<li><p>Login Node：用户登录节点，用于用户登录的节点。</p></li>
<li><p>SlurmDBD Node：SlurmDBD节点、SlurmDBD数据库节点，存储调度策略、记账和作业等信息的节点，需运行slurmdbd服务。</p></li>
<li><p>客户节点：含计算节点和用户登录节点。</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>用户</dt><dd><ul>
<li><p>account：账户，一个账户可以含有多个用户。</p></li>
<li><p>user：用户，多个用户可以共享一个账户。</p></li>
<li><p>bank account：银行账户，对应机时费等。</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>资源</dt><dd><ul>
<li><p>GRES：Generic Resource，通用资源。</p></li>
<li><p>TRES：Trackable RESources，可追踪资源。</p></li>
<li><p>QOS：Quality of Service，服务质量，作业优先级。</p></li>
<li><p>association：关联。可利用其实现，如用户的关联不在数据库中，这将阻止用户运行作业。该选项可以阻止用户访问无效账户。</p></li>
<li><p>Partition：队列、分区。用于对计算节点、作业并行规模、作业时长、用户等进行分组管理，以合理分配资源。</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="id4">
<h2 id="id4"><span class="section-number">1.4. </span>插件<a class="headerlink" href="#id4" title="此标题的永久链接">¶</a></h2>
<p>Slurm含有一些通用目的插件可以使用，采用这些插件可以方便地支持多种基础结构，允许利用构建块方式吸纳多种Slurm配置，主要包括如下插件：</p>
<blockquote>
<div><ul class="simple">
<li><p>记账存储(Accounting Storage)：主要用于存储作业历史数据。当采用SlurmDBD时，可以支持有限的基于系统的历史系统状态。</p></li>
<li><p>账户收集能源(Account Gather Energy)：收集系统中每个作业或节点的能源（电力）消耗，该插件与记账存储Accounting Storage和作业记账收集Job Account Gather插件一起使用。</p></li>
<li><p>通信认证(Authentication of communications)：提供在Slurm不同组件之间进行认证机制。</p></li>
<li><p>容器(Containers)：HPC作业负载容器支持及实现。</p></li>
<li><p>信用(Credential，数字签名生成，Digital Signature Generation)：用于生成电子签名的机制，可用于验证作业步在某节点上具有执行权限。与用于身份验证的插件不同，因为作业步请求从用户的 <code class="docutils literal notranslate"><span class="pre">srun</span></code> 命令发送，而不是直接从slurmctld守护进程发送，该守护进程将生成作业步凭据及其数字签名。</p></li>
<li><p>通用资源(Generic Resources)：提供用于控制通用资源（如GPU）的接口。</p></li>
<li><p>作业提交(Job Submit)：该插件提供特殊控制，以允许站点覆盖作业在提交和更新时提出的需求。</p></li>
<li><p>作业记账收集(Job Accounting Gather)：收集作业步资源使用数据。</p></li>
<li><p>作业完成记录(Job Completion Logging)：记录作业完成数据，一般是记账存储插件的子数据集。</p></li>
<li><p>启动器(Launchers)：控制srun启动任务时的机制。</p></li>
<li><p>MPI：针对多种MPI实现提供不同钩子，可用于设置MPI环境变量等。</p></li>
<li><p>抢占(Preempt)：决定哪些作业可以抢占其它作业以及所采用的抢占机制。</p></li>
<li><p>优先级(Priority)：在作业提交时赋予作业优先级，且在运行中生效（如，它们生命期）。</p></li>
<li><p>进程追踪(Process tracking，为了信号控制)：提供用于确认各作业关联的进程，可用于作业记账及信号控制。</p></li>
<li><p>调度器(Scheduler)：用于决定Slurm何时及如何调度作业的插件。</p></li>
<li><p>节点选择(Node selection)：用于决定作业分配的资源插件。</p></li>
<li><p>站点因子(Site Factor，站点优先级)：将作业多因子组件中的特殊的site_factor优先级在作业提交时赋予作业，且在运行中生效（如，它们生命期）。</p></li>
<li><p>交换及互联(Switch or interconnect)：用于网络交换和互联接口的插件。对于多数网络系统（以太网或InifiniBand）并不需要。</p></li>
<li><p>作业亲和性(Task Affinity)：提供一种用于将作业和其独立的任务绑定到特定处理器的机制。</p></li>
<li><p>网络拓扑(Network Topology)：基于网络拓扑提供资源选择优化，用于作业分配和提前预留资源。</p></li>
</ul>
</div></blockquote>
</section>
<section id="id5">
<h2 id="id5"><span class="section-number">1.5. </span>配置模式<a class="headerlink" href="#id5" title="此标题的永久链接">¶</a></h2>
<p>Slurm客户节点配置，有两种模式：</p>
<blockquote>
<div><ul class="simple">
<li><p>传统模式：客户节点采用 <strong>/etc/slurm/</strong> 目录下的 <strong>slurm.conf</strong> 等配置文件进行配置。</p></li>
<li><p>无配置(configless)模式：客户节点无需配置 <strong>/etc/slurm</strong> 目录下相应的配置文件。</p></li>
</ul>
</div></blockquote>
<p>无配置模式是Slurm的一项新特性（从20.02版起支持），可以允许计算节点和用户登录节点从slurmctld守护进程获取配置而无需采用 <strong>/etc/slurm</strong> 等目录下的本地配置文件。集群在Slurm控制节点上统一控制配置文件，计算节点、登录节点和其它集群节点只需通过 <strong>/lib/systemd/system/slurmd.service</strong> 文件配置slurmd服务启动参数，利用启动后的slurmd服务获取所需配置信息即可，而无需复制管理节点上的这些文件成为本地文件（降低文件配置不一样的风险）。支持的配置文件有：</p>
<blockquote>
<div><ul class="simple">
<li><p>slurm.conf</p></li>
<li><p>acct_gather.conf</p></li>
<li><p>cgroup.conf</p></li>
<li><p>cgroup_allowed_devices_file.conf</p></li>
<li><p>cli_filter.lua</p></li>
<li><p>ext_sensors.conf</p></li>
<li><p>gres.conf</p></li>
<li><p>helpers.conf</p></li>
<li><p>job_container.conf</p></li>
<li><p>knl_cray.conf</p></li>
<li><p>knl_generic.conf</p></li>
<li><p>oci.conf</p></li>
<li><p>plugstack.conf</p></li>
<li><p>topology.conf</p></li>
</ul>
</div></blockquote>
<p>slurmd服务启动时将从指定的slurmctld节点获取配置文件，slurmctld节点可以采用 <code class="docutils literal notranslate"><span class="pre">--conf-server</span></code> 参数准确指定或利用DNS SRV记录指定，采用 <code class="docutils literal notranslate"><span class="pre">--conf-server</span></code> 参数指定的优先级高于采用DNS SRV记录指定：</p>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>采用 <code class="docutils literal notranslate"><span class="pre">--conf-server</span></code> 参数指定（默认端口6817可省略）：</dt><dd><ul>
<li><p>仅一个管理节点slurmctl-primary： <code class="docutils literal notranslate"><span class="pre">slurmd</span> <span class="pre">--conf-server</span> <span class="pre">slurmctl-primary:6817</span></code></p></li>
<li><p>一个管理节点slurmctl-primary和一个备份节点slurmctl-secondary： <code class="docutils literal notranslate"><span class="pre">slurmd</span> <span class="pre">--conf-server</span> <span class="pre">slurmctl-primary:6817,slurmctl-secondary</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>采用DNS SRV记录：</dt><dd><ul>
<li><p>_slurmctld._tcp 3600 IN SRV 10 0 6817 slurmctl-backup</p></li>
<li><p>_slurmctld._tcp 3600 IN SRV  0 0 6817 slurmctl-primary</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>参见： <a class="reference external" href="https://slurm.schedmd.com/configless_slurm.html">无配置(configless)模式</a></p>
</section>
</section>
<section id="id6">
<h1 id="id6"><span class="section-number">2. </span>规划准备<a class="headerlink" href="#id6" title="此标题的永久链接">¶</a></h1>
<ul>
<li><p>集群名：MyCluster</p></li>
<li><dl>
<dt>管理节点admin：</dt><dd><ul>
<li><p>内网IP：191.168.1.254</p></li>
<li><p><strong>/opt/</strong> 目录：通过NFS网络共享给其它节点使用</p></li>
<li><p>配置文件： <strong>/etc/slurm/</strong> 目录下的 <strong>cgroup.conf</strong> 、 <strong>slurm.conf</strong> 、 <strong>slurmdbd.conf</strong> 等文件</p></li>
<li><p>需要启动（按顺序）的守护进程服务：</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>通信认证：munge</p></li>
<li><p>系统数据库：mariadb（也可采用文本保存，更简单，本文不涉及）</p></li>
<li><p>Slurm数据库：slurmdbd</p></li>
<li><p>主控管理器：slurmctld</p></li>
</ol>
</div></blockquote>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>数据库节点（运行slurmdbd服务）admin：</dt><dd><ul class="simple">
<li><p>可与管理节点共用，本文档与管理节点共用</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>用户登录节点login：</dt><dd><ul class="simple">
<li><p>内网IP：191.168.1.250</p></li>
<li><p><strong>/opt/</strong> 目录：通过NFS服务共享管理节点上的 <strong>/opt/</strong> 目录</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>计算节点node[1-10]：</dt><dd><ul class="simple">
<li><p>内网IP：191.168.1.[1-10]</p></li>
<li><p><strong>/opt/</strong> 目录：通过NFS服务共享管理节点上的 <strong>/opt/</strong> 目录</p></li>
<li><dl class="simple">
<dt>需要启动（按顺序）的服务：</dt><dd><ol class="arabic simple">
<li><p>通信认证：munge</p></li>
<li><p>Slurm数据库：slurmdbd</p></li>
</ol>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>各节点node[1-10],login：</dt><dd><ul class="simple">
<li><p>admin节点root用户可以通过密钥无需输入密码ssh进入各节点</p></li>
<li><p>安装好munge包</p></li>
<li><p>配置有NIS或LDAP等用户信息服务同步admin节点用户信息（管理节点建立slurm用户后，各节点执行 <code class="docutils literal notranslate"><span class="pre">id</span> <span class="pre">slurm</span></code> 可确认其slurm用户是否存在）</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>并行操作：</p>
<blockquote>
<div><p>各节点执行同样命令可以利用 <a class="reference external" href="https://computing.llnl.gov/linux/pdsh.html">pdsh</a> 命令或for循环处理：</p>
<ul>
<li><p>如需安装PDSH并行shell包，可利用源 <a class="reference external" href="http://mirrors.ustc.edu.cn/epel/">http://mirrors.ustc.edu.cn/epel/</a> 进行安装配置。</p></li>
<li><p>在node[1-10]节点执行 <cite>id slurm</cite> 可用下述命令之一：</p>
<blockquote>
<div><ul class="simple">
<li><p>pdsh： <code class="docutils literal notranslate"><span class="pre">pdsh</span> <span class="pre">-w</span> <span class="pre">node[1-10]</span> <span class="pre">id</span> <span class="pre">slurm</span></code></p></li>
<li><p>for循环： <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">`seq</span> <span class="pre">1</span> <span class="pre">10`;</span> <span class="pre">do</span> <span class="pre">ssh</span> <span class="pre">node$i</span> <span class="pre">id</span> <span class="pre">slurm;</span> <span class="pre">done</span></code></p></li>
</ul>
</div></blockquote>
</li>
<li><p>复制 <cite>/etc/hosts</cite> 文件到node[1-3,5,7-10]节点 <cite>/etc</cite> 目录下可执行下述命令之一：</p>
<blockquote>
<div><ul class="simple">
<li><p>pdsh： <code class="docutils literal notranslate"><span class="pre">pdcp</span> <span class="pre">-w</span> <span class="pre">node[1-3,5,7-10]</span> <span class="pre">/etc/hosts</span> <span class="pre">/etc</span></code></p></li>
<li><p>for循环： <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">`seq</span> <span class="pre">1</span> <span class="pre">10`;</span> <span class="pre">do</span> <span class="pre">scp</span> <span class="pre">-a</span> <span class="pre">/etc/hosts</span> <span class="pre">node$i:/etc/;</span> <span class="pre">done</span></code></p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p>管理服务的常用命令（以slurmd为例）：</p>
<blockquote>
<div><ul class="simple">
<li><p>设置开机自启动服务： <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">enable</span> <span class="pre">slurmd</span></code></p></li>
<li><p>启动服务： <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">slurmd</span></code></p></li>
<li><p>重新启动服务： <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">restart</span> <span class="pre">slurmd</span></code></p></li>
<li><p>停止服务： <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">stop</span> <span class="pre">slurmd</span></code></p></li>
<li><p>查看服务状态及出错信息： <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">slurmd</span></code></p></li>
<li><p>查看服务日志： <code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">-xe</span></code></p></li>
</ul>
</div></blockquote>
</li>
</ul>
</section>
<section id="id7">
<h1 id="id7"><span class="section-number">3. </span>编译安装slurm<a class="headerlink" href="#id7" title="此标题的永久链接">¶</a></h1>
<p>可以采用第三方已编译好的RPM或DEB包进行安装，也可以采用源码编译方式。</p>
<p>可以在安装有所需的依赖包的任何节点处理，本例在管理节点进行。</p>
<section id="id8">
<h2 id="id8"><span class="section-number">3.1. </span>安装编译slurm所需的依赖包<a class="headerlink" href="#id8" title="此标题的永久链接">¶</a></h2>
<p>安装编译Slurm时所需软件包，执行：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">mariadb</span> <span class="n">mariadb</span><span class="o">-</span><span class="n">devel</span> <span class="n">mariadb</span><span class="o">-</span><span class="n">server</span> <span class="n">munge</span> <span class="n">munge</span><span class="o">-</span><span class="n">libs</span> <span class="n">munge</span><span class="o">-</span><span class="n">devel</span> <span class="n">hwloc</span><span class="o">-</span><span class="n">libs</span> <span class="n">hwloc</span><span class="o">-</span><span class="n">devel</span> <span class="n">hdf5</span><span class="o">-</span><span class="n">devel</span> <span class="n">pam</span><span class="o">-</span><span class="n">devel</span> <span class="n">perl</span><span class="o">-</span><span class="n">ExtUtils</span><span class="o">-</span><span class="n">MakeMaker</span> <span class="n">python3</span> <span class="n">readline</span><span class="o">-</span><span class="n">devel</span> <span class="n">kernel</span><span class="o">-</span><span class="n">headers</span> <span class="n">dbus</span><span class="o">-</span><span class="n">devel</span> <span class="n">rpm</span><span class="o">-</span><span class="n">build</span>
</pre></div>
</div>
</section>
<section id="id9">
<h2 id="id9"><span class="section-number">3.2. </span>下载Slurm源码包<a class="headerlink" href="#id9" title="此标题的永久链接">¶</a></h2>
<p>访问 <a class="reference external" href="https://www.schedmd.com/downloads.php">https://www.schedmd.com/downloads.php</a> 复制所需版本下载源码包链接后，执行：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">schedmd</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">slurm</span><span class="o">/</span><span class="n">slurm</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">bz2</span>
</pre></div>
</div>
</section>
<section id="rpm">
<h2 id="rpm"><span class="section-number">3.3. </span>编译成RPM包<a class="headerlink" href="#rpm" title="此标题的永久链接">¶</a></h2>
<p>在 <strong>slurm-21.08.2.tar.bz2</strong> 文件所在目录执行（如有必要改变生成包的内容，可以提前设置 <strong>~/.rpmmacros</strong> 文件）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rpmbuild</span> <span class="o">-</span><span class="n">ta</span> <span class="n">slurm</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">bz2</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<ul class="simple">
<li><p>如提示缺少库、包等，请安装对应的包后再执行上面命令。</p></li>
<li><p>如所依赖的包安装的不全，上述命令即使没有报错，能生成RPM包，也有可能所需的功能没有。</p></li>
</ul>
</div>
<p>成功后将在 <strong>/root/rpmbuild/RPMS/x86_64/</strong> 目录下生成类似如下RPM文件：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">slurm</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">-</span><span class="mf">1.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">slurm</span><span class="o">-</span><span class="n">libpmi</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">-</span><span class="mf">1.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">slurm</span><span class="o">-</span><span class="n">slurmctld</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">-</span><span class="mf">1.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">slurm</span><span class="o">-</span><span class="n">contribs</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">-</span><span class="mf">1.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">slurm</span><span class="o">-</span><span class="n">openlava</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">-</span><span class="mf">1.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">slurm</span><span class="o">-</span><span class="n">slurmd</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">-</span><span class="mf">1.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">slurm</span><span class="o">-</span><span class="n">devel</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">-</span><span class="mf">1.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">slurm</span><span class="o">-</span><span class="n">pam_slurm</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">-</span><span class="mf">1.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">slurm</span><span class="o">-</span><span class="n">slurmdbd</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">-</span><span class="mf">1.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">slurm</span><span class="o">-</span><span class="n">example</span><span class="o">-</span><span class="n">configs</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">-</span><span class="mf">1.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">slurm</span><span class="o">-</span><span class="n">perlapi</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">-</span><span class="mf">1.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
<span class="n">slurm</span><span class="o">-</span><span class="n">torque</span><span class="o">-</span><span class="mf">21.08.2</span><span class="o">-</span><span class="mf">1.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
</pre></div>
</div>
</section>
<section id="id10">
<h2 id="id10"><span class="section-number">3.4. </span>不同节点类型所需安装包<a class="headerlink" href="#id10" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>管理节点(Head Node，运行slurmctld服务)、计算节点(Compute Node)和用户登录节点(Login Node)：</dt><dd><ul>
<li><p>slurm</p></li>
<li><p>slurm-perlapi</p></li>
<li><p>slurm-slurmctld（仅管理节点需要）</p></li>
<li><p>slurm-slurmd（仅计算节点需要，用户登录节点如采用无配置模式，则也需要）</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>SlurmDBD节点：</dt><dd><ul>
<li><p>slurm</p></li>
<li><p>slurm-slurmdbd</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
</section>
<section id="id11">
<h1 id="id11"><span class="section-number">4. </span>管理节点操作（也为其它节点配置）<a class="headerlink" href="#id11" title="此标题的永久链接">¶</a></h1>
<section id="slurmyum">
<h2 id="slurmyum"><span class="section-number">4.1. </span>设置Slurm的YUM软件仓库<a class="headerlink" href="#slurmyum" title="此标题的永久链接">¶</a></h2>
<blockquote>
<div><p>可以将前面生成的RPM通过NFS服务共享或直接复制到各节点，然后执行 <code class="docutils literal notranslate"><span class="pre">yum</span> <span class="pre">localinstall</span> <span class="pre">包文件名</span></code> 命令安装，或采用下面建立YUM软件仓库后直接用包名方式安装。</p>
<ul class="simple">
<li><p>建立YUM仓库目录：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">slurm</span>
</pre></div>
</div>
<ul class="simple">
<li><p>复制前面生成的RPM文件到 <strong>/opt/src/slurm/</strong> 目录：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">rpmbuild</span><span class="o">/</span><span class="n">RPMS</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/*.</span><span class="n">rpm</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">slurm</span><span class="o">/</span>
</pre></div>
</div>
<ul>
<li><p>建立YUM仓库RPM文件索引：</p>
<blockquote>
<div><ul class="simple">
<li><p>在 <strong>/opt/src/slurm/</strong> 目录下运行 <code class="docutils literal notranslate"><span class="pre">createrepo</span> <span class="pre">.</span></code> 命令生成仓库索引。</p></li>
<li><p>生成repo配置文件，执行命令：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&gt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">slurm</span><span class="o">.</span><span class="n">repo</span><span class="o">&lt;&lt;</span><span class="n">EOF</span>
<span class="p">[</span><span class="n">slurm</span><span class="p">]</span>
<span class="n">name</span><span class="o">=</span><span class="n">slurm</span>
<span class="n">baseurl</span><span class="o">=</span><span class="n">file</span><span class="p">:</span><span class="o">///</span><span class="n">opt</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">slurm</span>
<span class="n">gpgcheck</span><span class="o">=</span><span class="mi">0</span>
<span class="n">enable</span><span class="o">=</span><span class="mi">1</span>
<span class="n">EOF</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>为其它节点设置YUM仓库</p></li>
</ul>
<p>将上述 <strong>/etc/yum.repos.d/slurm.repo</strong> 文件复制到所有需安装slurm的节点 <strong>/etc/yum.repos.d/</strong> 目录下，执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdcp</span> <span class="o">-</span><span class="n">w</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">login</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">slurm</span><span class="o">.</span><span class="n">repo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id12">
<h2 id="id12"><span class="section-number">4.2. </span>安装所需slurm包<a class="headerlink" href="#id12" title="此标题的永久链接">¶</a></h2>
<p>以下命令仍旧在管理节点执行。</p>
<blockquote>
<div><ul class="simple">
<li><p>管理节点，执行：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">slurm</span> <span class="n">slurm</span><span class="o">-</span><span class="n">perlapi</span> <span class="n">slurm</span><span class="o">-</span><span class="n">slurmdbd</span> <span class="n">slurm</span><span class="o">-</span><span class="n">slurmctld</span>
</pre></div>
</div>
<ul class="simple">
<li><p>为计算节点和用户登录节点，执行：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdsh</span> <span class="o">-</span><span class="n">w</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">login</span> <span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">slurm</span> <span class="n">slurm</span><span class="o">-</span><span class="n">perlapi</span> <span class="n">slurm</span><span class="o">-</span><span class="n">slurmd</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id13">
<h2 id="id13"><span class="section-number">4.3. </span>生成slurm用户<a class="headerlink" href="#id13" title="此标题的永久链接">¶</a></h2>
<p>Slurm需要有一个用户用于进行通信、认证等操作，这里用户名为slurm（也可为其它名字）：</p>
<blockquote>
<div><ul class="simple">
<li><p>生成用户，执行：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">useradd</span> <span class="n">slurm</span>
</pre></div>
</div>
<ul class="simple">
<li><p>其它节点配置有NIS或LDAP等用户信息管理系统，自动从管理节点获取slurm用户信息（无需再单独生成slurm用户），执行以下命令确认是否存在（如未存在，请检查相关服务）：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdsh</span> <span class="o">-</span><span class="n">w</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">login</span> <span class="nb">id</span> <span class="n">slurm</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="munge">
<h2 id="munge"><span class="section-number">4.4. </span>设置通讯所需的munge服务<a class="headerlink" href="#munge" title="此标题的永久链接">¶</a></h2>
<p>munge为slurm默认的验证机制，各节点 <strong>/etc/munge/munge.key</strong> 的内容需要一致，且所有者都为munge用户。</p>
<blockquote>
<div><blockquote>
<div><ul class="simple">
<li><p>为各节点安装munge包：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdsh</span> <span class="o">-</span><span class="n">w</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">login</span> <span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">munge</span>
</pre></div>
</div>
<ul class="simple">
<li><p>生成 <strong>/etc/munge/munge.key</strong> ，执行命令：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">create</span><span class="o">-</span><span class="n">munge</span><span class="o">-</span><span class="n">key</span>
</pre></div>
</div>
<ul class="simple">
<li><p>将生成的 <strong>/etc/munge/munge.key</strong> 复制成各节点 <strong>/etc/munge/munge.key</strong> ：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdcp</span> <span class="o">-</span><span class="n">w</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">login</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">munge</span><span class="o">/</span><span class="n">munge</span><span class="o">.</span><span class="n">key</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">munge</span><span class="o">/</span>
</pre></div>
</div>
<ul class="simple">
<li><p>设置各节点 <code class="docutils literal notranslate"><span class="pre">/etc/munge/munge.key</span></code> 的所有者为munge用户：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdsh</span> <span class="o">-</span><span class="n">w</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">login</span> <span class="n">chown</span> <span class="n">munge</span><span class="o">.</span><span class="n">munge</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">munge</span><span class="o">/</span><span class="n">munge</span><span class="o">.</span><span class="n">key</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>设置各节点开机自动启动munge服务（enable选项），且现在就启动服务（–now参数）：</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdsh</span> <span class="o">-</span><span class="n">w</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">login</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="o">--</span><span class="n">now</span> <span class="n">munge</span>
</pre></div>
</div>
<p>以上也可以分成两个命令执行：</p>
<blockquote>
<div><ul class="simple">
<li><p>设置开机自启动</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdsh</span> <span class="o">-</span><span class="n">w</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">login</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">munge</span>
</pre></div>
</div>
<ul class="simple">
<li><p>重新启动</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdsh</span> <span class="o">-</span><span class="n">w</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">login</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">munge</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</section>
<section id="id14">
<h2 id="id14"><span class="section-number">4.5. </span>设置主配置文件<a class="headerlink" href="#id14" title="此标题的永久链接">¶</a></h2>
<p>Slurm配置文件主要在 <strong>/etc/slurm/</strong> 目录下。</p>
<ul class="simple">
<li><p>主配置文件：<strong>/etc/slurm/slurm.conf</strong> ：</p></li>
</ul>
<p>内容模板可访问 <a class="reference external" href="https://slurm.schedmd.com/configurator.html">https://slurm.schedmd.com/configurator.html</a> 填写相应信息生成，然后修改：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cluster Name：集群名</span>
 <span class="n">ClusterName</span><span class="o">=</span><span class="n">MyCluster</span> <span class="c1"># 集群名，任意英文和数字名字</span>

<span class="c1"># Control Machines：Slurmctld控制进程节点</span>
 <span class="n">SlurmctldHost</span><span class="o">=</span><span class="n">admin</span> <span class="c1"># 启动slurmctld进程的节点名，如这里的admin</span>
 <span class="n">BackupController</span><span class="o">=</span>   <span class="c1"># 冗余备份节点，可空着</span>
 <span class="n">SlurmctldParameters</span><span class="o">=</span><span class="n">enable_configless</span> <span class="c1"># 采用无配置模式</span>

 <span class="c1"># Slurm User：Slurm用户</span>
 <span class="n">SlurmUser</span><span class="o">=</span><span class="n">slurm</span> <span class="c1"># slurmctld启动时采用的用户名</span>

 <span class="c1"># Slurm Port Numbers：Slurm服务通信端口</span>
 <span class="n">SlurmctldPort</span><span class="o">=</span><span class="mi">6817</span> <span class="c1"># Slurmctld服务端口，设为6817，如不设置，默认为6817号端口</span>
 <span class="n">SlurmdPort</span><span class="o">=</span><span class="mi">6818</span>    <span class="c1"># Slurmd服务端口，设为6818，如不设置，默认为6818号端口</span>

 <span class="c1"># State Preservation：状态保持</span>
 <span class="n">StateSaveLocation</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">slurmctld</span> <span class="c1"># 存储slurmctld服务状态的目录，如有备份控制节点，则需要所有SlurmctldHost节点都能共享读写该目录</span>
 <span class="n">SlurmdSpoolDir</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">slurmd</span> <span class="c1"># Slurmd服务所需要的目录，为各节点各自私有目录，不得多个slurmd节点共享</span>

 <span class="n">ReturnToService</span><span class="o">=</span><span class="mi">1</span> <span class="c1">#设定当DOWN（失去响应）状态节点如何恢复服务，默认为0。</span>
     <span class="c1"># 0: 节点状态保持DOWN状态，只有当管理员明确使其恢复服务时才恢复</span>
     <span class="c1"># 1: 仅当由于无响应而将DOWN节点设置为DOWN状态时，才可以当有效配置注册后使DOWN节点恢复服务。如节点由于任何其它原因（内存不足、意外重启等）被设置为DOWN，其状态将不会自动更改。当节点的内存、GRES、CPU计数等等于或大于slurm.conf中配置的值时，该节点才注册为有效配置。</span>
     <span class="c1"># 2: 使用有效配置注册后，DOWN节点将可供使用。该节点可能因任何原因被设置为DOWN状态。当节点的内存、GRES、CPU计数等等于或大于slurm.conf 中配置的值，该节点才注册为有效配置。￼</span>

 <span class="c1"># Default MPI Type：默认MPI类型</span>
 <span class="n">MPIDefault</span><span class="o">=</span><span class="kc">None</span>
     <span class="c1"># MPI-PMI2: 对支持PMI2的MPI实现</span>
     <span class="c1"># MPI-PMIx: Exascale PMI实现</span>
     <span class="c1"># None: 对于大多数其它MPI，建议设置</span>

 <span class="c1"># Process Tracking：进程追踪，定义用于确定特定的作业所对应的进程的算法，它使用信号、杀死和记账与作业步相关联的进程</span>
 <span class="n">ProctrackType</span><span class="o">=</span><span class="n">proctrack</span><span class="o">/</span><span class="n">cgroup</span>
     <span class="c1"># Cgroup: 采用Linux cgroup来生成作业容器并追踪进程，需要设定/etc/slurm/cgroup.conf文件</span>
     <span class="c1"># Cray XC: 采用Cray XC专有进程追踪</span>
     <span class="c1"># LinuxProc: 采用父进程IP记录，进程可以脱离Slurm控制</span>
     <span class="c1"># Pgid: 采用Unix进程组ID(Process Group ID)，进程如改变了其进程组ID则可以脱离Slurm控制</span>

 <span class="c1"># Scheduling：调度</span>
 <span class="c1"># DefMemPerCPU=0 # 默认每颗CPU可用内存，以MB为单位，0为不限制。如果将单个处理器分配给作业（SelectType=select/cons_res 或 SelectType=select/cons_tres），通常会使用DefMemPerCPU</span>
 <span class="c1"># MaxMemPerCPU=0 # 最大每颗CPU可用内存，以MB为单位，0为不限制。如果将单个处理器分配给作业（SelectType=select/cons_res 或 SelectType=select/cons_tres），通常会使用MaxMemPerCPU</span>
 <span class="c1"># SchedulerTimeSlice=30 # 当GANG调度启用时的时间片长度，以秒为单位</span>
 <span class="n">SchedulerType</span><span class="o">=</span><span class="n">sched</span><span class="o">/</span><span class="n">backfill</span> <span class="c1"># 要使用的调度程序的类型。注意，slurmctld守护程序必须重新启动才能使调度程序类型的更改生效（重新配置正在运行的守护程序对此参数无效）。如果需要，可以使用scontrol命令手动更改作业优先级。可接受的类型为：</span>
     <span class="c1"># sched/backfill # 用于回填调度模块以增加默认FIFO调度。如这样做不会延迟任何较高优先级作业的预期启动时间，则回填调度将启动较低优先级作业。回填调度的有效性取决于用户指定的作业时间限制，否则所有作业将具有相同的时间限制，并且回填是不可能的。注意上面SchedulerParameters选项的文档。这是默认配置</span>
     <span class="c1"># sched/builtin # 按优先级顺序启动作业的FIFO调度程序。如队列中的任何作业无法调度，则不会调度该队列中优先级较低的作业。对于作业的一个例外是由于队列限制（如时间限制）或关闭/耗尽节点而无法运行。在这种情况下，可以启动较低优先级的作业，而不会影响较高优先级的作业。</span>
     <span class="c1"># sched/hold # 如果 /etc/slurm.hold 文件存在，则暂停所有新提交的作业，否则使用内置的FIFO调度程序。</span>

 <span class="c1"># Resource Selection：资源选择，定义作业资源（节点）选择算法</span>
 <span class="n">SelectType</span><span class="o">=</span><span class="n">select</span><span class="o">/</span><span class="n">cons_tres</span>
     <span class="c1"># select/cons_tres: 单个的CPU核、内存、GPU及其它可追踪资源作为可消费资源（消费及分配），建议设置</span>
     <span class="c1"># select/cons_res: 单个的CPU核和内存作为可消费资源</span>
     <span class="c1"># select/cray_aries: 对于Cray系统</span>
     <span class="c1"># select/linear: 基于主机的作为可消费资源，不管理单个CPU等的分配</span>

 <span class="c1"># SelectTypeParameters：资源选择类型参数，当SelectType=select/linear时仅支持CR_ONE_TASK_PER_CORE和CR_Memory；当SelectType=select/cons_res、SelectType=select/cray_aries和SelectType=select/cons_tres时，默认采用CR_Core_Memory</span>
 <span class="n">SelectTypeParameters</span><span class="o">=</span><span class="n">CR_Core_Memory</span>
     <span class="c1"># CR_CPU: CPU核数作为可消费资源</span>
     <span class="c1"># CR_Socket: 整颗CPU作为可消费资源</span>
     <span class="c1"># CR_Core: CPU核作为可消费资源，默认</span>
     <span class="c1"># CR_Memory: 内存作为可消费资源，CR_Memory假定MaxShare大于等于1</span>
     <span class="c1"># CR_CPU_Memory: CPU和内存作为可消费资源</span>
     <span class="c1"># CR_Socket_Memory: 整颗CPU和内存作为可消费资源</span>
     <span class="c1"># CR_Core_Memory: CPU和和内存作为可消费资源</span>

 <span class="c1"># Task Launch：任务启动</span>
 <span class="n">TaskPlugin</span><span class="o">=</span><span class="n">task</span><span class="o">/</span><span class="n">cgroup</span><span class="p">,</span><span class="n">task</span><span class="o">/</span><span class="n">affinity</span> <span class="c1">#设定任务启动插件。可被用于提供节点内的资源管理（如绑定任务到特定处理器），TaskPlugin值可为:</span>
     <span class="c1"># task/affinity: CPU亲和支持（man srun查看其中--cpu-bind、--mem-bind和-E选项）</span>
     <span class="c1"># task/cgroup: 强制采用Linux控制组cgroup分配资源（man group.conf查看帮助）</span>
     <span class="c1"># task/none: #无任务启动动作</span>

 <span class="c1"># Prolog and Epilog：前处理及后处理</span>
 <span class="c1"># Prolog/Epilog: 完整的绝对路径，在用户作业开始前(Prolog)或结束后(Epilog)在其每个运行节点上都采用root用户执行，可用于初始化某些参数、清理作业运行后的可删除文件等</span>
 <span class="c1"># Prolog=/opt/bin/prolog.sh # 作业开始运行前需要执行的文件，采用root用户执行</span>
 <span class="c1"># Epilog=/opt/bin/epilog.sh # 作业结束运行后需要执行的文件，采用root用户执行</span>

 <span class="c1"># SrunProlog/Epilog # 完整的绝对路径，在用户作业步开始前(SrunProlog)或结束后(Epilog)在其每个运行节点上都被srun执行，这些参数可以被srun的--prolog和--epilog选项覆盖</span>
 <span class="c1"># SrunProlog=/opt/bin/srunprolog.sh # 在srun作业开始运行前需要执行的文件，采用运行srun命令的用户执行</span>
 <span class="c1"># SrunEpilog=/opt/bin/srunepilog.sh # 在srun作业结束运行后需要执行的文件，采用运行srun命令的用户执行</span>

 <span class="c1"># TaskProlog/Epilog: 绝对路径，在用户任务开始前(Prolog)和结束后(Epilog)在其每个运行节点上都采用运行作业的用户身份执行</span>
 <span class="c1"># TaskProlog=/opt/bin/taskprolog.sh # 作业开始运行前需要执行的文件，采用运行作业的用户执行</span>
 <span class="c1"># TaskEpilog=/opt/bin/taskepilog.sh # 作业结束后需要执行的文件，采用运行作业的用户执行行</span>

 <span class="c1"># 顺序：</span>
    <span class="c1"># 1. pre_launch_priv()：TaskPlugin内部函数</span>
    <span class="c1"># 2. pre_launch()：TaskPlugin内部函数</span>
    <span class="c1"># 3. TaskProlog：slurm.conf中定义的系统范围每个任务</span>
    <span class="c1"># 4. User prolog：作业步指定的，采用srun命令的--task-prolog参数或SLURM_TASK_PROLOG环境变量指定</span>
    <span class="c1"># 5. Task：作业步任务中执行</span>
    <span class="c1"># 6. User epilog：作业步指定的，采用srun命令的--task-epilog参数或SLURM_TASK_EPILOG环境变量指定</span>
    <span class="c1"># 7. TaskEpilog：slurm.conf中定义的系统范围每个任务</span>
    <span class="c1"># 8. post_term()：TaskPlugin内部函数</span>

 <span class="c1"># Event Logging：事件记录</span>
 <span class="c1"># Slurmctld和slurmd守护进程可以配置为采用不同级别的详细度记录，从0（不记录）到7（极度详细）</span>
 <span class="n">SlurmctldDebug</span><span class="o">=</span><span class="n">info</span> <span class="c1"># 默认为info</span>
 <span class="n">SlurmctldLogFile</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">slurm</span><span class="o">/</span><span class="n">slurmctld</span><span class="o">.</span><span class="n">log</span> <span class="c1"># 如是空白，则记录到syslog</span>
 <span class="n">SlurmdDebug</span><span class="o">=</span><span class="n">info</span> <span class="c1"># 默认为info</span>
 <span class="n">SlurmdLogFile</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">slurm</span><span class="o">/</span><span class="n">slurmd</span><span class="o">.</span><span class="n">log</span> <span class="c1"># 如为空白，则记录到syslog，如名字中的有字符串"%h"，则"%h"将被替换为节点名</span>

 <span class="c1"># Job Completion Logging：作业完成记录</span>
 <span class="n">JobCompType</span><span class="o">=</span><span class="n">jobcomp</span><span class="o">/</span><span class="n">mysql</span>
 <span class="c1"># 指定作业完成是采用的记录机制，默认为None，可为以下值之一:</span>
    <span class="c1"># None: 不记录作业完成信息</span>
    <span class="c1"># Elasticsearch: 将作业完成信息记录到Elasticsearch服务器</span>
    <span class="c1"># FileTxt: 将作业完成信息记录在一个纯文本文件中</span>
    <span class="c1"># Lua: 利用名为jobcomp.lua的文件记录作业完成信息</span>
    <span class="c1"># Script: 采用任意脚本对原始作业完成信息进行处理后记录</span>
    <span class="c1"># MySQL: 将完成状态写入MySQL或MariaDB数据库</span>

 <span class="c1"># JobCompLoc= # 设定记录作业完成信息的文本文件位置（若JobCompType=filetxt），或将要运行的脚本（若JobCompType=script），或Elasticsearch服务器的URL（若JobCompType=elasticsearch），或数据库名字（JobCompType为其它值时）</span>

 <span class="c1"># 设定数据库在哪里运行，且如何连接</span>
 <span class="n">JobCompHost</span><span class="o">=</span><span class="n">localhost</span> <span class="c1"># 存储作业完成信息的数据库主机名</span>
 <span class="c1"># JobCompPort= # 存储作业完成信息的数据库服务器监听端口</span>
 <span class="n">JobCompUser</span><span class="o">=</span><span class="n">slurm</span> <span class="c1"># 用于与存储作业完成信息数据库进行对话的用户名</span>
 <span class="n">JobCompPass</span><span class="o">=</span><span class="n">SomePassWD</span> <span class="c1"># 用于与存储作业完成信息数据库进行对话的用户密码</span>

 <span class="c1"># Job Accounting Gather：作业记账收集</span>
 <span class="n">JobAcctGatherType</span><span class="o">=</span><span class="n">jobacct_gather</span><span class="o">/</span><span class="n">linux</span> <span class="c1"># Slurm记录每个作业消耗的资源，JobAcctGatherType值可为以下之一：</span>
    <span class="c1"># jobacct_gather/none: 不对作业记账</span>
    <span class="c1"># jobacct_gather/cgroup: 收集Linux cgroup信息</span>
    <span class="c1"># jobacct_gather/linux: 收集Linux进程表信息，建议</span>
 <span class="n">JobAcctGatherFrequency</span><span class="o">=</span><span class="mi">30</span> <span class="c1"># 设定轮寻间隔，以秒为单位。若为-，则禁止周期性抽样</span>

 <span class="c1"># Job Accounting Storage：作业记账存储</span>
 <span class="n">AccountingStorageType</span><span class="o">=</span><span class="n">accounting_storage</span><span class="o">/</span><span class="n">slurmdbd</span> <span class="c1"># 与作业记账收集一起，Slurm可以采用不同风格存储可以以许多不同的方式存储会计信息，可为以下值之一：</span>
     <span class="c1"># accounting_storage/none: 不记录记账信息</span>
     <span class="c1"># accounting_storage/slurmdbd: 将作业记账信息写入Slurm DBD数据库</span>
 <span class="c1"># AccountingStorageLoc: 设定文件位置或数据库名，为完整绝对路径或为数据库的数据库名，当采用slurmdb时默认为slurm_acct_db</span>

 <span class="c1"># 设定记账数据库信息，及如何连接</span>
 <span class="n">AccountingStorageHost</span><span class="o">=</span><span class="n">localhost</span> <span class="c1"># 记账数据库主机名</span>
 <span class="c1"># AccountingStoragePort= # 记账数据库服务监听端口</span>
 <span class="c1"># AccountingStorageUser=slurm # 记账数据库用户名</span>
 <span class="c1"># AccountingStoragePass=SomePassWD # 记账数据库用户密码。对于SlurmDBD，提供企业范围的身份验证，如采用于Munge守护进程，则这是应该用munge套接字socket名（/var/run/munge/global.socket.2）代替。默认不设置</span>
 <span class="c1"># AccountingStoreFlags= # 以逗号（,）分割的列表。选项是：</span>
     <span class="c1"># job_comment：在数据库中存储作业说明域</span>
     <span class="c1"># job_script：在数据库中存储脚本</span>
     <span class="c1"># job_env：存储批处理作业的环境变量</span>
 <span class="c1"># AccountingStorageTRES=gres/gpu # 设置GPU时需要</span>
 <span class="c1"># GresTypes=gpu # 设置GPU时需要</span>

 <span class="c1"># Process ID Logging：进程ID记录，定义记录守护进程的进程ID的位置</span>
 <span class="n">SlurmctldPidFile</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">slurmctld</span><span class="o">.</span><span class="n">pid</span> <span class="c1"># 存储slurmctld进程号PID的文件</span>
 <span class="n">SlurmdPidFile</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">slurmd</span><span class="o">.</span><span class="n">pid</span> <span class="c1"># 存储slurmd进程号PID的文件</span>

 <span class="c1"># Timers：定时器</span>
 <span class="n">SlurmctldTimeout</span><span class="o">=</span><span class="mi">120</span> <span class="c1"># 设定备份控制器在主控制器等待多少秒后成为激活的控制器</span>
 <span class="n">SlurmdTimeout</span><span class="o">=</span><span class="mi">300</span> <span class="c1"># Slurm控制器等待slurmd未响应请求多少秒后将该节点状态设置为DOWN</span>
 <span class="n">InactiveLimit</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># 潜伏期控制器等待srun命令响应多少秒后，将在考虑作业或作业步骤不活动并终止它之前。0表示无限长等待</span>
 <span class="n">MinJobAge</span><span class="o">=</span><span class="mi">300</span> <span class="c1"># Slurm控制器在等待作业结束多少秒后清理其记录</span>
 <span class="n">KillWait</span><span class="o">=</span><span class="mi">30</span> <span class="c1"># 在作业到达其时间限制前等待多少秒后在发送SIGKILLL信号之前发送TERM信号以优雅地终止</span>
 <span class="n">WaitTime</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># 在一个作业步的第一个任务结束后等待多少秒后结束所有其它任务，0表示无限长等待</span>

 <span class="c1"># Compute Machines：计算节点</span>
 <span class="n">NodeName</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span> <span class="n">NodeAddr</span><span class="o">=</span><span class="mf">192.168.1</span><span class="o">.</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span> <span class="n">CPUs</span><span class="o">=</span><span class="mi">48</span> <span class="n">RealMemory</span><span class="o">=</span><span class="mi">192000</span> <span class="n">Sockets</span><span class="o">=</span><span class="mi">2</span> <span class="n">CoresPerSocket</span><span class="o">=</span><span class="mi">24</span> <span class="n">ThreadsPerCore</span><span class="o">=</span><span class="mi">1</span> <span class="n">State</span><span class="o">=</span><span class="n">UNKNOWN</span>
 <span class="c1"># NodeName=gnode[01-10] Gres=gpu:v100:2 CPUs=40 RealMemory=385560 Sockets=2 CoresPerSocket=20 ThreadsPerCore=1 State=UNKNOWN #GPU节点例子，主要为Gres=gpu:v100:2</span>
     <span class="c1"># NodeName=node[1-10] # 计算节点名，node[1-10]表示为从node1、node2连续编号到node10，其余类似</span>
     <span class="c1"># NodeAddr=192.168.1.[1-10] # 计算节点IP</span>
     <span class="c1"># CPUs=48 # 节点内CPU核数，如开着超线程，则按照2倍核数计算，其值为：Sockets*CoresPerSocket*ThreadsPerCore</span>
     <span class="c1"># RealMemory=192000 # 节点内作业可用内存数(MB)，一般不大于free -m的输出，当启用select/cons_res插件限制内存时使用</span>
     <span class="c1"># Sockets=2 # 节点内CPU颗数</span>
     <span class="c1"># CoresPerSocket=24 # 每颗CPU核数</span>
     <span class="c1"># ThreadsPerCore=1 # 每核逻辑线程数，如开了超线程，则为2</span>
     <span class="c1"># State=UNKNOWN # 状态，是否启用，State可以为以下之一：</span>
         <span class="c1"># CLOUD   # 在云上存在</span>
         <span class="c1"># DOWN    # 节点失效，不能分配给在作业</span>
         <span class="c1"># DRAIN   # 节点不能分配给作业</span>
         <span class="c1"># FAIL    # 节点即将失效，不能接受分配新作业</span>
         <span class="c1"># FAILING # 节点即将失效，但上面有作业未完成，不能接收新作业</span>
         <span class="c1"># FUTURE  # 节点为了将来使用，当Slurm守护进程启动时设置为不存在，可以之后采用scontrol命令简单地改变其状态，而不是需要重启slurmctld守护进程。当这些节点有效后，修改slurm.conf中它们的State。在它们被设置为有效前，采用Slurm看不到它们，也尝试与其联系。</span>
               <span class="c1"># 动态未来节点(Dynamic Future Nodes)：</span>
                  <span class="c1"># slurmd启动时如有-F[&lt;feature&gt;]参数，将关联到一个与slurmd -C命令显示配置(sockets、cores、threads)相同的配置的FUTURE节点。节点的NodeAddr和NodeHostname从slurmd守护进程自动获取，并且当被设置为FUTURE状态后自动清除。动态未来节点在重启时保持non-FUTURE状态。利用scontrol可以将其设置为FUTURE状态。</span>
                  <span class="c1"># 若NodeName与slurmd的HostName映射未通过DNS更新，动态未来节点不知道在之间如何进行通信，其原因在于NodeAddr和NodeHostName未在slurm.conf被定义，而且扇出通信(fanout communication)需要通过将TreeWidth设置为一个较高的数字（如65533）来使其无效。若做了DNS映射，则可以使用cloud_dns SlurmctldParameter。</span>
          <span class="c1"># UNKNOWN # 节点状态未被定义，但将在节点上启动slurmd进程后设置为BUSY或IDLE，该为默认值。</span>

 <span class="n">PartitionName</span><span class="o">=</span><span class="n">batch</span> <span class="n">Nodes</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span> <span class="n">Default</span><span class="o">=</span><span class="n">YES</span> <span class="n">MaxTime</span><span class="o">=</span><span class="n">INFINITE</span> <span class="n">State</span><span class="o">=</span><span class="n">UP</span>
     <span class="c1"># PartitionName=batch # 队列分区名</span>
     <span class="c1"># Nodes=node[1-10] # 节点名</span>
     <span class="c1"># Default=Yes # 作为默认队列，运行作业不知明队列名时采用的队列</span>
     <span class="c1"># MaxTime=INFINITE # 作业最大运行时间，以分钟为单位，INFINITE表示为无限制</span>
     <span class="c1"># State=UP # 状态，是否启用</span>
     <span class="c1"># Gres=gpu:v100:2 # 设置节点有两块v100 GPU卡，需要在GPU节点 /etc/slum/gres.conf 文件中有类似下面配置：</span>
         <span class="c1">#AutoDetect=nvml</span>
         <span class="n">Name</span><span class="o">=</span><span class="n">gpu</span> <span class="n">Type</span><span class="o">=</span><span class="n">v100</span> <span class="n">File</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvidia</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#设置资源的名称Name是gpu，类型Type为v100，名称与类型可以任意取，但需要与其它方面配置对应，File=/dev/nvidia[0-1]指明了使用的GPU设备。</span>
         <span class="c1">#Name=mps Count=100</span>
</pre></div>
</div>
<ul class="simple">
<li><p>数据存储方式配置文件 <strong>slurmdbd.conf</strong> ：</p></li>
</ul>
<p>仅启动slurmdbd节点需要。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 认证信息</span>
<span class="n">AuthType</span><span class="o">=</span><span class="n">auth</span><span class="o">/</span><span class="n">munge</span> <span class="c1"># 认证方式，该处采用munge进行认证</span>
<span class="n">AuthInfo</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">munge</span><span class="o">/</span><span class="n">munge</span><span class="o">.</span><span class="n">socket</span><span class="mf">.2</span> <span class="c1"># 为了与slurmctld控制节点通信的其它认证信息</span>
<span class="c1">#</span>
<span class="c1"># slurmDBD信息</span>
<span class="n">DbdHost</span><span class="o">=</span><span class="n">localhost</span> <span class="c1"># 数据库节点名</span>
<span class="n">DbdAddr</span><span class="o">=</span><span class="mf">127.0.0.1</span> <span class="c1"># 数据库IP地址</span>
<span class="c1"># DbdBackupHost=admin2 # 数据库冗余备份节点</span>
<span class="c1"># DbdPort=7031 # 数据库端口号，默认为7031</span>
<span class="n">SlurmUser</span><span class="o">=</span><span class="n">slurm</span> <span class="c1"># 用户数据库操作的用户</span>
<span class="n">MessageTimeout</span><span class="o">=</span><span class="mi">60</span> <span class="c1"># 允许以秒为单位完成往返通信的时间，默认为10秒</span>

<span class="n">DebugLevel</span><span class="o">=</span><span class="n">debug5</span> <span class="c1"># 调试信息级别，quiet：无调试信息；fatal：仅严重错误信息；error：仅错误信息； info：错误与通常信息；verbose：错误和详细信息；debug：错误、详细和调试信息；debug2：错误、详细和更多调试信息；debug3：错误、详细和甚至更多调试信息；debug4：错误、详细和甚至更多调试信息；debug5：错误、详细和甚至更多调试信息。debug数字越大，信息越详细</span>
<span class="n">DefaultQOS</span><span class="o">=</span><span class="n">normal</span> <span class="c1"># 默认QOS</span>
<span class="n">LogFile</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">slurm</span><span class="o">/</span><span class="n">slurmdbd</span><span class="o">.</span><span class="n">log</span> <span class="c1"># slurmdbd守护进程日志文件绝对路径</span>
<span class="n">PidFile</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">slurmdbd</span><span class="o">.</span><span class="n">pid</span> <span class="c1"># slurmdbd守护进程存储进程号文件绝对路径</span>
<span class="c1"># PrivateData=accounts,users,usage,jobs # 对于普通用户隐藏的数据。默认所有信息对所有用户开放，SlurmUser、root和AdminLevel=Admin用户可以查看所有信息。多个值可以采用逗号（,）分割：</span>
    <span class="c1"># accounts：阻止用户查看账户信息，除非该用户是他们的协调人</span>
    <span class="c1"># events：阻止用户查看事件信息，除非该用户具有操作员或更高级身份</span>
    <span class="c1"># jobs：阻止普户查看其他用户的作业信息，除非该用户是使用 sacct 时运行作业的帐户的协调员。</span>
    <span class="c1"># reservations：限制具有操作员及以上身份的用户获取资源预留信息。￼</span>
    <span class="c1"># usage：阻止用户查看其他用户利用率。适用于sreport命令</span>
    <span class="c1"># users：阻止用户查看除自己以外的任何用户的信息，使得用户只能看到他们处理的关联。协调人可以看到他们作为协调人的帐户中所有用户的关联，但只有在列出用户时才能看到自己。</span>

<span class="c1">#TrackWCKey=yes # 工作负载特征键。用于设置Workload Characterization Key的显示和跟踪。必须设置为跟踪wckey的使用。这必须设置为从WCKeys生成汇总使用表。注意：如果在此处设置TrackWCKey而不是在您的各种slurm.conf文件中，则所有作业都将归因于它们的默认WCKey。</span>
<span class="c1">#</span>
<span class="c1"># Database信息，详细解释参见前面slurm.conf中的</span>
<span class="n">StorageType</span><span class="o">=</span><span class="n">accounting_storage</span><span class="o">/</span><span class="n">mysql</span> <span class="c1"># 数据存储类型</span>
<span class="n">StorageHost</span><span class="o">=</span><span class="n">localhost</span> <span class="c1"># 存储数据库节点名</span>
<span class="n">StorageLoc</span><span class="o">=</span><span class="n">slurm_acct_db</span> <span class="c1"># 存储位置</span>
<span class="n">StoragePort</span><span class="o">=</span><span class="mi">3306</span> <span class="c1"># 存储数据库服务端口号</span>
<span class="n">StorageUser</span><span class="o">=</span><span class="n">slurm</span> <span class="c1"># 存储数据库用户名</span>
<span class="n">StoragePass</span><span class="o">=</span><span class="n">SomePassWD</span> <span class="c1"># 存储数据库密码</span>
</pre></div>
</div>
</section>
<section id="cgroup">
<h2 id="cgroup"><span class="section-number">4.6. </span>设置cgroup限制<a class="headerlink" href="#cgroup" title="此标题的永久链接">¶</a></h2>
<p>启用cgroup资源限制，可以防止用户实际使用的资源超过用户为该作业通过作业调度系统申请到的资源。</p>
<p>如不需限制，不要在 <strong>/etc/slurm/slurm.conf</strong> 中设定 <cite>ProctrackType=proctrack/cgroup</cite> 及 <cite>TaskPlugin=task/cgroup</cite> 参数。如设定了 <cite>ProctrackType=proctrack/cgroup</cite> 和 <cite>TaskPlugin=task/cgroup</cite> 参数，还需要设定 <strong>/etc/slurm/cgroup.conf</strong> 文件内容类似：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">###</span>
<span class="c1">#</span>
<span class="c1"># Slurm cgroup support configuration file</span>
<span class="c1">#</span>
<span class="c1"># See man slurm.conf and man cgroup.conf for further</span>
<span class="c1"># information on cgroup configuration parameters</span>
<span class="c1">#--</span>
<span class="n">CgroupAutomount</span><span class="o">=</span><span class="n">yes</span> <span class="c1"># Cgroup自动挂载。Slurm cgroup插件需要挂载有效且功能正常的cgroup子系统于 /sys/fs/cgroup/&lt;subsystem_name&gt;。当启动时，插件检查该子系统是否可用。如不可用，该插件将启动失败，直到CgroupAutomount设置为yes。在此情形侠，插件首先尝试挂载所需的子系统。</span>
<span class="n">CgroupMountpoint</span><span class="o">=/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span> <span class="c1"># 设置cgroup挂载点，该目录应该是可写的，可以含有每个子系统挂载的cgroups。默认在/sys/fs/cgroup。</span>
<span class="c1"># CgroupPlugin= # 设置与cgroup子系统交互采用的插件。其值可以为cgroup/v1（支持传统的cgroup v1接口）或autodetect（根据系统提供的cgroup版本自动选择）。默认为autodetect。</span>

<span class="n">ConstrainCores</span><span class="o">=</span><span class="n">yes</span> <span class="c1"># 如设为yes，则容器允许将CPU核作为可分配资源子集，该项功能使用cpuset子系统。由于HWLOC 1.11.5版本中修复的错误，除了task/cgroup外，可能还需要task/affinity插件才能正常运行。默认为no。</span>
<span class="n">ConstrainDevices</span><span class="o">=</span><span class="n">yes</span> <span class="c1"># 如设为yes，则容器允许将基于GRES的设备作为可分配资源，这使用设备子系统。默认为no。</span>
<span class="n">ConstrainRAMSpace</span><span class="o">=</span><span class="n">yes</span> <span class="c1"># 如设为yes，则通过将内存软限制设置为分配的内存，并将硬限制设置为分配的内存AllowedRAMSpace来限制作业的内存使用。默认值为no，在这种情况下，如ConstrainSwapSpace设为“yes”，则作业的内存限制将设置为其交换空间(SWAP)限制。</span>
<span class="c1">#注意：在使用ConstrainRAMSpace时，如果一个作业步中所有进程使用的总内存大于限制，那么内核将触发内存不足(Out Of Memory，OOM)事件，将杀死作业步中的一个或多个进程。作业步状态将被标记为OOM，但作业步本身将继续运行，作业步中的其它进程也可能继续运行。这与OverMemoryKill的行为不同，后者将终止/取消整个作业步。不同之处还在于，JobAcctGather轮询系统在每个进程的基础上检查内存使用情况。</span>

<span class="c1"># MaxRAMPercent=98 #运行作业使用的最大内存百分比。将应用于Slurm未显式分配内存的作业的内存约束（如，Slurm的选择插件未配置为管理内存分配）。该百分比可能是一个任意的浮点数。默认值为100。</span>
<span class="c1"># AllowedRAMSpace=96 #运行作业/作业步使用的最大cgroup内存百分比。所提供的百分比可以用浮点数表示，例如101.5。在分配的内存大小下设置cgroup软内存限制，然后在分配的内存(AllowedRAMSpace/100)处设置作业/作业步硬内存限制。如果作业/作业步超出硬限制，则可能触发内存不足(OOM)事件（包括内存关闭），这些事件将记录到内核日志环缓冲区（Linux中的dmesg）。设置AllowedRAMSpace超过100可能会导致系统内存不足(OOM)事件，因为它允许作业/作业步分配比配置给节点更多的内存。建议减少已配置的节点可用内存，以避免系统内存不足(OOM)事件。将AllowedRAMSpace设置为低于100将导致作业接收的内存少于分配的内存，软内存限制将设置为与硬内存限制相同的值。默认值为100。</span>
</pre></div>
</div>
<ul>
<li><p>设置Slurm文件、目录、权限等：</p>
<blockquote>
<div><ul class="simple">
<li><p>/etc/slurm/slurmdbd.conf文件所有者须为slurm用户：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chown</span> <span class="n">slurm</span><span class="o">.</span><span class="n">slurm</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">slurm</span><span class="o">/</span><span class="n">slurmdbd</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<ul class="simple">
<li><p>/etc/slurm/slurmdbd.conf文件权限须为600：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="mi">600</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">slurm</span><span class="o">/</span><span class="n">slurmdbd</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<ul class="simple">
<li><p>/etc/slurm/slurm.conf文件所有者须为root用户：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chown</span> <span class="n">root</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">slurm</span><span class="o">/</span><span class="n">slurm</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<ul class="simple">
<li><p>建立slurmctld服务存储其状态等的目录，由slurm.conf中StateSaveLocation参数定义：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">slurmctld</span>
</pre></div>
</div>
<ul class="simple">
<li><p>设置/var/spool/slurmctld目录所有者为slurm用户：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chown</span> <span class="n">slurm</span><span class="o">.</span><span class="n">slurm</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">slurmctld</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>设置slurmdbd服务：</p>
<blockquote>
<div><ul class="simple">
<li><p>设置slurmdbd服务为开机自启动：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">slurmdbd</span>
</pre></div>
</div>
<ul class="simple">
<li><p>重启slurmdbd服务：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">slurmdbd</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>设置Slurm中定义的集群名：</p>
<blockquote>
<div><p>设置Slurm中定义的集群名为MyCluster：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">add</span> <span class="n">cluster</span> <span class="n">MyCluster</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</section>
<section id="mariadb-mysql">
<h2 id="mariadb-mysql"><span class="section-number">4.7. </span>设置mariadb(MySQL)数据库<a class="headerlink" href="#mariadb-mysql" title="此标题的永久链接">¶</a></h2>
<p>Slurm支持将账户信息等记录到简单的纯文本文件中、或直接存入数据库（MySQL或MariaDB等）、或对于多集群的某个安全管理账户信息的服务。该文档采用将记账信息等存储到数据库方式。</p>
<blockquote>
<div><ul class="simple">
<li><p>设置数据库权限</p></li>
</ul>
<p>执行 <code class="docutils literal notranslate"><span class="pre">mysql</span></code> 命令进入MariaDB控制台，然后在MariaDB控制台中执行下面命令（注意#开始的是注释，不要执行）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 生成slurm用户，以便该用户操作slurm_acct_db数据库，其密码是SomePassWD</span>
<span class="n">create</span> <span class="n">user</span> <span class="s1">'slurm'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">identified</span> <span class="n">by</span> <span class="s1">'SomePassWD'</span><span class="p">;</span>

<span class="c1"># 生成账户数据库slurm_acct_db</span>
<span class="n">create</span> <span class="n">database</span> <span class="n">slurm_acct_db</span><span class="p">;</span>
<span class="c1"># 赋予slurm从本机localhost采用密码SomePassWD登录具备操作slurm_acct_db数据下所有表的全部权限</span>
<span class="n">grant</span> <span class="nb">all</span> <span class="n">on</span> <span class="n">slurm_acct_db</span><span class="o">.*</span> <span class="n">TO</span> <span class="s1">'slurm'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">identified</span> <span class="n">by</span> <span class="s1">'SomePassWD'</span> <span class="k">with</span> <span class="n">grant</span> <span class="n">option</span><span class="p">;</span>
<span class="c1"># 赋予slurm从system0采用密码SomePassWD登录具备操作slurm_acct_db数据下所有表的全部权限</span>
<span class="n">grant</span> <span class="nb">all</span> <span class="n">on</span> <span class="n">slurm_acct_db</span><span class="o">.*</span> <span class="n">TO</span> <span class="s1">'slurm'</span><span class="o">@</span><span class="s1">'system0'</span> <span class="n">identified</span> <span class="n">by</span> <span class="s1">'SomePassWD'</span> <span class="k">with</span> <span class="n">grant</span> <span class="n">option</span><span class="p">;</span>

<span class="c1"># 生成作业信息数据库slurm_jobcomp_db</span>
<span class="n">create</span> <span class="n">database</span> <span class="n">slurm_jobcomp_db</span><span class="p">;</span>
<span class="c1"># 赋予slurm从本机localhost采用密码SomePassWD登录具备操作slurm_jobcomp_db数据下所有表的全部权限</span>
<span class="n">grant</span> <span class="nb">all</span> <span class="n">on</span> <span class="n">slurm_jobcomp_db</span><span class="o">.*</span> <span class="n">TO</span> <span class="s1">'slurm'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">identified</span> <span class="n">by</span> <span class="s1">'SomePassWD'</span> <span class="k">with</span> <span class="n">grant</span> <span class="n">option</span><span class="p">;</span>
<span class="c1"># 赋予slurm从system0采用密码SomePassWD登录具备操作slurm_jobcomp_db数据下所有表的全部权限</span>
<span class="n">grant</span> <span class="nb">all</span> <span class="n">on</span> <span class="n">slurm_jobcomp_db</span><span class="o">.*</span> <span class="n">TO</span> <span class="s1">'slurm'</span><span class="o">@</span><span class="s1">'system0'</span> <span class="n">identified</span> <span class="n">by</span> <span class="s1">'SomePassWD'</span> <span class="k">with</span> <span class="n">grant</span> <span class="n">option</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="slurmctld">
<h2 id="slurmctld"><span class="section-number">4.8. </span>重启slurmctld服务<a class="headerlink" href="#slurmctld" title="此标题的永久链接">¶</a></h2>
<ul class="simple">
<li><p>重启slurmctld服务</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">slurmctld</span>
</pre></div>
</div>
<ul class="simple">
<li><p>设置开机自动启用mariadb服务，且现在就启动服务：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="o">--</span><span class="n">now</span> <span class="n">mariadb</span>
</pre></div>
</div>
</section>
<section id="slurmd">
<h2 id="slurmd"><span class="section-number">4.9. </span>计算节点和用户登录节点设置slurmd服务<a class="headerlink" href="#slurmd" title="此标题的永久链接">¶</a></h2>
<p>建立 <strong>slurmd.service</strong> 文件，其内容为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[Unit]
Description=Slurm node daemon
After=munge.service network-online.target remote-fs.target
Wants=network-online.target
# ConditionPathExists=/etc/slurm/slurm.conf

[Service]
Type=simple
EnvironmentFile=-/etc/sysconfig/slurmd

# 增加--conf-server admin1:6817设定slurmctld服务节点
ExecStart=/usr/sbin/slurmd --conf-server admin1:6817 -D -s $SLURMD_OPTIONS
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
LimitNOFILE=131072
LimitMEMLOCK=infinity
LimitSTACK=infinity
Delegate=yes

[Install]
WantedBy=multi-user.target
</pre></div>
</div>
<p>将该文件复制到各节点：</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdcp</span> <span class="o">-</span><span class="n">w</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">login</span> <span class="n">slurmd</span><span class="o">.</span><span class="n">service</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span>
</pre></div>
</div>
</div></blockquote>
<p>systemd的服务配置文件变更后，各节点重新刷新服务内容后才能利用 <strong>systemctl</strong> 命令重启slurmd服务等：</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdsh</span> <span class="o">-</span><span class="n">w</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">login</span> <span class="s2">"systemctl daemon-reload; systemctl restart slurmd"</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id15">
<h2 id="id15"><span class="section-number">4.10. </span>设置记账账户和用户<a class="headerlink" href="#id15" title="此标题的永久链接">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 增加none和test账户并赋予相应权限</span>
<span class="n">sacctmgr</span> <span class="n">add</span> <span class="n">account</span> <span class="n">none</span><span class="p">,</span><span class="n">test</span> <span class="n">Cluster</span><span class="o">=</span><span class="n">MyCluster</span> <span class="n">Description</span><span class="o">=</span><span class="s2">"My slurm cluster"</span> <span class="n">Organization</span><span class="o">=</span><span class="s2">"USTC"</span>

<span class="c1"># 增加test1用户属于test账户</span>
<span class="n">sacctmgr</span> <span class="o">-</span><span class="n">i</span> <span class="n">add</span> <span class="n">user</span> <span class="n">test1</span> <span class="n">account</span><span class="o">=</span><span class="n">test</span>
</pre></div>
</div>
</section>
</section>
<section id="id16">
<h1 id="id16"><span class="section-number">5. </span>高级功能<a class="headerlink" href="#id16" title="此标题的永久链接">¶</a></h1>
<section id="gpu">
<h2 id="gpu"><span class="section-number">5.1. </span>GPU等资源配置<a class="headerlink" href="#gpu" title="此标题的永久链接">¶</a></h2>
<p>各GPU节点 <strong>/etc/slurm/gres.conf</strong> 文件内容：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#AutoDetect=nvml</span>
<span class="n">Name</span><span class="o">=</span><span class="n">gpu</span> <span class="n">Type</span><span class="o">=</span><span class="n">v100</span> <span class="n">File</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvidia</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Type设定卡类型，如V100、A100等，需与队列中的gres选项对应，File对应GPU设备名，[0-1]表示有两个GPU设备/dev/nvidia0与/dev/nvidia1</span>
<span class="c1">#Name=mps Count=100</span>
</pre></div>
</div>
</section>
<section id="qos">
<h2 id="qos"><span class="section-number">5.2. </span>服务质量(QOS)配置<a class="headerlink" href="#qos" title="此标题的永久链接">¶</a></h2>
<p>对资源进行限制，比如限制用户的单个作业CPU核数、运行中作业总CPU核数、作业时长等，除了利用队列分区等外，还可以利用服务质量(Quality of Service, QOS)。利用Slurm提交作业时，可以为每个作业赋予一个QOS，与作业相关的QOS有三种途径：</p>
<ul class="simple">
<li><p>作业调度优先级：Job Scheduling Priority</p></li>
<li><p>作业抢占：Job Preemption</p></li>
<li><p>作业限制：Job Limits</p></li>
</ul>
<p>QOS通过 <code class="docutils literal notranslate"><span class="pre">sacctmgr</span></code> 工具在Slurm数据库中进行设定。</p>
<p>作业提交时，需要通过给 <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> 、 <code class="docutils literal notranslate"><span class="pre">salloc</span></code> 和 <code class="docutils literal notranslate"><span class="pre">srun</span></code> 命令添加 <code class="docutils literal notranslate"><span class="pre">--qos=</span></code> 选项来设定需要的QOS。</p>
<section id="id17">
<h3 id="id17"><span class="section-number">5.2.1. </span>作业调度优先级<a class="headerlink" href="#id17" title="此标题的永久链接">¶</a></h3>
<p>作业调度优先级是在 <strong>priority/multifactor</strong> 插件中设定的一个数字因子。其中一个因子为QOS优先级，每个QOS被定义在Slurm数据库中，且含有与之关联的优先级。请求且获得认可的QOS的作业将在作业多因子优先级计算中包含该QOS相关联的优先级。</p>
<p>为了在多因子优先级计算中启用QOS优先级组件， <strong>PriorityWeightQOS</strong> 配置参数必需在 <strong>slurm.conf</strong> 文件中已被定义，且被赋予一个大于0的整数。</p>
<p>作业的QOS仅影响多因子插件被加载时调度的优先级。</p>
</section>
<section id="id18">
<h3 id="id18"><span class="section-number">5.2.2. </span>作业抢占<a class="headerlink" href="#id18" title="此标题的永久链接">¶</a></h3>
<p>Slurm提供了两种途径用于排队中的作业抢占运行中的作业，释放运行中作业的资源，并且将其分配给排队中作业。</p>
<p>抢占方式是由 <strong>slurm.conf</strong> 文件中 <strong>PreemptType</strong> 配置参数决定的。当 <strong>PreemptType</strong> 设定为 <em>preempt/qos</em> 时，一个排队中的作业的QOS将被用于决定其是否可以抢占一个运行中的作业。</p>
<p>QOS可以被赋予（利用 <code class="docutils literal notranslate"><span class="pre">sacctmgr</span></code> 命令）一些可以被其抢占的其它QOS的列表。当有一个排队中的具有的QOS允许其抢占一个具有其它QOS运行中的作业，Slurm调度器将抢占该运行中的作业。</p>
<p>QOS <strong>PreemptExemptTime</strong> 参数设定了在作业将抢占之前最小运行时间。QOS选项优先于同名的全局选项。</p>
</section>
<section id="id19">
<h3 id="id19"><span class="section-number">5.2.3. </span>作业限制<a class="headerlink" href="#id19" title="此标题的永久链接">¶</a></h3>
<p>每个QOS被赋予 <strong>OverPartQOS</strong> 一系列的限制，这些限制将应用于作业。这些限制反映了在Slurm数据库中定义的并在下面<a class="reference internal" href="#id20">资源限制</a>部分中描述的用户/帐户/集群/队列(user/account/cluster/partition)关联所施加的限制。当定义了QOS的限制时，它们将优先于关联的限制。</p>
<section id="id20">
<h4 id="id20"><span class="section-number">5.2.3.1. </span>资源限制<a class="headerlink" href="#id20" title="此标题的永久链接">¶</a></h4>
<section id="id21">
<h5 id="id21"><span class="section-number">5.2.3.1.1. </span>层级<a class="headerlink" href="#id21" title="此标题的永久链接">¶</a></h5>
<p>Slurm的层级限制按照下述顺序强制执行，作业QOS和队列QOS顺序如采用了QOS标记 <code class="docutils literal notranslate"><span class="pre">OverPartQOS</span></code> 参数则可逆。</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>队列QOS限制</p></li>
<li><p>作业QOS限制</p></li>
<li><p>用户关联</p></li>
<li><p>帐户关联，升序排列</p></li>
<li><p>Root/Cluster关联</p></li>
<li><p>队列限制</p></li>
<li><p>无</p></li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>若在层级中定义了多个限制，则在这个列表中的最先定义的限制有效。如下面例子：</p>
<ul class="simple">
<li><p><strong>MaxJobs=20</strong> ，且 <strong>MaxSubmitJobs</strong> 未在队列QOS中被定义</p></li>
<li><p>在作业QOS中没有任何限制</p></li>
<li><p><strong>MaxJobs=4</strong> 和 <strong>MaxSubmitJobs=50</strong> 在用户关联中定义</p></li>
</ul>
<p>上面限制实际生效的是 <strong>MaxJobs=20</strong> 和 <strong>MaxSubmitJobs=50</strong> 。</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>应遵守上述规定的优先顺序，除下列限制外： <strong>Max[Time|Wall]</strong> 、 <strong>[Min|Max]Nodes</strong> 。对这些限制，即使这些队列层级限制在最底部列出，当作业被QOS和/或联合限制时，也无法超过队列层级限制 。因此，对这三种限制的默认是它们是队列限制的上限。若QOS中的 <strong>PartitionTimeLimit</strong> 和/或 <strong>Partition[Max|Min]Nodes</strong> 标记被设置，则该队列层级边界可被忽略，那么该作业将根据上述命令执行QOS和/或关联层级的限制。</p>
</div>
</section>
<section id="id22">
<h5 id="id22"><span class="section-number">5.2.3.1.2. </span>设置<a class="headerlink" href="#id22" title="此标题的永久链接">¶</a></h5>
<p>调度策略信息必需被存储在数据库中，该数据库由 <strong>slurm.conf</strong> 配置文件中的 <strong>AccountingStorageType</strong> 配置参数定义。调度策略信息可以记录在MySQL或MariaDB数据库中。为了安全和性能，强烈推荐采用SlurmDBD作为数据库的前端。SlurmDBD使用Slurm认证插件（如MUNGE）进行认证，还使用一个已有的Slurm记账存储插件以最大化代码重用。SlurmDBD利用排队中请求的数据缓存和优先化以便优化性能。因为SlurmDBD依赖于现有的Slurm插件用于验证和数据库使用，仅安装SlurmDBD的节点不再需要其它Slurm命令和守护进程，仅需要安装slurmdbd和slurm-plugins RPM包。</p>
<p>记账和调度策略都被配置基于某个关联。每个关联是由集群名、银行账户、用户和Slurm队列（可选）组成的4元组。为了强制使用调度策略，需在 <strong>slurm.conf</strong> 配置文件中设置 <strong>AccountingStorageEnforce</strong> 选项的值。该选项含有采用逗号（,）分隔的一些需要强制的选项。有效值如下：</p>
<blockquote>
<div><ul class="simple">
<li><p><em>associations</em> ：关联。如用户的关联不在数据库中，这将阻止用户运行作业。该参数可以阻止用户访问无效账户。</p></li>
<li><p><em>limits</em> ：限制。为关联设置强制限制。如设置了该值， <em>associations</em> 值也被自动设置。</p></li>
<li><p><em>qos</em> ：QOS。要求所有作业都将（显式或默认）指定一个有效的QOS。针对每个关联的QOS值都在数据库中定义。如设置了该值， <em>associations</em> 值也被自动设置。</p></li>
<li><p><em>safe</em> ：安全。确保作业只有在采用某具有 <strong>GrpTRESMins</strong> 限制的关联或QOS时才能被启动，且前提是作业能运行完。如未设置该选项，只要作业的使用量未达到cpu-minutes限制，就会启动作业，可能导致作业虽然被启动但在达到限制时即使未完成也被终止。如设置了该值， <em>associations</em> 和 <em>limits</em> 值也被自动设置。</p></li>
<li><p><em>wckeys</em> ：工作负载特征键。将阻止用户在它们无权访问的wckey下运行作业。如设置了该值， <em>associations</em> 值也被设置，且 <strong>TrackWCKey</strong> 选项被设置为true。</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>关联是由集群名、银行账户、用户名和Slurm队列名（可选）组成的4元组。</p>
<p>未设置 <strong>AccountingStorageEnforce</strong> （默认行为），作业将基于每个集群中配置的上述slurm策略运行。</p>
</div>
</section>
<section id="id23">
<h5 id="id23"><span class="section-number">5.2.3.1.3. </span>工具<a class="headerlink" href="#id23" title="此标题的永久链接">¶</a></h5>
<p>用于管理账户策略的工具是 <code class="docutils literal notranslate"><span class="pre">sacctmgr</span></code> 。该工具可以被用于创建和删除集群、用户、银行账户和队列记录及其组合关联记录等。</p>
<p>策略的改变将被告知不同集群上的Slurm控制守护进程，且立即生效。当某个关联被删除，属于该关联的所有运行中的和排队中的作业将立即被取消。当限制降低，运行中的作业不会被取消以满足心的限制，但新的较低限制将会被强制生效。</p>
</section>
<section id="id24">
<h5 id="id24"><span class="section-number">5.2.3.1.4. </span>关配置联和QOS中的限制<a class="headerlink" href="#id24" title="此标题的永久链接">¶</a></h5>
<p>当处理关联时。多数这些限制都不仅是对某一用户的关联，而且是对每个集群和账户的。如新创建一个针对某用户关联被创建，但调度策略的选项未被指定，那么默认将是：集群/账户对的选项，且如两者都未被指定，则该选项是针对集群的，如果仍未被指定，则限制不生效。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>除非特别说明，如果作业请求本身违反了给定的限制，该作业将暂停，除非作业的QOS设置了拒绝限制标志，该标志将使用作业在提交时被拒绝。当根据此标志考虑Grp限制时，Grp限制被视为最大限制。</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>当采用 <code class="docutils literal notranslate"><span class="pre">sacctmgr</span></code> 命令更新一个TRES域，必须指定具体哪个TRES，如：</p>
<p>设置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">modify</span> <span class="n">user</span> <span class="n">bob</span> <span class="nb">set</span> <span class="n">GrpTRES</span><span class="o">=</span><span class="n">cpu</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span><span class="n">mem</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">gres</span><span class="o">/</span><span class="n">gpu</span><span class="o">=</span><span class="mi">50</span>
</pre></div>
</div>
<p>取消设置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">modify</span> <span class="n">user</span> <span class="n">bob</span> <span class="nb">set</span> <span class="n">GrpTRES</span><span class="o">=</span><span class="n">cpu</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">mem</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">gres</span><span class="o">/</span><span class="n">gpu</span><span class="o">=-</span><span class="mi">1</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p><strong>GrpTRESMins</strong> = ：能从关联及其子项或QOS运行的过去、现在和未来作业可能使用的TRES分钟总数。当该限制到达时，所有依赖于该限制的作业将被杀掉，且没有新的作业被允许运行。该用法被衰减（以 <strong>PriorityDecayHalfLife</strong> 设定的衰减速率）。 该选项可以被重置（取决于 <strong>PriorityUsageResetPeriod</strong> 选项）以便允许作业重新基于这些关联树或QOS运行。QOS，如没有 <em>NoDecay</em> 被设置，那么 <strong>GrpTRESMins</strong> 将不被衰减。这仅在启用优先级多因子插件时生效。
*</p></li>
<li><p><strong>GrpTRESRunMins</strong> = ：用于限制所有同一个关联和其子项或QOS组合的总TRES分钟数。考虑到运行作业的时间限制并使用它，如果达到限制，在其它作业完成之前不会启动新作业，以允许时间释放作业。</p></li>
<li><p><strong>GrpTRES</strong> = ：在给定的任意时间，能从关联及其子项或QOS运行作业的TRES总数。如达到该限制，新作业将处于排队状态，仅当资源被从该组释放时才能开始运行。</p></li>
<li><p><strong>GrpJobs</strong> = ：在给定的任意时间，能从关联及其子项或QOS运行作业总数。如达到该限制，新作业将处于排队状态，仅当之前作业结束时才能开始运行。</p></li>
<li><p><strong>GrpJobsAccrue</strong> = ：在给定的任意时间，能从关联及其子项QOS中获得年龄优先级的排队中作业的总数。如达到此限制，新作业将排队，但在此组中等待的先前作业删除之前不会累积年龄优先级。此限制并不决定作业是否可以运行，它只限制了优先级的年龄因素。当在QOS上设置时，此限制仅适用于作业QOS，而不适用于队列QOS。</p></li>
<li><p><strong>GrpSubmitJobs</strong> = ：在给定的任意时间，能从关联及其子项QOS中提交到系统中的作业总数。如达到该限制，提交新作业将被拒绝，仅当之前作业结束时才能提交。</p></li>
<li><p><strong>GrpWall</strong> ：能从关联及其子项或QOS运行作业的墙上时钟最大值。当该限制到达时，在该QOS或关联的未来作业将处于排队状态，直到期能在该限制内运行。该使用量会被衰减（以 <strong>PriorityDecayHalfLife</strong> 选项规定的比率）。它也可以被重置（取决于 <strong>PriorityUsageResetPeriod</strong> 选项），以便允许作业基于该关联数或QOS运行。具有 <em>NoDecay</em> 值的QOS不会衰减 <strong>GrpWall</strong> 。</p></li>
<li><p><strong>MaxTRESMinsPerJob</strong> = ：作业占用TRES分钟的限制。如达到该限制，该作业如没有运行在Safe模式下将被杀掉，否则该作业将排队直到被给予足够的时间以完成该作业。</p></li>
<li><p><strong>MaxTRESPerJob</strong> = ：每个作业能从关联/QOST获取的TRES最大数。</p></li>
<li><p><strong>MaxTRESPerNode</strong> = ：每个作业能从关联/QOST获取的每个节点的TRES最大数。</p></li>
<li><p><strong>MaxWallDurationPerJob</strong> = ：每个作业能从关联/QOST获取的最大墙上时钟时长。如达到该限制，作业在提交时将被拒绝。</p></li>
<li><p><strong>MinPrioThreshold</strong> = ：从关联/QOST获取的用于预留资源的最小优先级。可用于覆盖 <strong>bf_min_prio_reserve</strong> 选项设置。</p></li>
</ul>
</section>
<section id="id25">
<h5 id="id25"><span class="section-number">5.2.3.1.5. </span>支持的关联指定调度策略<a class="headerlink" href="#id25" title="此标题的永久链接">¶</a></h5>
<p>这些策略代表了关联所特有的调度策略，已在上面列出了QOS共同具有的共享策略和限制。</p>
<ul class="simple">
<li><p><strong>Fairshare</strong> =：用于决定公平共享优先级的整数。本质上，这是对上述系统针对该关联和其子项的请求总数。也可以使用字符串”parent”，当被用户使用时，意味着针对公平共享采用其父关联。如在该账户设置 <strong>Fairshare=parent</strong> ，该账户的子成员将被有效地利用它们的第一个不是 <strong>Fairshare=parent</strong> 的父母重新支付公平共享计算。限制保持不变，仅影响其公平共享值￼</p></li>
<li><p><strong>MaxJobs</strong> =：在给定的任意时间，针对该关联能同时运行的作业总数。如该达到限制，新作业将处于排队状态，只有当该关联的作业有结束时才能运行。</p></li>
<li><p><strong>MaxJobsAccrue</strong> =：在给定的任意时间，能从关联允许的排队中作业累计年龄优先级的最大数。当该达到限制，新作业将处于排队中状态，但不累计年龄优先级，直到有关联的作业从排队状态有退出排队。该限制不决定作业是否能运行，它只限制优先级的年龄因子。</p></li>
<li><p><strong>MaxSubmitJobs</strong> =：在给定的任意时间，能从该关联提交到系统中的作业最大数。如达到该限制，新提交申请将被拒绝，直到存在该关联的作业退出。</p></li>
<li><p><strong>QOS</strong> =：以逗号（,）分隔的能运行的QOS列表。</p></li>
</ul>
</section>
<section id="id26">
<h5 id="id26"><span class="section-number">5.2.3.1.6. </span>支持的QOS特定限制<a class="headerlink" href="#id26" title="此标题的永久链接">¶</a></h5>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>每个账户(account)可以有多个用户(user)。</p>
</div>
<ul class="simple">
<li><p><strong>MaxJobsAccruePerAccount</strong> =：在任意时间，一个账户（或子账户）能从关联允许的排队中作业累计年龄优先级的最大数。该限制不决定作业是否能运行，它只限制优先级的年龄因子。</p></li>
<li><p><strong>MaxJobsAccruePerUser</strong> =： 在任意时间，一个用户能从关联允许的排队中作业累计年龄优先级的最大数。该限制不决定作业是否能运行，它只限制优先级的年龄因子。</p></li>
<li><p><strong>MaxJobsPerAccount</strong> =：一个账户（或子账户）能允许的最大同时运行作业数。</p></li>
<li><p><strong>MaxJobsPerUser</strong> = 每个用户能同时运行的最大作业数。</p></li>
<li><p><strong>MaxSubmitJobsPerAccount</strong> = 每个账户（或子账户）能同时运行和排队等待运行的最大作业数。</p></li>
<li><p><strong>MaxSubmitJobsPerUser</strong> = 每个用户能同时运行和排队等待运行的最大作业数。</p></li>
<li><p><strong>MaxTRESPerAccount</strong> = 每个账户能同时分的配最大TRES数。</p></li>
<li><p><strong>MaxTRESPerUser</strong> = 每个用户能同时分配的最大TRES数。</p></li>
<li><p><strong>MinTRESPerJob</strong> = 每个作业能申请的最小TRES尺寸。</p></li>
</ul>
<p><strong>MaxNodes</strong> 和 <strong>MaxWall</strong> 选项已存在于每个队列的基础Slurm配置中，但上述选项提供了基于每个用户基础的限制能力。<strong>MaxJobs</strong> 选项为Slurm提供了一种新机制用于控制集群个人工作负载，以确保在用户中获取某种平衡。</p>
<p>当给一个QOS赋予限制以用于队列QOS，请务必注意这些限制是在QOS层级，而不是对每个队列层级单独实行的。例如，某个QOS具有 <strong>GrpTRES=cpu=20</strong> 限制，且该QOS被赋予两个独立队列，用户将因该QOS被限制到20颗CPU而不是每个队列允许20颗CPU。</p>
<p>公平共享调度是基于Slurm数据库中保持的层级银行账户数据。具体参见 <a class="reference external" href="https://slurm.schedmd.com/priority_multifactor.html">priority/multifactor</a> 插件。</p>
</section>
<section id="gres">
<h5 id="gres"><span class="section-number">5.2.3.1.7. </span>具体GRES限制<a class="headerlink" href="#gres" title="此标题的永久链接">¶</a></h5>
<p>当一个GRES具有一种类型与其关联，且针对该类型有一个限制（如， <strong>MaxTRESPerUser=gres/gpu:tesla=1</strong> ），如一个用户请求一个通用gres，则不会强制执行该类型限制。在该情形下，一个附加的用于检查用户请求的lua作业提交插件将非常有用。例如，如果一个请求 <strong>–gres=gpu:2</strong> 受到 <strong>MaxTRESPerUser=gres/gpu:tesla=1</strong> 限制，该限制将不被强制执行，因此还可能得到两个tesla卡资源。</p>
<p>这是缘于设计限制。强制执行该限制的唯一法子是利用作业提交插件组合这些限制，以强制用户请求特定类型模型。</p>
<p>下面是一个基础的lua作业提交插件函数：</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">slurm_job_submit</span><span class="p">(</span><span class="n">job_desc</span><span class="p">,</span> <span class="n">part_list</span><span class="p">,</span> <span class="n">submit_uid</span><span class="p">)</span>
   <span class="kr">if</span> <span class="p">(</span><span class="n">job_desc</span><span class="p">.</span><span class="n">gres</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span>
   <span class="kr">then</span>
      <span class="kr">for</span> <span class="n">g</span> <span class="kr">in</span> <span class="n">job_desc</span><span class="p">.</span><span class="n">gres</span><span class="p">:</span><span class="n">gmatch</span><span class="p">(</span><span class="s2">"[^,]+"</span><span class="p">)</span>
      <span class="kr">do</span>
     <span class="n">bad</span> <span class="o">=</span> <span class="nb">string.match</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="s1">'^gpu[:]*[0-9]*$'</span><span class="p">)</span>
     <span class="kr">if</span> <span class="p">(</span><span class="n">bad</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span>
     <span class="kr">then</span>
        <span class="n">slurm</span><span class="p">.</span><span class="n">log_info</span><span class="p">(</span><span class="s2">"User specified gpu GRES without type: %s"</span><span class="p">,</span> <span class="n">bad</span><span class="p">)</span>
        <span class="n">slurm</span><span class="p">.</span><span class="n">user_msg</span><span class="p">(</span><span class="s2">"You must always specify a type when requesting gpu GRES"</span><span class="p">)</span>
        <span class="kr">return</span> <span class="n">slurm</span><span class="p">.</span><span class="n">ERROR</span>
     <span class="kr">end</span>
      <span class="kr">end</span>
   <span class="kr">end</span>
<span class="kr">end</span>
</pre></div>
</div>
<p>在合适位置含有该脚本和该限制将强制用户总是指明一个GPU具有其类型，因此针对每个特定模型强制该限制。</p>
<p>总是建议针对通用和特定GRES类型设置 <strong>AccountingStorageTRES</strong> ，否则将不会考虑要求提供gres通用实例的请求。例如，可追踪通用GPU和Tesla GPU，将在 <strong>slurm.conf</strong> 中设置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AccountingStorageTRES</span><span class="o">=</span><span class="n">gres</span><span class="o">/</span><span class="n">gpu</span><span class="p">,</span><span class="n">gres</span><span class="o">/</span><span class="n">gpu</span><span class="p">:</span><span class="n">tesla</span>
</pre></div>
</div>
<p>参见： <a class="reference external" href="https://slurm.schedmd.com/tres.html">Trackable Resources TRES</a> 。</p>
</section>
</section>
</section>
<section id="id27">
<h3 id="id27"><span class="section-number">5.2.4. </span>队列QOS<a class="headerlink" href="#id27" title="此标题的永久链接">¶</a></h3>
<p>QOS可与队列相关联，这意味着一个队列将具有相同的限制作为一种QOS。这也将提供一个真正的“浮动”分区的能力，意味着如果你分配所有节点队列和队列的QOS限制Grpcpus或GrpNodes队列将访问所有节点，但只能运行在其内的资源数量。</p>
<p>队列QOS优先级高于作业QOS，将覆盖掉作业QOS。如想相反，在需要在作业QOS中设定OverPartQOS标记，这将反转优先顺序。</p>
</section>
<section id="id28">
<h3 id="id28"><span class="section-number">5.2.5. </span>其它QOS选项<a class="headerlink" href="#id28" title="此标题的永久链接">¶</a></h3>
<ul>
<li><dl class="simple">
<dt><strong>Flags</strong> ： 被slurmctld用于覆盖或者加强特定特性。有效的值可为：</dt><dd><ul class="simple">
<li><p><em>DenyOnLimit</em> ：受限时拒绝。如设置，采用该QOS的作业，如果不符合QOS <strong>MAX</strong> 的限制作为独立的作业，将在提交时被拒绝。那些在考虑其它作业时超过这些限制，但在单独考虑时符合这些限制的作业将不会被拒绝。相反，它们将等待到资源直到可用（默认没有 <strong>DenyOnLimit</strong> ）。组限制（如 <strong>GrpTRES</strong> ）也将被视为 <strong>MAX</strong> 限制（如 <strong>MaxTRESPerNode</strong> ），如果这些限制将作为独立作业生效，这些作业将被拒绝。这目前只适用于QOS和关联限制。</p></li>
<li><p><em>EnforceUsageThreshold</em> ：增强使用量阈值。如设置，且QOS有一个 <strong>UsageThreshold</strong> ，任何关联该QOS提交的作业如低于该 <strong>UsageThresholdany</strong> ，那么直到它们的Fairshare Usage超过该阈值时才运行。</p></li>
<li><p><em>NoReserve</em> ：不预留。如该标记被设置，且采用回填调度，则采用该QOS的作业在回填调度时不预留资源。该标记初衷为用于关联某QOS可以被作业关联的所有其它QOS（如关联的standby QOS）可以抢占。如该标记被用于某个能被其它所有QOS抢占的QOS，这可能会导致更大的作业饥饿。</p></li>
<li><p><em>PartitionMaxNodes</em> ：队列最大节点数。如设置，使用此QOS的作业将能够覆盖所请求的分区的MaxNodes限制</p></li>
<li><p><em>PartitionMinNodes</em> ：队列最小节点数。如设置，使用此QOS的作业将能够覆盖所请求的分区的MinNodes限制</p></li>
<li><p><em>OverPartQOS</em> ：覆盖队列QOS。如设置，采用该QOS的作业可以覆盖其使用的队列关联的任何QOS限制。</p></li>
<li><p><em>PartitionTimeLimit</em> ：队列时间限制。如设置，采用该QOS的作业可以覆盖掉其使用的队列的TimeLimit限制。</p></li>
<li><p><em>RequiresReservation</em> ：请求预留。如设置，采用该QOS的作业提交作业时必须指定一个预留。该选项可用于限制可能具有更大抢占能力的QOS的使用，或仅在预留范围内允许的额外资源。</p></li>
<li><p><em>NoDecay</em> ：无衰减。如设置，该QOS将不会使它的 <strong>GrpTRESMins</strong> 、 <strong>GrpWall</strong> 和 <strong>UsageRaw</strong> 由于 <strong>slurm.conf</strong> 文件中设定了 <strong>PriorityDecayHalfLife</strong> 或 <strong>PriorityUsageResetPeriod</strong> 而衰减。这将允许该QOS提供那些一旦消耗，将不会自动补充的集合限制。这样的QOS将作为一个可以访问它的关联的一个有时间限制的资源配额。对于使用QOS进行的关联，帐户/用户(Account/user)的使用量仍将衰减。 <strong>QOSGrpTRESMin</strong> 和 <strong>GrpWall</strong> 限制可以增加，或将QOS RawUsage重置为0，以再次允许使用此QOS提交的作业运行（如果作业处于等待中是因为使用 <strong>QOSGrp{TRES}MinutesLimit</strong> 或 <strong>QOSGrpWallLimit</strong> ，其中TRES是某种类型的可跟踪资源）。</p></li>
<li><p><em>UsageFactorSafe</em> ：使用量因子安全。如设置， <strong>slurm.conf</strong> 文件中 <strong>AccountingStorageEnforce</strong> 选项含有Safe，作业只有在该作业具有 <strong>UsageFactor</strong> 时能完成时才运行。</p></li>
</ul>
</dd>
</dl>
</li>
<li><p><strong>GraceTime</strong> ：优雅时间。当抢占时，该抢占优雅时间将被扩展到作业。</p></li>
<li><p><strong>UsageFactor</strong> ：使用量因子。浮点数，其考虑了作业的TRES使用量（如， <strong>RawUsage</strong> 、 <strong>TRESMins</strong> 和 <strong>TRESRunMins</strong> ）。例如，如 <strong>UsageFactor</strong> 为2，那么每 <strong>TRESBillingUnit</strong> 秒时间运行作业，它将计数为2。如果 <strong>UsageFactor</strong> 为0.5，则每 <strong>TRESBillingUnit</strong> 秒钟只占一半的时间。设置为0，将不会增加作业的时间利用。</p>
<blockquote>
<div><p>该使用量因子仅对作业QOS有效，对于队列QOS无效。</p>
<p>如设置了 <strong>UsageFactorSafe</strong> 标记且 <strong>AccountingStorageEnforce</strong> 选项含有 <em>Safe</em> ，作业只有在该作业具有 <strong>UsageFactor</strong> 时能完成时才运行。</p>
<p>如未设置 <strong>UsageFactorSafe</strong> 标记且 <strong>AccountingStorageEnforce</strong> 选项含有 <em>Safe</em> ，作业将能够在不应用 <strong>UsageFactor</strong> 的情况下被调度，且不会因为限制而被杀掉。</p>
<p>如未设置 <strong>UsageFactorSafe</strong> 标记且 <strong>AccountingStorageEnforce</strong> 选项不含有 <em>Safe</em> ，一个作业将能够在不应用 <strong>UsageFactor</strong> 的情况下被调度，并可能由于限制而被杀死。</p>
<p><code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">slurm.conf</span></code> 查看AccountingStorageEnforce。</p>
<p>默认为1。为了清除先前设置的值，可使用修改命令设置新值为-1。</p>
</div></blockquote>
</li>
<li><p><strong>UsageThreshold</strong> ：使用量阈值。 代表关联中允许运行作业的最低公平份额的一个浮点数。如关联低于此阈值，并且有挂起作业或提交新作业，则这些作业将被保留，直到使用量恢复到高于此阈值为止。使用 <code class="docutils literal notranslate"><span class="pre">sshare</span></code> 命令来查看系统上的当前共享。</p></li>
</ul>
</section>
<section id="id29">
<h3 id="id29"><span class="section-number">5.2.6. </span>配置<a class="headerlink" href="#id29" title="此标题的永久链接">¶</a></h3>
<p>总结上述，QOS和其关联的限制被利用 <code class="docutils literal notranslate"><span class="pre">sacctmgr</span></code> 工具命令定义在Slurm数据库中。QOS仅影响启用多因子优先级插件的作业调度的优先级，且非0的 <strong>PriorityWeightQOS</strong> 已经被定义在 <strong>slurm.conf</strong> 文件中。当在 <strong>slurm.conf</strong> 文件中 <strong>PreemptType</strong> 被定义为 <em>preempt/qos</em> 时，QOS将仅决定作业抢占。QOS定义的限制将覆盖掉user/account/cluster/partition关联的限制。</p>
</section>
<section id="id30">
<h3 id="id30"><span class="section-number">5.2.7. </span>QOS常见操作例子<a class="headerlink" href="#id30" title="此标题的永久链接">¶</a></h3>
<p>所有QOS操作都使用 <code class="docutils literal notranslate"><span class="pre">sacctmgr</span></code> 命令。 <code class="docutils literal notranslate"><span class="pre">sacctmgr</span> <span class="pre">show</span> <span class="pre">qos</span></code> 命令默认输出非常长，给出了大量限制和选项，为此最好采用格式化选项进行过滤和显示。</p>
<p>默认，当一个集群被加入到数据库中时，会自动生成一个叫normal的QOS。</p>
<ul class="simple">
<li><p>显示现有的QOS：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">show</span> <span class="n">qos</span> <span class="nb">format</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">priority</span>
</pre></div>
</div>
<p>将输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Name</span>        <span class="n">Priority</span>
<span class="o">----------</span> <span class="o">----------</span>
<span class="n">normal</span>          <span class="mi">0</span>
</pre></div>
</div>
<ul class="simple">
<li><p>增加一个新QOS：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">add</span> <span class="n">qos</span> <span class="mi">128</span><span class="n">cpu</span>
</pre></div>
</div>
<ul class="simple">
<li><p>设置QOS优先级：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">modify</span> <span class="n">qos</span> <span class="mi">128</span><span class="n">cpu</span> <span class="nb">set</span> <span class="n">priority</span><span class="o">=</span><span class="mi">10</span>
</pre></div>
</div>
<ul class="simple">
<li><p>更新信息，设置最小CPU核为1：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">update</span> <span class="n">qos</span> <span class="n">normal</span> <span class="nb">set</span> <span class="n">MinTRES</span><span class="o">=</span><span class="n">cpu</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<ul class="simple">
<li><p>设置最小CPU核为120</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">add</span> <span class="n">qos</span> <span class="n">long</span> <span class="nb">set</span> <span class="n">MinTRES</span><span class="o">=</span><span class="n">cpu</span><span class="o">=</span><span class="mi">120</span>
</pre></div>
</div>
<ul class="simple">
<li><p>增加单用户最大资源MaxTRESPU为144核CPU，标记为144cpu：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">add</span> <span class="n">qos</span> <span class="mi">144</span><span class="n">cpu</span> <span class="nb">set</span> <span class="n">MaxTRESPU</span><span class="o">=</span><span class="n">cpu</span><span class="o">=</span><span class="mi">144</span>
</pre></div>
</div>
<ul class="simple">
<li><p>设置其它限制：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">modify</span> <span class="n">qos</span> <span class="mi">128</span><span class="n">cpu</span> <span class="nb">set</span> <span class="n">grpcpus</span><span class="o">=</span><span class="mi">128</span>
</pre></div>
</div>
<ul class="simple">
<li><p>为用户增加QOS：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">modify</span> <span class="n">user</span> <span class="n">user1</span> <span class="nb">set</span> <span class="n">qos</span><span class="o">=</span><span class="mi">144</span><span class="n">cpu</span>
</pre></div>
</div>
<ul class="simple">
<li><p>用户可以有多个QOS，利用 <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">qos+=</span></code> 设置：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">modify</span> <span class="n">user</span> <span class="n">user1</span> <span class="nb">set</span> <span class="n">qos</span><span class="o">+=</span><span class="n">Mem64G</span>
</pre></div>
</div>
<ul class="simple">
<li><p>查看账户关联的QOS：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">show</span> <span class="n">assoc</span>
<span class="n">sacctmgr</span> <span class="n">show</span> <span class="n">assoc</span> <span class="n">where</span> <span class="n">name</span><span class="o">=</span><span class="n">hmli</span>
<span class="n">sacctmgr</span> <span class="n">show</span> <span class="n">assoc</span> <span class="nb">format</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">qos</span>
</pre></div>
</div>
<p>将显示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">Cluster</span>       <span class="n">User</span>                  <span class="n">QOS</span>
<span class="o">----------</span> <span class="o">----------</span> <span class="o">--------------------</span>
  <span class="n">MyCluster</span>                          <span class="n">normal</span>
  <span class="n">MyCluster</span>      <span class="n">root</span>                <span class="n">normal</span>
  <span class="n">MyCluster</span>                          <span class="n">normal</span>
  <span class="n">MyCluster</span>     <span class="n">user1</span>                <span class="mi">144</span><span class="n">cpu</span>
</pre></div>
</div>
<ul class="simple">
<li><p>删除某个QOS：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sacctmgr</span> <span class="n">delete</span> <span class="n">qos</span> <span class="n">Mem64G</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id31">
<h1 id="id31"><span class="section-number">6. </span>日常操作<a class="headerlink" href="#id31" title="此标题的永久链接">¶</a></h1>
<ul class="simple">
<li><p>如执行 <code class="docutils literal notranslate"><span class="pre">sinfo</span></code> 命令显示节点STATE为down、drain等不正常状态：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PARTITION</span> <span class="n">AVAIL</span>  <span class="n">TIMELIMIT</span>  <span class="n">NODES</span>  <span class="n">STATE</span> <span class="n">NODELIST</span>
<span class="n">batch</span><span class="o">*</span>       <span class="n">up</span>   <span class="n">infinite</span>      <span class="mi">1</span>  <span class="n">down</span>  <span class="n">node1</span>
<span class="n">batch</span><span class="o">*</span>       <span class="n">up</span>   <span class="n">infinite</span>      <span class="mi">1</span>  <span class="n">drain</span> <span class="n">node2</span>
</pre></div>
</div>
<p>可先执行 <code class="docutils literal notranslate"><span class="pre">scontrol</span> <span class="pre">show</span> <span class="pre">node</span> <span class="pre">节点名</span></code> 之类的命令查看具体原因（Reason=对应的）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NodeName</span><span class="o">=</span><span class="n">node1</span> <span class="n">Arch</span><span class="o">=</span><span class="n">x86_64</span> <span class="n">CoresPerSocket</span><span class="o">=</span><span class="mi">24</span>
   <span class="n">CPUAlloc</span><span class="o">=</span><span class="mi">0</span> <span class="n">CPUTot</span><span class="o">=</span><span class="mi">48</span> <span class="n">CPULoad</span><span class="o">=</span><span class="mf">0.01</span>
   <span class="n">AvailableFeatures</span><span class="o">=</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
   <span class="n">ActiveFeatures</span><span class="o">=</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
   <span class="n">Gres</span><span class="o">=</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
   <span class="n">NodeAddr</span><span class="o">=</span><span class="mf">192.168.1.1</span> <span class="n">NodeHostName</span><span class="o">=</span><span class="n">node1</span> <span class="n">Version</span><span class="o">=</span><span class="mf">21.08.3</span>
   <span class="n">OS</span><span class="o">=</span><span class="n">Linux</span> <span class="mf">3.10.0</span><span class="o">-</span><span class="mf">1160.45.1</span><span class="o">.</span><span class="n">el7</span><span class="o">.</span><span class="n">x86_64</span> <span class="c1">#1 SMP Wed Oct 13 17:20:51 UTC 2021</span>
   <span class="n">RealMemory</span><span class="o">=</span><span class="mi">192000</span> <span class="n">AllocMem</span><span class="o">=</span><span class="mi">0</span> <span class="n">FreeMem</span><span class="o">=</span><span class="mi">189885</span> <span class="n">Sockets</span><span class="o">=</span><span class="mi">2</span> <span class="n">Boards</span><span class="o">=</span><span class="mi">1</span>
   <span class="n">State</span><span class="o">=</span><span class="n">DOWN</span><span class="o">+</span><span class="n">DRAIN</span> <span class="n">ThreadsPerCore</span><span class="o">=</span><span class="mi">1</span> <span class="n">TmpDisk</span><span class="o">=</span><span class="mi">0</span> <span class="n">Weight</span><span class="o">=</span><span class="mi">1</span> <span class="n">Owner</span><span class="o">=</span><span class="n">N</span><span class="o">/</span><span class="n">A</span> <span class="n">MCS_label</span><span class="o">=</span><span class="n">N</span><span class="o">/</span><span class="n">A</span>
   <span class="n">Partitions</span><span class="o">=</span><span class="n">batch</span>
   <span class="n">BootTime</span><span class="o">=</span><span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">10</span><span class="n">T09</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">45</span> <span class="n">SlurmdStartTime</span><span class="o">=</span><span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">10</span><span class="n">T15</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">12</span>
   <span class="n">LastBusyTime</span><span class="o">=</span><span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">10</span><span class="n">T15</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">15</span>
   <span class="n">CfgTRES</span><span class="o">=</span><span class="n">cpu</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span><span class="n">mem</span><span class="o">=</span><span class="mf">187.50</span><span class="n">G</span><span class="p">,</span><span class="n">billing</span><span class="o">=</span><span class="mi">48</span>
   <span class="n">AllocTRES</span><span class="o">=</span>
   <span class="n">CapWatts</span><span class="o">=</span><span class="n">n</span><span class="o">/</span><span class="n">a</span>
   <span class="n">CurrentWatts</span><span class="o">=</span><span class="mi">0</span> <span class="n">AveWatts</span><span class="o">=</span><span class="mi">0</span>
   <span class="n">ExtSensorsJoules</span><span class="o">=</span><span class="n">n</span><span class="o">/</span><span class="n">s</span> <span class="n">ExtSensorsWatts</span><span class="o">=</span><span class="mi">0</span> <span class="n">ExtSensorsTemp</span><span class="o">=</span><span class="n">n</span><span class="o">/</span><span class="n">s</span>
   <span class="n">Reason</span><span class="o">=</span><span class="n">Not</span> <span class="n">responding</span> <span class="p">[</span><span class="n">slurm</span><span class="o">@</span><span class="mi">2021</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span><span class="n">T12</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">19</span><span class="p">]</span>
</pre></div>
</div>
<p>必要时需要到对应计算节点执行 <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">restart</span> <span class="pre">slurmd</span></code> 命令。</p>
<p>如果计算节点slurmd服务正常，但执行 <code class="docutils literal notranslate"><span class="pre">sinfo</span></code> 命令显示：drain，也许要在管理节点执行 <code class="docutils literal notranslate"><span class="pre">scontrol</span> <span class="pre">update</span> <span class="pre">NodeName=节点名</span> <span class="pre">State=resume</span></code> 命令。</p>
<ul class="simple">
<li><p>设置某个节点状态为DRAIN，执行：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scontrol</span> <span class="n">update</span> <span class="n">NodeName</span><span class="o">=</span><span class="n">节点名</span> <span class="n">State</span><span class="o">=</span><span class="n">Drain</span> <span class="n">Reason</span><span class="o">=</span><span class="s1">'Memomry Lost'</span>
</pre></div>
</div>
<ul class="simple">
<li><p>设置队列状态，执行：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scontrol</span> <span class="n">update</span> <span class="n">Partition</span><span class="o">=</span><span class="n">队列名</span> <span class="n">State</span><span class="o">=</span><span class="p">[</span><span class="n">UP</span><span class="o">|</span><span class="n">DOWN</span><span class="o">|</span><span class="n">DRAIN</span><span class="o">|</span><span class="n">INACTIVE</span><span class="p">]</span>
</pre></div>
</div>
<dl class="simple">
<dt>状态：</dt><dd><ul class="simple">
<li><p>UP：设置该队列允许新作业可以在该队列排队，且将会被分配到该队列对应的节点上运行</p></li>
<li><p>DOWN：设置该队列允许新作业可以在该队列排队，但排队中的作业不会分配到该队列对应的节点上运行。已经在该队列上运行的作业将继续运行。</p></li>
<li><p>DRAIN：设置该队列不允许新作业在该队列排队（提交时显示被拒绝信息）。已在排队的作业将被分配到该队列对应节点上运行。</p></li>
<li><p>INACTIVE：设置该队列运行新的作业在该队列排队，已经在排队的老作业将不会被分配到对应节点运行。</p></li>
</ul>
</dd>
</dl>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="index.html" title="Slurm资源管理与作业调度系统安装配置"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> Slurm资源管理与作业调度系统安装配置 </span>
              </div>
            </a>
          
          
            <a href="contact.html" title="7. 联系方式"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> <span class="section-number">7. </span>联系方式 </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2021, 李会民，中国科学技术大学超级计算中心(http://scc.ustc.edu.cn&gt;).
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 6.1.3.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>